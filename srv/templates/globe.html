<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5MP.globe - Global Conservation Effort</title>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #e0e0e0; overflow: hidden; }
        
        .header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: rgba(18,18,18,0.95); border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; backdrop-filter: blur(10px); }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600; color: #fff; }
        .logo-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 28px; height: 28px; }
        .logo-subtitle { font-size: 11px; font-weight: 400; color: #888; margin-top: 2px; }
        .auth-buttons { display: flex; gap: 12px; align-items: center; }
        .user-info { color: #22c55e; font-size: 14px; }

        .btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.12); }
        .btn-secondary:hover { background: rgba(255,255,255,0.12); }
        .btn-primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
        .btn-primary:hover { background: linear-gradient(135deg, #16a34a, #15803d); }

        #map { position: absolute; top: 56px; left: 0; right: 0; bottom: 0; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 100%; max-width: 420px; padding: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 600; color: #fff; }
        .modal-close { background: none; border: none; color: #666; font-size: 24px; cursor: pointer; padding: 4px; line-height: 1; }
        .modal-close:hover { color: #fff; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #a0a0a0; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: #fff; font-size: 14px; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #22c55e; }
        .form-input::placeholder { color: #555; }
        .form-error { color: #ef4444; font-size: 13px; margin-top: 8px; display: none; }
        .form-footer { margin-top: 24px; }
        .form-footer .btn { width: 100%; padding: 12px; }
        .form-switch { text-align: center; margin-top: 16px; font-size: 14px; color: #666; }
        .form-switch a { color: #22c55e; text-decoration: none; }
        .form-switch a:hover { text-decoration: underline; }

        .upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
        .upload-area:hover, .upload-area.dragover { border-color: #22c55e; background: rgba(34,197,94,0.05); }
        .upload-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-text { color: #a0a0a0; font-size: 14px; }
        .upload-text strong { color: #22c55e; }

        .fab { position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; color: #fff; font-size: 24px; cursor: pointer; box-shadow: 0 4px 14px rgba(34,197,94,0.4); transition: all 0.2s; z-index: 500; display: none; align-items: center; justify-content: center; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(34,197,94,0.5); }
        .fab.visible { display: flex; }

        .maplibregl-ctrl-attrib { background: rgba(18,18,18,0.8) !important; }

        /* Pulse animation for effort dots - applied via canvas filter */
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stats-panel { position: fixed; top: 66px; right: 10px; background: rgba(18,18,18,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 16px; z-index: 100; font-size: 12px; min-width: 140px; }
        .stats-panel h3 { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .stats-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .stats-item:last-child { margin-bottom: 0; }
        .stats-label { color: #888; }
        .stats-value { color: #22c55e; font-weight: 600; font-variant-numeric: tabular-nums; }
        .maplibregl-ctrl-attrib a { color: #666 !important; }

        /* Filter Panel Styles */
        .filter-toggle { position: fixed; top: 66px; left: 10px; width: 40px; height: 40px; background: rgba(18,18,18,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 150; transition: all 0.2s; }
        .filter-toggle:hover { background: rgba(30,30,30,0.95); border-color: rgba(255,255,255,0.2); }
        .filter-toggle svg { width: 20px; height: 20px; color: #a0a0a0; }
        .filter-toggle:hover svg { color: #22c55e; }
        .filter-toggle.active { background: rgba(34,197,94,0.15); border-color: #22c55e; }
        .filter-toggle.active svg { color: #22c55e; }

        .filter-panel { position: fixed; top: 66px; left: 10px; width: 240px; background: rgba(18,18,18,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 100; backdrop-filter: blur(10px); transform: translateX(-260px); opacity: 0; transition: all 0.3s ease; pointer-events: none; }
        .filter-panel.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
        .filter-panel-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .filter-panel-title { font-size: 14px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 8px; }
        .filter-panel-title svg { width: 16px; height: 16px; color: #22c55e; }
        .filter-panel-content { padding: 16px; }

        .filter-section { margin-bottom: 20px; }
        .filter-section:last-child { margin-bottom: 0; }
        .filter-section-label { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }

        .btn-download { flex: 1; padding: 10px 14px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 6px; color: #fff; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .btn-download:hover { background: linear-gradient(135deg, #16a34a, #15803d); transform: translateY(-1px); }
        .btn-download svg { width: 16px; height: 16px; }

        .download-row { display: flex; gap: 8px; }
        .btn-bbox { width: 42px; height: 42px; padding: 0; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #a0a0a0; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-bbox:hover { background: rgba(255,255,255,0.1); color: #22c55e; border-color: rgba(255,255,255,0.2); }
        .btn-bbox svg { width: 18px; height: 18px; }

        .date-input { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #e0e0e0; font-size: 13px; cursor: pointer; }
        .date-input:hover { border-color: rgba(255,255,255,0.2); }
        .date-input:focus { outline: none; border-color: #22c55e; }
        .date-input::-webkit-calendar-picker-indicator { filter: invert(1) opacity(0.5); cursor: pointer; }
        .date-row { display: flex; gap: 8px; align-items: center; }
        .date-row label { font-size: 11px; color: #666; min-width: 32px; }
        .date-row input { flex: 1; }

        .activity-section { margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 12px; }
        .activity-header { display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 4px 0; }
        .activity-header:hover .activity-title { color: #fff; }
        .activity-title { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; transition: color 0.2s; }
        .activity-toggle { width: 16px; height: 16px; color: #666; transition: transform 0.2s; }
        .activity-toggle.expanded { transform: rotate(180deg); }
        .activity-list { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .activity-list.expanded { max-height: 300px; }
        .activity-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 11px; color: #888; }
        .activity-item:last-child { border-bottom: none; }
        .activity-date { color: #666; }
        .activity-location { color: #a0a0a0; }
        .activity-distance { color: #22c55e; font-weight: 500; float: right; }
        .activity-more { padding: 8px 0; text-align: center; font-size: 11px; color: #22c55e; cursor: pointer; }
        .activity-more:hover { text-decoration: underline; }
        .activity-empty { padding: 12px 0; text-align: center; font-size: 11px; color: #555; }

        /* Search Box Styles */
        .search-container { display: flex; align-items: center; position: relative; }
        .search-toggle { width: 40px; height: 40px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .search-toggle:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .search-toggle svg { width: 18px; height: 18px; color: #a0a0a0; }
        .search-toggle:hover svg { color: #22c55e; }
        .search-toggle.active { background: rgba(34,197,94,0.15); border-color: #22c55e; }
        .search-toggle.active svg { color: #22c55e; }
        .search-input-wrapper { display: none; align-items: center; position: relative; margin-left: 8px; }
        .search-input-wrapper.open { display: flex; }
        .search-input { width: 280px; padding: 10px 36px 10px 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0; font-size: 14px; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: #22c55e; background: rgba(255,255,255,0.08); }
        .search-input::placeholder { color: #666; }
        .search-clear { position: absolute; right: 10px; background: none; border: none; color: #666; font-size: 18px; cursor: pointer; padding: 0; line-height: 1; }
        .search-clear:hover { color: #fff; }
        .search-results { position: absolute; top: 100%; left: 48px; width: 280px; max-height: 320px; overflow-y: auto; background: rgba(26,26,26,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-top: 4px; display: none; z-index: 1001; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .search-results.open { display: block; }
        .search-result-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.06); transition: background 0.15s; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(34,197,94,0.1); }
        .search-result-name { font-size: 14px; color: #fff; margin-bottom: 2px; }
        .search-result-country { font-size: 12px; color: #888; }
        .search-no-results { padding: 16px 14px; text-align: center; color: #666; font-size: 13px; }
        .search-loading { padding: 16px 14px; text-align: center; color: #888; font-size: 13px; }

        /* PA Stats Modal Styles */
        .pa-stats-modal { max-width: 380px; }
        .pa-stats-content { }
        .pa-stats-section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .pa-stats-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .pa-stats-section-title { font-size: 12px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .pa-stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .pa-stat-label { font-size: 14px; color: #888; }
        .pa-stat-value { font-size: 14px; color: #fff; font-weight: 500; }
        .pa-patrol-stats .pa-stat-value { color: #22c55e; }
        .pa-stats-link { margin-top: 20px; }
        .pa-stats-link a { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #a0a0a0; text-decoration: none; font-size: 13px; transition: all 0.2s; }
        .pa-stats-link a:hover { background: rgba(255,255,255,0.1); color: #22c55e; border-color: rgba(34,197,94,0.3); }
        .pa-stats-link svg { width: 16px; height: 16px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <ellipse cx="12" cy="12" rx="4" ry="10"/>
                    <path d="M2 12h20"/>
                    <path d="M4.5 6.5h15"/>
                    <path d="M4.5 17.5h15"/>
                </svg>
            </div>
            <div>
                <span>5MP.globe</span>
                <div class="logo-subtitle">Global Conservation Effort</div>
            </div>
        </div>
        
        <!-- Search Box -->
        <div class="search-container" id="search-container">
            <button class="search-toggle" id="search-toggle" onclick="toggleSearch()" title="Search Protected Areas">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
            </button>
            <div class="search-input-wrapper" id="search-input-wrapper">
                <input type="text" class="search-input" id="search-input" placeholder="Search protected areas..." autocomplete="off" onkeyup="handleSearchInput(event)" onfocus="showSearchResults()">
                <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">&times;</button>
            </div>
            <div class="search-results" id="search-results"></div>
        </div>
        
        <div class="auth-buttons">
            {{if .User}}
            <span class="user-info">{{.User.Email}}</span>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
            {{else}}
            <button class="btn btn-secondary" onclick="showModal('login')">Login</button>
            <button class="btn btn-primary" onclick="showModal('register')">Register</button>
            {{end}}
        </div>
    </header>

    <div id="map"></div>

    <div class="stats-panel">
        <h3>Global Stats</h3>
        <div class="stats-item">
            <span class="stats-label">Active Pixels</span>
            <span class="stats-value" id="stats-pixels">--</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">Total Distance</span>
            <span class="stats-value" id="stats-distance">-- km</span>
        </div>
        <div class="stats-item">
            <span class="stats-label">Total Patrols</span>
            <span class="stats-value" id="stats-patrols">--</span>
        </div>
    </div>

    <!-- Filter Toggle Button -->
    <button class="filter-toggle" id="filter-toggle" onclick="toggleFilterPanel()" title="Toggle Filters">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="4" y1="10" x2="4" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="3"></line>
            <line x1="20" y1="21" x2="20" y2="16"></line>
            <line x1="20" y1="12" x2="20" y2="3"></line>
            <line x1="1" y1="14" x2="7" y2="14"></line>
            <line x1="9" y1="8" x2="15" y2="8"></line>
            <line x1="17" y1="16" x2="23" y2="16"></line>
        </svg>
    </button>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filter-panel">
        <div class="filter-panel-header">
            <div class="filter-panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                Filters
            </div>
        </div>
        <div class="filter-panel-content">
            <!-- Date Range Section -->
            <div class="filter-section">
                <div class="filter-section-label">Date Range</div>
                <div class="date-row" style="margin-bottom: 8px;">
                    <label>From</label>
                    <input type="date" class="date-input" id="date-from" onchange="updateDateRange()">
                </div>
                <div class="date-row">
                    <label>To</label>
                    <input type="date" class="date-input" id="date-to" onchange="updateDateRange()">
                </div>
            </div>

            <!-- Download Section -->
            <div class="filter-section">
                <div class="download-row">
                    <button class="btn-download" onclick="downloadData()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download
                    </button>
                    <button class="btn-bbox" onclick="selectBoundingBox()" title="Select area to download">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3h6v6H3z"></path>
                            <path d="M15 3h6v6h-6z"></path>
                            <path d="M3 15h6v6H3z"></path>
                            <path d="M15 15h6v6h-6z"></path>
                            <line x1="9" y1="6" x2="15" y2="6"></line>
                            <line x1="9" y1="18" x2="15" y2="18"></line>
                            <line x1="6" y1="9" x2="6" y2="15"></line>
                            <line x1="18" y1="9" x2="18" y2="15"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Activity Log Section -->
            <div class="activity-section">
                <div class="activity-header" onclick="toggleActivityLog()">
                    <span class="activity-title">Recent Activity</span>
                    <svg class="activity-toggle" id="activity-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
                <div class="activity-list" id="activity-list">
                    <!-- Activity items will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <button class="fab {{if .User}}visible{{end}}" onclick="showModal('upload')" title="Upload Data">+</button>

    <!-- Login Modal -->
    <div id="modal-login" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Welcome Back</h2>
                <button class="modal-close" onclick="closeModal('login')">&times;</button>
            </div>
            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="form-error" id="login-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Sign In</button>
                </div>
                <p class="form-switch">Don't have an account? <a href="#" onclick="switchModal('login', 'register')">Register</a></p>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="modal-register" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create Account</h2>
                <button class="modal-close" onclick="closeModal('register')">&times;</button>
            </div>
            <form id="form-register" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="8" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" name="confirm" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <div class="form-error" id="register-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </div>
                <p class="form-switch">Already have an account? <a href="#" onclick="switchModal('register', 'login')">Sign in</a></p>
            </form>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="modal-upload" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Upload Conservation Data</h2>
                <button class="modal-close" onclick="closeModal('upload')">&times;</button>
            </div>
            <form id="form-upload" onsubmit="handleUpload(event)">
                <div class="upload-area" onclick="document.getElementById('file-input').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="upload-icon">üìç</div>
                    <p class="upload-text">Drag & drop GPX files here, or <strong>browse</strong></p>
                    <p class="upload-text" style="margin-top: 8px; font-size: 12px;">GPS patrol track files (.gpx)</p>
                </div>
                <input type="file" id="file-input" name="files" accept=".gpx" multiple style="display: none;" onchange="updateFileName(this)">
                <div id="selected-file" style="margin-bottom: 16px; color: #22c55e; font-size: 14px;"></div>
                <div class="form-error" id="upload-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PA Stats Modal -->
    <div id="modal-pa-stats" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal pa-stats-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="pa-stats-name">Protected Area</h2>
                <button class="modal-close" onclick="closeModal('pa-stats')">&times;</button>
            </div>
            <div class="pa-stats-content">
                <div class="pa-stats-section">
                    <div class="pa-stat-row">
                        <span class="pa-stat-label">Country</span>
                        <span class="pa-stat-value" id="pa-stats-country">--</span>
                    </div>
                    <div class="pa-stat-row">
                        <span class="pa-stat-label">Area</span>
                        <span class="pa-stat-value" id="pa-stats-area">-- km¬≤</span>
                    </div>
                    <div class="pa-stat-row" id="pa-stats-wdpa-row">
                        <span class="pa-stat-label">WDPA ID</span>
                        <span class="pa-stat-value" id="pa-stats-wdpa">--</span>
                    </div>
                </div>
                <div class="pa-stats-section pa-patrol-stats">
                    <h3 class="pa-stats-section-title">Patrol Stats</h3>
                    <div class="pa-stat-row">
                        <span class="pa-stat-label">Total Distance</span>
                        <span class="pa-stat-value" id="pa-stats-distance">-- km</span>
                    </div>
                    <div class="pa-stat-row">
                        <span class="pa-stat-label">Total Patrols</span>
                        <span class="pa-stat-value" id="pa-stats-patrols">--</span>
                    </div>
                </div>
                <div class="pa-stats-link" id="pa-stats-link-container" style="display: none;">
                    <a href="#" id="pa-stats-pp-link" target="_blank" rel="noopener noreferrer">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        View on Protected Planet
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MAPTILER_KEY = 'dea58ea0389007e386776c4f583f4425';
        const API_HOST = '{{.Hostname}}';

        // Use a dark basemap style
        const darkStyle = {
            version: 8,
            name: 'Dark',
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'],
                    tileSize: 256,
                    attribution: '¬© OpenStreetMap contributors, ¬© CARTO'
                }
            },
            layers: [{
                id: 'osm',
                type: 'raster',
                source: 'osm'
            }]
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: darkStyle,
            center: [20, 0],
            zoom: 3
        });
        map.addControl(new maplibregl.NavigationControl(), 'top-right');

        // Add map layers on load
        map.on('load', function() {
            // Add protected areas source
            map.addSource('areas', {
                type: 'geojson',
                data: '/api/areas'
            });

            // Add grid source
            map.addSource('grid', {
                type: 'geojson',
                data: '/api/grid'
            });

            // Protected areas fill layer
            map.addLayer({
                id: 'areas-fill',
                type: 'fill',
                source: 'areas',
                paint: {
                    'fill-color': '#22c55e',
                    'fill-opacity': 0.2
                }
            });

            // Protected areas outline layer
            map.addLayer({
                id: 'areas-outline',
                type: 'line',
                source: 'areas',
                paint: {
                    'line-color': '#22c55e',
                    'line-width': 1
                }
            });

            // Grid cells layer - heatmap style with continuous gradient
            map.addLayer({
                id: 'grid-cells',
                type: 'heatmap',
                source: 'grid',
                paint: {
                    // Weight based on intensity
                    'heatmap-weight': [
                        'interpolate',
                        ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0,
                        1, 1
                    ],
                    // Intensity increases with zoom
                    'heatmap-intensity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 0.5,
                        9, 2
                    ],
                    // Green color gradient
                    'heatmap-color': [
                        'interpolate',
                        ['linear'],
                        ['heatmap-density'],
                        0, 'rgba(34, 197, 94, 0)',
                        0.2, 'rgba(34, 197, 94, 0.3)',
                        0.4, 'rgba(34, 197, 94, 0.5)',
                        0.6, 'rgba(74, 222, 128, 0.7)',
                        0.8, 'rgba(134, 239, 172, 0.85)',
                        1, 'rgba(187, 247, 208, 1)'
                    ],
                    // Radius increases with zoom
                    'heatmap-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 15,
                        9, 30
                    ],
                    // Opacity decreases at high zoom
                    'heatmap-opacity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        7, 1,
                        9, 0.8
                    ]
                }
            });

            // Popup for protected areas
            map.on('click', 'areas-fill', function(e) {
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    const name = props.name || 'Protected Area';
                    const description = props.description || '';
                    const area = props.area_km2 ? `<br>Area: ${props.area_km2} km¬≤` : '';
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`<strong>${name}</strong>${description ? '<br>' + description : ''}${area}`)
                        .addTo(map);
                }
            });

            // Popup for grid cells (click only)
            map.on('click', 'grid-cells', function(e) {
                e.originalEvent.stopPropagation();
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    const pixelId = props.id || 'Unknown';
                    const distance = props.total_distance_km ? props.total_distance_km.toFixed(1) : '0';
                    const visits = props.unique_uploads || 0;
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <strong>Effort Pixel</strong><br>
                            <span style="color: #888; font-size: 11px;">ID: ${pixelId}</span><br>
                            Total Distance: <strong>${distance} km</strong><br>
                            Total Visits: <strong>${visits}</strong><br>
                            <span style="color: #666; font-size: 10px;">100 km¬≤ (~10km √ó 10km)</span>
                        `)
                        .addTo(map);
                }
            });

            // Change cursor on hover
            map.on('mouseenter', 'areas-fill', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'areas-fill', function() { map.getCanvas().style.cursor = ''; });
            map.on('mouseenter', 'grid-cells', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'grid-cells', function() { map.getCanvas().style.cursor = ''; });

            // Create legend
            const legend = document.createElement('div');
            legend.id = 'map-legend';
            legend.style.cssText = 'position: absolute; bottom: 30px; left: 10px; background: rgba(18,18,18,0.9); padding: 12px 16px; border-radius: 8px; font-size: 12px; z-index: 100; border: 1px solid rgba(255,255,255,0.1);';
            legend.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 10px; color: #fff;">Patrol Intensity</div>
                <div style="display: flex; align-items: center; margin-bottom: 6px;">
                    <div style="width: 100px; height: 12px; background: linear-gradient(to right, rgba(34,197,94,0), rgba(34,197,94,0.3), rgba(74,222,128,0.6), rgba(134,239,172,0.85), rgba(187,247,208,1)); border-radius: 3px; margin-right: 8px;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #666; width: 100px;">
                    <span>Low</span><span>High</span>
                </div>
                <div style="margin-top: 8px; font-size: 10px; color: #555;">100 km¬≤ per pixel</div>
            `;
            document.getElementById('map').appendChild(legend);
        });

        function showModal(name) { document.getElementById(`modal-${name}`).classList.add('active'); }
        function closeModal(name) {
            document.getElementById(`modal-${name}`).classList.remove('active');
            const form = document.getElementById(`form-${name}`);
            if (form) form.reset();
            const error = document.getElementById(`${name}-error`);
            if (error) error.style.display = 'none';
        }
        function closeModalOnOverlay(e) { if (e.target.classList.contains('modal-overlay')) e.target.classList.remove('active'); }
        function switchModal(from, to) { closeModal(from); showModal(to); }
        function showError(name, msg) { const el = document.getElementById(`${name}-error`); el.textContent = msg; el.style.display = 'block'; }

        async function handleLogin(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: data.get('email'), password: data.get('password') })
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Login failed');
                window.location.reload();
            } catch (err) { showError('login', err.message); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            if (data.get('password') !== data.get('confirm')) { showError('register', 'Passwords do not match'); return; }
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: data.get('email'), password: data.get('password') })
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Registration failed');
                window.location.reload();
            } catch (err) { showError('register', err.message); }
        }

        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                document.getElementById('file-input').files = e.dataTransfer.files;
                updateFileName(document.getElementById('file-input'));
            }
        }
        function updateFileName(input) {
            if (input.files.length === 0) {
                document.getElementById('selected-file').textContent = '';
            } else if (input.files.length === 1) {
                document.getElementById('selected-file').textContent = `Selected: ${input.files[0].name}`;
            } else {
                document.getElementById('selected-file').textContent = `Selected: ${input.files.length} files`;
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file-input');
            if (!fileInput.files.length) { showError('upload', 'Please select at least one GPX file'); return; }
            
            const formData = new FormData();
            for (let file of fileInput.files) {
                formData.append('files', file);
            }
            
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Upload failed');
                }
                closeModal('upload');
                // Refresh the grid data and stats (using current filter settings)
                reloadGridData();
                loadStats();
                alert('Upload successful! ' + fileInput.files.length + ' file(s) processed.');
            } catch (err) { showError('upload', err.message); }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        });

        // Load global stats
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                if (res.ok) {
                    const stats = await res.json();
                    document.getElementById('stats-pixels').textContent = (stats.active_pixels || 0).toLocaleString();
                    document.getElementById('stats-distance').textContent = (stats.total_distance_km || 0).toLocaleString(undefined, {maximumFractionDigits: 1}) + ' km';
                    document.getElementById('stats-patrols').textContent = (stats.total_patrols || 0).toLocaleString();
                }
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        loadStats();

        // Filter Panel State
        let filterPanelOpen = false;
        let dateFrom = null;
        let dateTo = null;
        let activityExpanded = false;

        // Initialize date range to past month
        function initDateRange() {
            const today = new Date();
            const monthAgo = new Date();
            monthAgo.setDate(monthAgo.getDate() - 30);
            
            const formatDate = (d) => d.toISOString().split('T')[0];
            
            dateFrom = formatDate(monthAgo);
            dateTo = formatDate(today);
            
            document.getElementById('date-from').value = dateFrom;
            document.getElementById('date-to').value = dateTo;
        }

        function toggleFilterPanel() {
            filterPanelOpen = !filterPanelOpen;
            const panel = document.getElementById('filter-panel');
            const toggle = document.getElementById('filter-toggle');
            if (filterPanelOpen) {
                panel.classList.add('open');
                toggle.classList.add('active');
            } else {
                panel.classList.remove('open');
                toggle.classList.remove('active');
            }
        }

        function updateDateRange() {
            dateFrom = document.getElementById('date-from').value;
            dateTo = document.getElementById('date-to').value;
            reloadGridData();
        }

        function reloadGridData() {
            let url = `/api/grid?t=${Date.now()}`;
            if (dateFrom) url += `&from=${dateFrom}`;
            if (dateTo) url += `&to=${dateTo}`;
            
            const gridSource = map.getSource('grid');
            if (gridSource) {
                gridSource.setData(url);
            }
            console.log(`Reloading grid data: from=${dateFrom}, to=${dateTo}`);
        }

        function downloadData() {
            const fromStr = dateFrom || 'beginning';
            const toStr = dateTo || 'now';
            alert(`Download data from ${fromStr} to ${toStr}\n\nThis feature will export the filtered conservation data.`);
        }

        function selectBoundingBox() {
            alert('Bounding box selection mode\n\nClick and drag on the map to select an area for download.\n\n(This feature is coming soon)');
        }

        function toggleActivityLog() {
            activityExpanded = !activityExpanded;
            const list = document.getElementById('activity-list');
            const icon = document.getElementById('activity-toggle-icon');
            
            if (activityExpanded) {
                list.classList.add('expanded');
                icon.classList.add('expanded');
                loadActivityLog();
            } else {
                list.classList.remove('expanded');
                icon.classList.remove('expanded');
            }
        }

        async function loadActivityLog() {
            const list = document.getElementById('activity-list');
            
            try {
                const res = await fetch('/api/activity');
                if (res.ok) {
                    const data = await res.json();
                    if (data.activities && data.activities.length > 0) {
                        list.innerHTML = data.activities.slice(0, 10).map(a => {
                            const date = new Date(a.date);
                            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                            const location = a.location || 'Unknown';
                            const distance = a.distance_km ? a.distance_km.toFixed(1) + ' km' : '';
                            return `<div class="activity-item">
                                <span class="activity-date">${dateStr}</span> ¬∑ 
                                <span class="activity-location">${location}</span>
                                ${distance ? `<span class="activity-distance">${distance}</span>` : ''}
                            </div>`;
                        }).join('');
                    } else {
                        list.innerHTML = '<div class="activity-empty">No recent activity</div>';
                    }
                } else {
                    throw new Error('Failed to load');
                }
            } catch (err) {
                // Show placeholder data if API not available
                list.innerHTML = '<div class="activity-empty">No recent activity</div>';
            }
        }

        // Initialize date range on page load
        initDateRange();

        // ========== Search Functionality ==========
        let searchOpen = false;
        let searchTimeout = null;
        let cachedAreas = null;

        function toggleSearch() {
            searchOpen = !searchOpen;
            const toggle = document.getElementById('search-toggle');
            const wrapper = document.getElementById('search-input-wrapper');
            const input = document.getElementById('search-input');
            const results = document.getElementById('search-results');
            
            if (searchOpen) {
                toggle.classList.add('active');
                wrapper.classList.add('open');
                setTimeout(() => input.focus(), 100);
            } else {
                toggle.classList.remove('active');
                wrapper.classList.remove('open');
                results.classList.remove('open');
                input.value = '';
                document.getElementById('search-clear').style.display = 'none';
            }
        }

        function handleSearchInput(e) {
            const query = e.target.value.trim();
            const clearBtn = document.getElementById('search-clear');
            
            clearBtn.style.display = query.length > 0 ? 'block' : 'none';
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => searchAreas(query), 200);
        }

        async function searchAreas(query) {
            const results = document.getElementById('search-results');
            results.innerHTML = '<div class="search-loading">Searching...</div>';
            results.classList.add('open');
            
            try {
                const res = await fetch(`/api/areas/search?q=${encodeURIComponent(query)}`);
                if (!res.ok) throw new Error('Search failed');
                
                const areas = await res.json();
                displaySearchResults(areas);
            } catch (err) {
                console.error('Search error:', err);
                results.innerHTML = '<div class="search-no-results">Search failed</div>';
            }
        }

        function displaySearchResults(areas) {
            const results = document.getElementById('search-results');
            
            if (areas.length === 0) {
                results.innerHTML = '<div class="search-no-results">No protected areas found</div>';
                return;
            }
            
            results.innerHTML = areas.map(area => `
                <div class="search-result-item" onclick="selectSearchResult(${JSON.stringify(area).replace(/"/g, '&quot;')})">
                    <div class="search-result-name">${escapeHtml(area.name)}</div>
                    <div class="search-result-country">${escapeHtml(area.country || 'Unknown')}</div>
                </div>
            `).join('');
        }

        function selectSearchResult(area) {
            // Hide search
            hideSearchResults();
            document.getElementById('search-input').value = area.name;
            
            // Fly to the area
            if (area.bbox && area.bbox.length === 4) {
                map.fitBounds([
                    [area.bbox[0], area.bbox[1]], // SW
                    [area.bbox[2], area.bbox[3]]  // NE
                ], { padding: 50, duration: 1500 });
            } else if (area.center && area.center.length === 2) {
                map.flyTo({
                    center: area.center,
                    zoom: 10,
                    duration: 1500
                });
            }
            
            // Show stats modal after flying
            setTimeout(() => showPAStatsModal(area), 800);
        }

        function showSearchResults() {
            const query = document.getElementById('search-input').value.trim();
            if (query.length >= 2) {
                document.getElementById('search-results').classList.add('open');
            }
        }

        function hideSearchResults() {
            document.getElementById('search-results').classList.remove('open');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').style.display = 'none';
            hideSearchResults();
            document.getElementById('search-input').focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close search results when clicking outside
        document.addEventListener('click', (e) => {
            const container = document.getElementById('search-container');
            if (!container.contains(e.target)) {
                hideSearchResults();
            }
        });

        // ========== PA Stats Modal ==========
        function showPAStatsModal(props) {
            // Set modal content
            document.getElementById('pa-stats-name').textContent = props.name || 'Protected Area';
            document.getElementById('pa-stats-country').textContent = props.country || '--';
            
            const areaKm2 = props.area_km2 || props.area;
            if (areaKm2) {
                document.getElementById('pa-stats-area').textContent = Number(areaKm2).toLocaleString() + ' km¬≤';
            } else {
                document.getElementById('pa-stats-area').textContent = '--';
            }
            
            const wdpaId = props.wdpa_id || props.wdpaid;
            const wdpaRow = document.getElementById('pa-stats-wdpa-row');
            if (wdpaId) {
                document.getElementById('pa-stats-wdpa').textContent = wdpaId;
                wdpaRow.style.display = 'flex';
                
                // Show Protected Planet link
                const linkContainer = document.getElementById('pa-stats-link-container');
                const ppLink = document.getElementById('pa-stats-pp-link');
                ppLink.href = `https://www.protectedplanet.net/${wdpaId}`;
                linkContainer.style.display = 'block';
            } else {
                wdpaRow.style.display = 'none';
                document.getElementById('pa-stats-link-container').style.display = 'none';
            }
            
            // Patrol stats (placeholder - would need API endpoint for per-PA stats)
            document.getElementById('pa-stats-distance').textContent = '-- km';
            document.getElementById('pa-stats-patrols').textContent = '--';
            
            // Show modal
            showModal('pa-stats');
        }

        // Update PA click handler to show modal instead of popup
        map.on('load', function() {
            // Remove the default popup click handler and add modal handler
            map.off('click', 'areas-fill');
            
            map.on('click', 'areas-fill', function(e) {
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    showPAStatsModal(props);
                }
            });
        });
    </script>
</body>
</html>

<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5MP.globe - Global Conservation Effort</title>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #e0e0e0; overflow: hidden; }
        
        .header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: rgba(18,18,18,0.95); border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; backdrop-filter: blur(10px); }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600; color: #fff; }
        .logo-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 28px; height: 28px; }
        .logo-subtitle { font-size: 11px; font-weight: 400; color: #888; margin-top: 2px; }
        .auth-buttons { display: flex; gap: 12px; align-items: center; }
        .user-info { color: #22c55e; font-size: 14px; }

        .btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.12); }
        .btn-secondary:hover { background: rgba(255,255,255,0.12); }
        .btn-primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
        .btn-primary:hover { background: linear-gradient(135deg, #16a34a, #15803d); }

        #map { position: absolute; top: 56px; left: 0; right: 0; bottom: 0; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 100%; max-width: 420px; padding: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 600; color: #fff; }
        .modal-close { background: none; border: none; color: #666; font-size: 24px; cursor: pointer; padding: 4px; line-height: 1; }
        .modal-close:hover { color: #fff; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #a0a0a0; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: #fff; font-size: 14px; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #22c55e; }
        .form-input::placeholder { color: #555; }
        .form-error { color: #ef4444; font-size: 13px; margin-top: 8px; display: none; }
        .form-footer { margin-top: 24px; }
        .form-footer .btn { width: 100%; padding: 12px; }
        .form-switch { text-align: center; margin-top: 16px; font-size: 14px; color: #666; }
        .form-switch a { color: #22c55e; text-decoration: none; }
        .form-switch a:hover { text-decoration: underline; }

        .upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
        .upload-area:hover, .upload-area.dragover { border-color: #22c55e; background: rgba(34,197,94,0.05); }
        .upload-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-text { color: #a0a0a0; font-size: 14px; }
        .upload-text strong { color: #22c55e; }

        .fab { position: fixed; bottom: 94px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; color: #fff; font-size: 24px; cursor: pointer; box-shadow: 0 4px 14px rgba(34,197,94,0.4); transition: all 0.2s; z-index: 500; display: none; align-items: center; justify-content: center; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(34,197,94,0.5); }
        .fab.visible { display: flex; }

        .maplibregl-ctrl-attrib { background: rgba(18,18,18,0.8) !important; }

         
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stats-panel { position: fixed; top: 66px; right: 10px; background: rgba(18,18,18,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 16px; z-index: 100; font-size: 12px; min-width: 140px; }
        .stats-panel h3 { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .stats-period { font-weight: 400; color: #555; font-size: 10px; }
        .stats-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding: 6px 8px; margin: 0 -8px 6px -8px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .stats-item:last-child { margin-bottom: 0; }
        .stats-item:hover { background: rgba(34,197,94,0.1); }
        .stats-item:hover .stats-label { color: #a0a0a0; }
        .stats-item:hover .stats-value { color: #4ade80; }
        .stats-item:active { transform: scale(0.98); }
        .stats-item.active { background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.3); }
        .stats-item.active .stats-label { color: #22c55e; }
        .stats-item::after { content: ''; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); width: 4px; height: 4px; border-radius: 50%; background: transparent; transition: all 0.2s; }
        .stats-item:hover::after { background: rgba(34,197,94,0.5); }
        .stats-item.active::after { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.6); }
        .stats-label { color: #888; transition: color 0.2s; }
        .stats-value { color: #22c55e; font-weight: 600; font-variant-numeric: tabular-nums; transition: color 0.2s; }
        @keyframes stats-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .stats-item.pulsing { animation: stats-pulse 0.6s ease-in-out; }
        .maplibregl-ctrl-attrib a { color: #666 !important; }
        .page-views { margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 10px; color: #555; text-align: center; }

        /* Movement type toggles (in filter panel) */
        .movement-toggles { display: flex; gap: 6px; }
        .movement-toggle { flex: 1; padding: 8px 4px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #888; font-size: 14px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .movement-toggle:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .movement-toggle.active { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); color: #22c55e; }
        .movement-toggle-label { font-size: 9px; display: block; margin-top: 2px; color: inherit; opacity: 0.8; }
        /* Toggle switch */
        .toggle-switch-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; margin-bottom: 10px; }
        .toggle-switch-label { font-size: 13px; color: #ccc; display: flex; align-items: center; gap: 8px; }
        .toggle-switch-label svg { width: 14px; height: 14px; color: #22c55e; }
        .toggle-switch { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.15); border-radius: 20px; transition: 0.3s; }
        .toggle-switch-slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-switch-slider { background: rgba(34,197,94,0.4); }
        .toggle-switch input:checked + .toggle-switch-slider:before { transform: translateX(16px); background: #22c55e; }

        /* Notification Button and Dropdown */
        .notification-btn { position: relative; }
        .notification-badge { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: badge-pulse 2s ease-out infinite; }
        .notification-badge.hidden { display: none; }
        @keyframes badge-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 4px rgba(34,197,94,0); } }
        .notification-dropdown { position: absolute; top: 100%; left: 0; margin-top: 8px; width: 300px; background: rgba(18,18,18,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 200; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: none; overflow: hidden; }
        .notification-dropdown.open { display: block; }
        .notification-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .notification-title { font-size: 12px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 6px; }
        .notification-title svg { width: 14px; height: 14px; color: #22c55e; }
        .notification-close { background: none; border: none; color: #666; cursor: pointer; font-size: 18px; padding: 2px 6px; line-height: 1; }
        .notification-close:hover { color: #fff; }
        .notification-list { max-height: 280px; overflow-y: auto; }
        .notification-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; }
        .notification-item:hover { background: rgba(255,255,255,0.05); }
        .notification-item:last-child { border-bottom: none; }
        .notification-icon { width: 28px; height: 28px; background: rgba(34,197,94,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-location { font-size: 13px; color: #fff; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-details { font-size: 11px; color: #888; margin-top: 2px; }
        .notification-empty { padding: 24px; text-align: center; color: #666; font-size: 13px; }

        /* Activity highlight marker on map */
        .activity-marker { width: 24px; height: 24px; background: rgba(34,197,94,0.3); border: 2px solid #22c55e; border-radius: 50%; position: relative; }
        .activity-marker::after { content: ''; position: absolute; inset: -8px; border: 2px solid rgba(34,197,94,0.5); border-radius: 50%; animation: marker-pulse 1.5s ease-out infinite; }
        @keyframes marker-pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(20px); } }

        @media (max-width: 768px) {
            .notification-dropdown { left: auto; right: -10px; width: calc(100vw - 40px); max-width: 300px; }
        }

        /* Time Slider - Google Timelapse Style */
        .time-slider-container { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: linear-gradient(to top, rgba(10,10,10,0.95) 0%, rgba(10,10,10,0.9) 70%, transparent 100%); z-index: 400; padding: 8px 20px 12px; display: flex; flex-direction: column; }
        .time-slider-header { margin-bottom: 6px; }
        .time-slider-date { font-size: 14px; font-weight: 600; color: #22c55e; }
        .time-slider-track-wrapper { position: relative; flex: 1; padding: 0 8px; }
        .time-slider-track { position: relative; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; cursor: pointer; }
        .time-slider-range { position: absolute; height: 100%; background: linear-gradient(90deg, rgba(34,197,94,0.6), #22c55e); border-radius: 3px; pointer-events: none; }
        .time-slider-handle { position: absolute; top: 50%; width: 16px; height: 16px; background: #22c55e; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); cursor: grab; z-index: 2; transition: transform 0.1s, box-shadow 0.1s; }
        .time-slider-handle:hover { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 10px rgba(34,197,94,0.5); }
        .time-slider-handle:active { cursor: grabbing; }
        .time-slider-handle.start { }
        .time-slider-handle.end { }
        .time-slider-ticks { position: relative; height: 20px; margin-top: 4px; }
        .time-slider-tick { position: absolute; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; }
        .time-slider-tick-line { width: 1px; height: 6px; background: rgba(255,255,255,0.2); }
        .time-slider-tick-label { font-size: 9px; color: #555; margin-top: 2px; white-space: nowrap; }
        .time-slider-tick.major .time-slider-tick-line { height: 8px; background: rgba(255,255,255,0.4); }
        .time-slider-tick.major .time-slider-tick-label { font-size: 10px; color: #888; }

        /* Adjust map and legend for slider */
        #map { bottom: 70px !important; }
        #map-legend { bottom: 10px !important; }
 

        @media (max-width: 768px) {
            .time-slider-container { height: 60px; padding: 6px 12px 10px; }
            .time-slider-date { font-size: 12px; }
            #map { bottom: 60px !important; }
        }

         
         
        .map-toolbar { position: fixed; top: 66px; left: 10px; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; gap: 8px; z-index: 150; }
        .toolbar-btn { width: 44px; height: 44px; min-width: 44px; min-height: 44px; background: rgba(18,18,18,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: center; -webkit-justify-content: center; justify-content: center; -webkit-transition: all 0.2s; transition: all 0.2s; padding: 0; }
        .toolbar-btn:hover { background: rgba(30,30,30,0.95); border-color: rgba(255,255,255,0.2); }
        .toolbar-btn svg { width: 20px; height: 20px; color: #a0a0a0; }
        .toolbar-btn:hover svg { color: #22c55e; }
        .toolbar-btn.active { background: rgba(34,197,94,0.15); border-color: #22c55e; }
        .toolbar-btn.active svg { color: #22c55e; }
        .toolbar-btn:focus { outline: none; border-color: #22c55e; }
        .toolbar-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
        .toolbar-separator { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

         
        .filter-panel { position: fixed; top: 66px; left: 62px; width: 260px; max-width: calc(100vw - 80px); background: rgba(18,18,18,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 140; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); -webkit-transform: translateX(-320px); transform: translateX(-320px); opacity: 0; -webkit-transition: all 0.3s ease; transition: all 0.3s ease; pointer-events: none; max-height: calc(100vh - 80px); overflow-y: auto; }
        .filter-panel.open { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; pointer-events: auto; }
        .filter-panel-header { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .filter-panel-title { font-size: 14px; font-weight: 600; color: #fff; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; gap: 8px; }
        .filter-panel-title svg { width: 16px; height: 16px; color: #22c55e; }
        .filter-panel-close { background: none; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px; line-height: 1; }
        .filter-panel-close:hover { color: #fff; }
        .filter-panel-content { padding: 16px; }

        .filter-section { margin-bottom: 20px; }
        .filter-section:last-child { margin-bottom: 0; }
        .filter-section-label { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }



         
        .download-section { display: -webkit-box; display: -webkit-flex; display: flex; gap: 8px; }
        .btn-download { -webkit-box-flex: 1; -webkit-flex: 1; flex: 1; padding: 10px 12px; min-height: 44px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #a0a0a0; font-size: 12px; font-weight: 500; cursor: pointer; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: center; -webkit-justify-content: center; justify-content: center; gap: 6px; -webkit-transition: all 0.2s; transition: all 0.2s; }
        .btn-download:hover { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.3); color: #22c55e; }
        .btn-download:active { -webkit-transform: translateY(1px); transform: translateY(1px); }
        .btn-download svg { width: 16px; height: 16px; }

        .activity-section { margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 12px; }
        .activity-header { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between; cursor: pointer; padding: 4px 0; }
        .activity-header:hover .activity-title { color: #fff; }
        .activity-title { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; -webkit-transition: color 0.2s; transition: color 0.2s; }
        .activity-toggle { width: 16px; height: 16px; color: #666; -webkit-transition: -webkit-transform 0.2s; transition: transform 0.2s; }
        .activity-toggle.expanded { -webkit-transform: rotate(180deg); transform: rotate(180deg); }
        .activity-list { max-height: 0; overflow: hidden; -webkit-transition: max-height 0.3s ease; transition: max-height 0.3s ease; }
        .activity-list.expanded { max-height: 300px; }
        .activity-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 11px; color: #888; }
        .activity-item:last-child { border-bottom: none; }
        .activity-date { color: #666; }
        .activity-location { color: #a0a0a0; }
        .activity-distance { color: #22c55e; font-weight: 500; float: right; }
        .activity-more { padding: 8px 0; text-align: center; font-size: 11px; color: #22c55e; cursor: pointer; }
        .activity-more:hover { text-decoration: underline; }
        .activity-empty { padding: 12px 0; text-align: center; font-size: 11px; color: #555; }

         
        .bbox-draw-overlay { position: fixed; top: 56px; left: 0; right: 0; bottom: 0; z-index: 200; cursor: crosshair; display: none; }
        .bbox-draw-overlay.active { display: block; }
        .bbox-draw-rect { position: absolute; border: 2px dashed #60a5fa; background: rgba(59,130,246,0.1); pointer-events: none; }
        .bbox-draw-hint { position: fixed; top: 70px; left: 50%; -webkit-transform: translateX(-50%); transform: translateX(-50%); background: rgba(18,18,18,0.95); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; padding: 10px 16px; font-size: 13px; color: #60a5fa; z-index: 210; display: none; }
        .bbox-draw-hint.active { display: block; }

         /* Search Panel */
        .search-panel { position: fixed; top: 66px; left: 62px; width: 280px; max-width: calc(100vw - 80px); background: rgba(18,18,18,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 140; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); -webkit-transform: translateX(-340px); transform: translateX(-340px); opacity: 0; -webkit-transition: all 0.3s ease; transition: all 0.3s ease; pointer-events: none; max-height: calc(100vh - 80px); overflow-y: auto; }
        .search-panel.open { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; pointer-events: auto; }
        .search-panel-header { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .search-panel-title { font-size: 14px; font-weight: 600; color: #fff; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; gap: 8px; }
        .search-panel-title svg { width: 16px; height: 16px; color: #22c55e; }
        .search-panel-close { background: none; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px; line-height: 1; }
        .search-panel-close:hover { color: #fff; }
        .search-panel-content { padding: 16px; }
        .search-input-wrapper { position: relative; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; }
        .search-input { width: 100%; padding: 10px 36px 10px 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0; font-size: 14px; -webkit-transition: all 0.2s; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: #22c55e; background: rgba(255,255,255,0.08); }
        .search-input::-webkit-input-placeholder { color: #666; }
        .search-input::placeholder { color: #666; }
        .search-clear { position: absolute; right: 10px; background: none; border: none; color: #666; font-size: 18px; cursor: pointer; padding: 0; line-height: 1; min-width: 24px; min-height: 24px; }
        .search-clear:hover { color: #fff; }
        .search-results { width: 100%; max-height: 320px; overflow-y: auto; background: rgba(26,26,26,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-top: 12px; display: none; -webkit-box-shadow: 0 10px 40px rgba(0,0,0,0.5); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .search-results.open { display: block; }
        .search-result-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.06); -webkit-transition: background 0.15s; transition: background 0.15s; min-height: 44px; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(34,197,94,0.1); }
        .search-result-item.unloaded { opacity: 0.7; }
        .search-result-item.unloaded:hover { background: rgba(128,128,128,0.15); }
        .search-result-name { font-size: 14px; color: #fff; margin-bottom: 2px; display: flex; align-items: center; gap: 8px; }
        .search-result-name .loaded-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
        .search-result-name .loaded-badge.loaded { background: rgba(34,197,94,0.2); color: #22c55e; }
        .search-result-name .loaded-badge.unloaded { background: rgba(128,128,128,0.2); color: #888; }
        .search-result-country { font-size: 12px; color: #888; }
        .search-no-results { padding: 16px 14px; text-align: center; color: #666; font-size: 13px; }
        .search-loading { padding: 16px 14px; text-align: center; color: #888; font-size: 13px; }

        /* Active Filters Display */
        .active-filters { margin-bottom: 16px; }
        .active-filter-item { display: flex; align-items: center; justify-content: space-between; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 6px; padding: 8px 10px; margin-bottom: 8px; font-size: 12px; }
        .active-filter-item.area { background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.2); }
        .active-filter-item.area .filter-item-icon { color: #60a5fa; }
        .active-filter-item.area .filter-item-value { color: #93c5fd; }
        .active-filter-item.park { background: rgba(168,85,247,0.1); border-color: rgba(168,85,247,0.2); }
        .active-filter-item.park .filter-item-icon { color: #a855f7; }
        .active-filter-item.park .filter-item-value { color: #c4b5fd; }
        .filter-item-content { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
        .filter-item-icon { width: 14px; height: 14px; color: #22c55e; flex-shrink: 0; }
        .filter-item-label { color: #888; font-size: 10px; text-transform: uppercase; }
        .filter-item-value { color: #22c55e; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-item-clear { background: none; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 2px 4px; line-height: 1; flex-shrink: 0; }
        .filter-item-clear:hover { color: #fff; }

        /* Selected Parks */
        .selected-parks { margin-top: 12px; }
        .selected-parks-empty { font-size: 11px; color: #555; text-align: center; padding: 12px; }
        .selected-park-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.15); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
        .selected-park-item:hover { background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); }
        .selected-park-item:last-child { margin-bottom: 0; }
        .selected-park-icon { width: 16px; height: 16px; color: #a855f7; flex-shrink: 0; }
        .selected-park-name { flex: 1; font-size: 12px; color: #e0e0e0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .selected-park-remove { background: none; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 2px; line-height: 1; }
        .selected-park-remove:hover { color: #ef4444; }

        /* PA Popup Tooltip (map popup style) */
        .maplibregl-popup-content { background: rgba(18,18,18,0.95) !important; border: 1px solid rgba(255,255,255,0.1) !important; border-radius: 8px !important; padding: 0 !important; box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important; min-width: 220px; max-width: 280px; }
        .maplibregl-popup-tip { border-top-color: rgba(18,18,18,0.95) !important; }
        .maplibregl-popup-close-button { color: #666 !important; font-size: 18px !important; padding: 4px 8px !important; }
        .maplibregl-popup-close-button:hover { color: #fff !important; background: transparent !important; }
        .pa-popup { padding: 12px; }
        .pa-popup-header { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .pa-popup-name { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .pa-popup-country { font-size: 11px; color: #888; display: flex; align-items: center; gap: 4px; }
        .pa-popup-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .pa-popup-stat { background: rgba(255,255,255,0.04); border-radius: 4px; padding: 8px; }
        .pa-popup-stat-label { font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        .pa-popup-stat-value { font-size: 13px; color: #22c55e; font-weight: 600; }
        .pa-popup-stat-value.muted { color: #888; }
        .pa-popup-actions { display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08); }
        .pa-popup-btn { flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #a0a0a0; font-size: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .pa-popup-btn:hover { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.3); color: #22c55e; }
        .pa-popup-btn svg { width: 12px; height: 12px; }
        .pa-popup-btn.selected { background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); color: #a855f7; }

         
        @media (max-width: 768px) {
            .header { padding: 0 12px; }
            .logo-subtitle { display: none; }
            .map-toolbar { top: auto; bottom: 24px; left: 10px; -webkit-flex-direction: row; flex-direction: row; }
            .filter-panel { top: auto; bottom: 80px; left: 10px; width: calc(100vw - 20px); max-width: 320px; -webkit-transform: translateY(400px); transform: translateY(400px); max-height: 60vh; }
            .filter-panel.open { -webkit-transform: translateY(0); transform: translateY(0); }
            .search-panel { top: auto; bottom: 80px; left: 10px; width: calc(100vw - 20px); max-width: 320px; -webkit-transform: translateY(400px); transform: translateY(400px); max-height: 60vh; }
            .search-panel.open { -webkit-transform: translateY(0); transform: translateY(0); }
            .stats-panel { top: auto; bottom: 80px; right: 10px; left: auto; }
            .fab { bottom: 140px; }
            .auth-buttons .btn { padding: 6px 12px; font-size: 13px; }
        }
        @media (max-width: 480px) {
            .logo span { font-size: 16px; }
            .auth-buttons .btn { padding: 6px 10px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <ellipse cx="12" cy="12" rx="4" ry="10"></ellipse>
                    <path d="M2 12h20"></path>
                    <path d="M4.5 6.5h15"></path>
                    <path d="M4.5 17.5h15"></path>
                </svg>
            </div>
            <div>
                <span>5MP.globe</span>
                <div class="logo-subtitle">Global Conservation Effort</div>
            </div>
        </div>
        
        <div class="auth-buttons">
            
            <button class="btn btn-secondary" onclick="showModal('login')">Login</button>
            <button class="btn btn-primary" onclick="showModal('register')">Register</button>
            
        </div>
    </header>



    <div id="map" class="maplibregl-map"><div class="maplibregl-canvas-container maplibregl-interactive maplibregl-touch-drag-pan maplibregl-touch-zoom-rotate"><canvas class="maplibregl-canvas" tabindex="0" aria-label="Map" role="region" width="375" height="756" style="width: 375px; height: 756px;"></canvas></div><div class="maplibregl-control-container"><div class="maplibregl-ctrl-top-left "></div><div class="maplibregl-ctrl-top-right "><div class="maplibregl-ctrl maplibregl-ctrl-group"><button class="maplibregl-ctrl-zoom-in" type="button" title="Zoom in" aria-label="Zoom in" aria-disabled="false"><span class="maplibregl-ctrl-icon" aria-hidden="true"></span></button><button class="maplibregl-ctrl-zoom-out" type="button" title="Zoom out" aria-label="Zoom out" aria-disabled="false"><span class="maplibregl-ctrl-icon" aria-hidden="true"></span></button><button class="maplibregl-ctrl-compass" type="button" title="Reset bearing to north" aria-label="Reset bearing to north"><span class="maplibregl-ctrl-icon" aria-hidden="true" style="transform: rotate(0deg);"></span></button></div></div><div class="maplibregl-ctrl-bottom-left "></div><div class="maplibregl-ctrl-bottom-right "><details class="maplibregl-ctrl maplibregl-ctrl-attrib maplibregl-compact maplibregl-compact-show" open=""><summary class="maplibregl-ctrl-attrib-button" title="Toggle attribution" aria-label="Toggle attribution"></summary><div class="maplibregl-ctrl-attrib-inner">© OpenStreetMap contributors, © CARTO | <a href="https://maplibre.org/" target="_blank">MapLibre</a></div></details></div></div><div id="map-legend" style="position: absolute; bottom: 30px; left: 10px; background: rgba(18, 18, 18, 0.9); padding: 12px 16px; border-radius: 8px; font-size: 12px; z-index: 100; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="font-weight: 600; margin-bottom: 10px; color: #fff;">Patrol Intensity</div>
                <div style="position: relative; height: 20px; margin-bottom: 6px;">
                    <div style="position: absolute; width: 100%; height: 16px; top: 2px; border-radius: 8px; background: linear-gradient(to right, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.4), rgba(74, 222, 128, 0.7), #4ade80); box-shadow: inset 0 0 0 1px rgba(74, 222, 128, 0.5);"></div>
                    <div style="position: absolute; right: 0; top: 0; width: 20px; height: 20px; border-radius: 50%; background: #4ade80; box-shadow: 0 0 12px 4px rgba(34, 197, 94, 0.8), 0 0 20px 8px rgba(34, 197, 94, 0.4);"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
                    <span>Low</span>
                    <span>High</span>
                </div>
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 10px; color: #555;">100 km² per pixel<br>Click clusters to zoom</div>
            </div></div>

    <div class="stats-panel">
        <h3 id="stats-title">Stats <span class="stats-period">(12 mo)</span></h3>
        <div class="stats-item" id="stat-pixels" onclick="handleStatClick('pixels')" title="Click to highlight active grid cells">
            <span class="stats-label">Active Pixels</span>
            <span class="stats-value" id="stats-pixels">15</span>
        </div>
        <div class="stats-item" id="stat-distance" onclick="handleStatClick('distance')" title="Click to show patrol intensity">
            <span class="stats-label">Total Distance</span>
            <span class="stats-value" id="stats-distance">1,980.8 km</span>
        </div>
        <div class="stats-item" id="stat-patrols" onclick="handleStatClick('patrols')" title="Click to zoom to patrol coverage">
            <span class="stats-label">Total Patrols</span>
            <span class="stats-value" id="stats-patrols">80</span>
        </div>
        <div class="page-views" id="page-views"></div>
    </div>

    
    <div class="map-toolbar" id="map-toolbar">
        
        <button class="toolbar-btn active" id="filter-toggle" onclick="toggleFilterPanel()" title="Filters">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        </button>
        
        <button class="toolbar-btn" id="toolbar-search" onclick="toggleSearch()" title="Search">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
        
        <button class="toolbar-btn" id="bbox-toggle" onclick="startBboxSelection()" title="Select Area">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
            </svg>
        </button>
        <div class="toolbar-separator"></div>
        
        <button class="toolbar-btn" id="download-toggle" onclick="showDownloadOptions()" title="Download Data">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        </button>
        
        <button class="toolbar-btn notification-btn" id="notification-toggle" onclick="toggleNotificationDropdown()" title="Recent Activity">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="notification-badge hidden" id="notification-badge"></span>
            
            <!-- Notification Dropdown -->
            <div class="notification-dropdown" id="notification-dropdown">
                <div class="notification-header">
                    <div class="notification-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Recent Activity
                    </div>
                    <button class="notification-close" onclick="closeNotificationDropdown(event)">&times;</button>
                </div>
                <div class="notification-list" id="notification-list">
                    <div class="notification-empty">Loading...</div>
                </div>
            </div>
        </button>
    </div>

    
    <div class="bbox-draw-overlay" id="bbox-draw-overlay"></div>
    <div class="bbox-draw-hint" id="bbox-draw-hint">Click and drag to select area. Press ESC to cancel.</div>

    
    <div class="filter-panel open" id="filter-panel">
        <div class="filter-panel-header">
            <div class="filter-panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                Active Filters
            </div>
            <button class="filter-panel-close" onclick="toggleFilterPanel()">×</button>
        </div>
        <div class="filter-panel-content">
            <!-- Active Filters -->
            <div class="active-filters" id="active-filters">
                <!-- Time Range Filter -->
                <div class="active-filter-item" id="filter-time">
                    <div class="filter-item-content">
                        <svg class="filter-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div>
                            <div class="filter-item-label">Time Range</div>
                            <div class="filter-item-value" id="filter-time-value">Last 12 months</div>
                        </div>
                    </div>
                </div>
                
                <!-- Selected Area Filter (hidden by default) -->
                <div class="active-filter-item area" id="filter-area" style="display: none;">
                    <div class="filter-item-content">
                        <svg class="filter-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        </svg>
                        <div>
                            <div class="filter-item-label">Selected Area</div>
                            <div class="filter-item-value" id="filter-area-value">Custom region</div>
                        </div>
                    </div>
                    <button class="filter-item-clear" onclick="clearBbox()" title="Clear">×</button>
                </div>
            </div>
            
            <!-- Movement Type Toggles -->
            <div class="filter-section">
                <div class="filter-section-label">Movement Type</div>
                <div class="movement-toggles">
                    <button class="movement-toggle active" id="toggle-foot" onclick="toggleMovementType('foot')" title="Foot patrols">Foot</button>
                    <button class="movement-toggle active" id="toggle-vehicle" onclick="toggleMovementType('vehicle')" title="Vehicle patrols">Vehicle</button>
                    <button class="movement-toggle active" id="toggle-aerial" onclick="toggleMovementType('aerial')" title="Aerial patrols">Aerial</button>
                </div>
            </div>
            
            <!-- Selected Parks -->
            <div class="filter-section">
                <div class="filter-section-label">Selected Parks</div>
                <div class="toggle-switch-row">
                    <span class="toggle-switch-label">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s-8-4.5-8-11.8A8 8 0 0 1 12 2a8 8 0 0 1 8 8.2c0 7.3-8 11.8-8 11.8z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        162 Keystones
                    </span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="keystones-toggle" checked onchange="toggleKeystones(this.checked)">
                        <span class="toggle-switch-slider"></span>
                    </label>
                </div>
                <div class="selected-parks" id="selected-parks">
                    <div class="selected-parks-empty" id="selected-parks-empty">Click a park on the map to select it</div>
                </div>
            </div>
            
            <!-- Hidden inputs for compatibility -->
            <input type="hidden" id="date-from">
            <input type="hidden" id="date-to">
            <div id="bbox-info" style="display:none;"></div>
            <div id="bbox-coords" style="display:none;"></div>

            <!-- Download Section -->
            <div class="filter-section">
                <div class="filter-section-label">Export Data</div>
                <div class="download-section">
                    <button class="btn-download" onclick="downloadData('csv')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        CSV
                    </button>
                    <button class="btn-download" onclick="downloadData('geojson')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                        GeoJSON
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" id="search-panel">
        <div class="search-panel-header">
            <div class="search-panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Search Protected Areas
            </div>
            <button class="search-panel-close" onclick="toggleSearch()">×</button>
        </div>
        <div class="search-panel-content">
            <div class="search-input-wrapper">
                <input type="text" class="search-input" id="search-input" placeholder="Search protected areas..." autocomplete="off" onkeyup="handleSearchInput(event)" onfocus="showSearchResults()">
                <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">×</button>
            </div>
            <div class="search-results" id="search-results"></div>
        </div>
    </div>

    <button class="fab " onclick="showModal('upload')" title="Upload Data">+</button>

    <!-- Time Slider -->
    <div class="time-slider-container" id="time-slider-container">
        <div class="time-slider-header">
            <div class="time-slider-date" id="time-slider-date">Jan 2020 - Dec 2024</div>
        </div>
        <div class="time-slider-track-wrapper">
            <div class="time-slider-track" id="time-slider-track">
                <div class="time-slider-range" id="time-slider-range"></div>
                <div class="time-slider-handle start" id="time-slider-start" data-handle="start"></div>
                <div class="time-slider-handle end" id="time-slider-end" data-handle="end"></div>
            </div>
            <div class="time-slider-ticks" id="time-slider-ticks"></div>
        </div>
    </div>

    
    <div id="modal-login" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Welcome Back</h2>
                <button class="modal-close" onclick="closeModal('login')">×</button>
            </div>
            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" placeholder="you@example.com" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" placeholder="••••••••" required="">
                </div>
                <div class="form-error" id="login-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Sign In</button>
                </div>
                <p class="form-switch">Don't have an account? <a href="#" onclick="switchModal('login', 'register')">Register</a></p>
            </form>
        </div>
    </div>

    
    <div id="modal-register" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create Account</h2>
                <button class="modal-close" onclick="closeModal('register')">×</button>
            </div>
            <form id="form-register" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" placeholder="you@example.com" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" placeholder="••••••••" minlength="8" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" name="confirm" class="form-input" placeholder="••••••••" required="">
                </div>
                <div class="form-error" id="register-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </div>
                <p class="form-switch">Already have an account? <a href="#" onclick="switchModal('register', 'login')">Sign in</a></p>
            </form>
        </div>
    </div>

    
    <div id="modal-upload" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Upload Conservation Data</h2>
                <button class="modal-close" onclick="closeModal('upload')">×</button>
            </div>
            <form id="form-upload" onsubmit="handleUpload(event)">
                <div class="upload-area" onclick="document.getElementById('file-input').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="upload-icon">📍</div>
                    <p class="upload-text">Drag &amp; drop GPX files here, or <strong>browse</strong></p>
                    <p class="upload-text" style="margin-top: 8px; font-size: 12px;">GPS patrol track files (.gpx)</p>
                </div>
                <input type="file" id="file-input" name="files" accept=".gpx" multiple="" style="display: none;" onchange="updateFileName(this)">
                <div id="selected-file" style="margin-bottom: 16px; color: #22c55e; font-size: 14px;"></div>
                <div class="form-error" id="upload-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>

    
    <!-- PA Stats Modal removed - now using map popups -->

    <script>
        const MAPTILER_KEY = 'dea58ea0389007e386776c4f583f4425';
        const API_HOST = 'five-mp-conservation-effort';

        // Format numbers - only use commas for numbers >= 1000
        function formatNumber(n, decimals) {
            if (n === null || n === undefined) return '0';
            const num = Number(n);
            if (decimals !== undefined) {
                const fixed = num.toFixed(decimals);
                return Math.abs(num) >= 1000 ? Number(fixed).toLocaleString() : fixed;
            }
            return Math.abs(num) >= 1000 ? num.toLocaleString() : String(num);
        }

        const darkStyle = {
            version: 8,
            name: 'Dark',
            glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'],
                    tileSize: 256,
                    attribution: '© OpenStreetMap contributors, © CARTO'
                }
            },
            layers: [{
                id: 'osm',
                type: 'raster',
                source: 'osm'
            }]
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: darkStyle,
            center: [20, 0],
            zoom: 3
        });
        map.addControl(new maplibregl.NavigationControl(), 'top-right');

        
        map.on('load', function() {
            
            map.addSource('areas', {
                type: 'geojson',
                data: '/api/areas'
            });

            
            map.addSource('grid', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] },
                cluster: true,
                clusterRadius: 20,
                clusterMaxZoom: 4,
                clusterProperties: {
                    'sum_intensity': ['+', ['get', 'intensity']],
                    'sum_distance': ['+', ['coalesce', ['get', 'total_distance_km'], 0]],
                    'sum_visits': ['+', ['coalesce', ['get', 'unique_uploads'], 0]]
                }
            });

            
            map.addLayer({
                id: 'areas-fill',
                type: 'fill',
                source: 'areas',
                paint: {
                    'fill-color': '#22c55e',
                    'fill-opacity': 0.2
                }
            });

            
            map.addLayer({
                id: 'areas-outline',
                type: 'line',
                source: 'areas',
                paint: {
                    'line-color': '#22c55e',
                    'line-width': 1
                }
            });

            
            // Grid pixel rendering - uniform outline with radial fill that overflows at high intensity
            // Intensity is based on coverage: 1.0 = 80%+ of 100km² cell covered
            
            // Outer glow halo for high intensity pixels (>80%)
            map.addLayer({
                id: 'grid-halo',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#22c55e',
                    'circle-radius': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0,
                        0.7, 0,
                        0.8, 28,
                        1, 38
                    ],
                    'circle-blur': 1.5,
                    'circle-opacity': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0,
                        0.7, 0,
                        0.8, 0.25,
                        1, 0.5
                    ]
                }
            });

            // Soft glow layer for aggregation effect
            map.addLayer({
                id: 'grid-glow',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#22c55e',
                    'circle-radius': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 14,
                        0.5, 20,
                        0.8, 26,
                        1, 30
                    ],
                    'circle-blur': 1.2,
                    'circle-opacity': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0.1,
                        0.5, 0.25,
                        0.8, 0.4,
                        1, 0.55
                    ]
                }
            });

            // Inner fill - grows with intensity, overflows outline at full coverage
            map.addLayer({
                id: 'grid-fill',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#4ade80',
                    'circle-radius': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0,
                        0.1, 2,
                        0.3, 4,
                        0.5, 6,
                        0.8, 10,
                        1, 14  // Overflow the 10px outline at full intensity
                    ],
                    'circle-blur': 0.3,
                    'circle-opacity': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0,
                        0.2, 0.4,
                        0.5, 0.65,
                        0.8, 0.9,
                        1, 1
                    ]
                }
            });

            // Outer ring/outline - always visible, uniform size
            map.addLayer({
                id: 'grid-cells',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': 'transparent',
                    'circle-radius': 10,
                    'circle-stroke-color': '#4ade80',
                    'circle-stroke-width': 1.5,
                    'circle-opacity': 1
                }
            });

            // Clustered circles layer (for zoomed out view)
            map.addLayer({
                id: 'grid-clusters',
                type: 'circle',
                source: 'grid',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': '#22c55e',
                    'circle-radius': [
                        'interpolate', ['linear'],
                        ['get', 'point_count'],
                        2, 12,
                        10, 16,
                        50, 20,
                        100, 24
                    ],
                    'circle-stroke-color': '#4ade80',
                    'circle-stroke-width': 2,
                    'circle-blur': 0.2,
                    'circle-opacity': 0.7
                }
            });

            // Cluster count labels
            map.addLayer({
                id: 'grid-cluster-count',
                type: 'symbol',
                source: 'grid',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['Open Sans Semibold'],
                    'text-size': 11
                },
                paint: {
                    'text-color': '#ffffff'
                }
            });

            
            map.on('click', 'areas-fill', function(e) {
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    const name = props.name || 'Protected Area';
                    const country = props.country || '';
                    const area = props.area_km2 ? props.area_km2.toLocaleString() + ' km²' : '';
                    const wdpaId = props.wdpa_id || '';
                    const partner = props.partner || '';
                    
                    let html = `<strong style="font-size: 14px;">${name}</strong>`;
                    if (country) html += `<br><span style="color: #888;">${country}</span>`;
                    if (area) html += `<br>Area: <strong>${area}</strong>`;
                    if (partner) html += `<br>Partner: <span style="color: #22c55e;">${partner}</span>`;
                    if (wdpaId) html += `<br><span style="color: #666; font-size: 10px;">WDPA ID: ${wdpaId}</span>`;
                    
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(html)
                        .addTo(map);
                }
            });

            
            map.on('click', 'grid-cells', function(e) {
                e.originalEvent.stopPropagation();
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    const pixelId = props.id || 'Unknown';
                    const distance = props.total_distance_km ? props.total_distance_km.toFixed(1) : '0';
                    const visits = props.unique_uploads || 0;
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <strong>Effort Pixel</strong><br>
                            <span style="color: #888; font-size: 11px;">ID: ${pixelId}</span><br>
                            Total Distance: <strong>${distance} km</strong><br>
                            Total Visits: <strong>${visits}</strong><br>
                            <span style="color: #666; font-size: 10px;">100 km² (~10km × 10km)</span>
                        `)
                        .addTo(map);
                }
            });

            
            // Click handler for clusters - zoom in to expand
            map.on('click', 'grid-clusters', function(e) {
                e.originalEvent.stopPropagation();
                const features = map.queryRenderedFeatures(e.point, { layers: ['grid-clusters'] });
                if (features.length > 0) {
                    const clusterId = features[0].properties.cluster_id;
                    const source = map.getSource('grid');
                    source.getClusterExpansionZoom(clusterId, function(err, zoom) {
                        if (err) return;
                        map.easeTo({
                            center: features[0].geometry.coordinates,
                            zoom: zoom
                        });
                    });
                }
            });

            map.on('mouseenter', 'areas-fill', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'areas-fill', function() { map.getCanvas().style.cursor = ''; });
            map.on('mouseenter', 'grid-cells', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'grid-cells', function() { map.getCanvas().style.cursor = ''; });
            map.on('mouseenter', 'grid-clusters', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'grid-clusters', function() { map.getCanvas().style.cursor = ''; });

            
            const legend = document.createElement('div');
            legend.id = 'map-legend';
            legend.style.cssText = 'position: absolute; bottom: 30px; left: 10px; background: rgba(18,18,18,0.9); padding: 12px 16px; border-radius: 8px; font-size: 12px; z-index: 100; border: 1px solid rgba(255,255,255,0.1);';
            legend.innerHTML = `
                <div style="font-weight: 600; margin-bottom: 10px; color: #fff;">Patrol Intensity</div>
                <div style="position: relative; height: 20px; margin-bottom: 6px;">
                    <div style="position: absolute; width: 100%; height: 16px; top: 2px; border-radius: 8px; background: linear-gradient(to right, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.4), rgba(74, 222, 128, 0.7), #4ade80); box-shadow: inset 0 0 0 1px rgba(74, 222, 128, 0.5);"></div>
                    <div style="position: absolute; right: 0; top: 0; width: 20px; height: 20px; border-radius: 50%; background: #4ade80; box-shadow: 0 0 12px 4px rgba(34, 197, 94, 0.8), 0 0 20px 8px rgba(34, 197, 94, 0.4);"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
                    <span>Low</span>
                    <span>High</span>
                </div>
                <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 10px; color: #555;">100 km² per pixel<br>Click clusters to zoom</div>
            `;
            document.getElementById('map').appendChild(legend);
        });

        function showModal(name) { document.getElementById(`modal-${name}`).classList.add('active'); }
        function closeModal(name) {
            document.getElementById(`modal-${name}`).classList.remove('active');
            const form = document.getElementById(`form-${name}`);
            if (form) form.reset();
            const error = document.getElementById(`${name}-error`);
            if (error) error.style.display = 'none';
        }
        function closeModalOnOverlay(e) { if (e.target.classList.contains('modal-overlay')) e.target.classList.remove('active'); }
        function switchModal(from, to) { closeModal(from); showModal(to); }
        function showError(name, msg) { const el = document.getElementById(`${name}-error`); el.textContent = msg; el.style.display = 'block'; }

        async function handleLogin(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: data.get('email'), password: data.get('password') })
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Login failed');
                window.location.reload();
            } catch (err) { showError('login', err.message); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            if (data.get('password') !== data.get('confirm')) { showError('register', 'Passwords do not match'); return; }
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: data.get('email'), password: data.get('password') })
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Registration failed');
                window.location.reload();
            } catch (err) { showError('register', err.message); }
        }

        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                document.getElementById('file-input').files = e.dataTransfer.files;
                updateFileName(document.getElementById('file-input'));
            }
        }
        function updateFileName(input) {
            if (input.files.length === 0) {
                document.getElementById('selected-file').textContent = '';
            } else if (input.files.length === 1) {
                document.getElementById('selected-file').textContent = `Selected: ${input.files[0].name}`;
            } else {
                document.getElementById('selected-file').textContent = `Selected: ${input.files.length} files`;
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file-input');
            if (!fileInput.files.length) { showError('upload', 'Please select at least one GPX file'); return; }
            
            const formData = new FormData();
            for (let file of fileInput.files) {
                formData.append('files', file);
            }
            
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Upload failed');
                }
                closeModal('upload');
                
                reloadGridData();
                loadStats();
                alert('Upload successful! ' + fileInput.files.length + ' file(s) processed.');
            } catch (err) { showError('upload', err.message); }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        });

        
        async function loadStats() {
            try {
                // Build URL with filters
                var url = '/api/stats';
                var params = [];
                if (dateFrom) params.push('from=' + dateFrom);
                if (dateTo) params.push('to=' + dateTo);
                if (currentBbox) params.push('bbox=' + currentBbox.join(','));
                // Add movement type filter
                var types = getActiveMovementTypes();
                if (types.length < 3 && types.length > 0) {
                    params.push('type=' + types.join(','));
                }
                if (params.length > 0) url += '?' + params.join('&');
                
                const res = await fetch(url);
                if (res.ok) {
                    const stats = await res.json();
                    document.getElementById('stats-pixels').textContent = formatNumber(stats.active_pixels || 0);
                    document.getElementById('stats-distance').textContent = formatNumber(stats.total_distance_km || 0, 1) + ' km';
                    document.getElementById('stats-patrols').textContent = formatNumber(stats.total_patrols || 0);
                }
                // Update stats title to reflect current filter
                updateStatsTitle();
            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        
        function updateStatsTitle() {
            var period = document.querySelector('.stats-period');
            if (period) {
                var presetLabels = {'30d': '30d', '90d': '90d', '6m': '6 mo', '12m': '12 mo', 'all': 'all time', 'custom': 'custom'};
                var label = presetLabels[currentPreset] || '12 mo';
                if (currentBbox) label += ', area';
                period.textContent = '(' + label + ')';
            }
        }
        // Declare state variables before they're used
        let filterPanelOpen = true; // Panel starts open in HTML
        let searchOpen = false;
        var dateFrom = null;
        var dateTo = null;
        var currentPreset = '12m';
        var customDatesOpen = false;
        let activityExpanded = false;
        let currentBbox = null; 
        let bboxDrawing = false;
        let bboxStartPoint = null;
        
        // Movement type filter state (all on by default)
        var movementTypes = { foot: true, vehicle: true, aerial: true };
        
        // Initial stats load will happen after initDateRange sets dates
        // loadStats(); // Moved to after initDateRange

        
        function checkDateInputSupport() {
            var input = document.createElement('input');
            input.setAttribute('type', 'date');
            if (input.type === 'text') {
                
                var dateInputs = document.querySelectorAll('.date-input[type="date"]');
                for (var i = 0; i < dateInputs.length; i++) {
                    dateInputs[i].type = 'text';
                    dateInputs[i].placeholder = 'YYYY-MM-DD';
                }
            }
        }
        checkDateInputSupport();

        
        function formatDateDisplay(dateStr) {
            if (!dateStr) return null;
            try {
                var d = new Date(dateStr + 'T00:00:00');
                var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return months[d.getMonth()] + ' ' + d.getFullYear();
            } catch (e) {
                return dateStr;
            }
        }

        
        function updateDateRangeDisplay() {
            var display = document.getElementById('date-range-display');
            if (dateFrom && dateTo) {
                display.textContent = formatDateDisplay(dateFrom) + ' - ' + formatDateDisplay(dateTo);
            } else if (dateFrom) {
                display.textContent = 'From ' + formatDateDisplay(dateFrom);
            } else if (dateTo) {
                display.textContent = 'Until ' + formatDateDisplay(dateTo);
            } else {
                display.textContent = 'All Time';
            }
        }

        function initDateRange() {
            // Date range is now controlled by the time slider at the bottom
            // Don't call setDatePreset - slider will set dates on init
        }
        
        function setDatePreset(preset) {
            currentPreset = preset;
            var today = new Date();
            var from = new Date();
            var formatDate = function(d) { return d.toISOString().split('T')[0]; };
            
            // Clear active class from all preset buttons
            document.querySelectorAll('.date-preset-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            
            // Set the date range based on preset
            switch(preset) {
                case '30d':
                    from.setDate(today.getDate() - 30);
                    break;
                case '90d':
                    from.setDate(today.getDate() - 90);
                    break;
                case '6m':
                    from.setMonth(today.getMonth() - 6);
                    break;
                case '12m':
                    from.setFullYear(today.getFullYear() - 1);
                    break;
                case 'all':
                    dateFrom = '';
                    dateTo = '';
                    document.getElementById('date-from').value = '';
                    document.getElementById('date-to').value = '';
                    document.getElementById('date-range-display').textContent = 'All Time';
                    // Mark active
                    event && event.target && event.target.classList.add('active');
                    document.querySelector('.date-preset-btn[onclick*="all"]').classList.add('active');
                    // Close custom dates if open
                    if (customDatesOpen) toggleCustomDates();
                    reloadGridData();
                    return;
            }
            
            dateFrom = formatDate(from);
            dateTo = formatDate(today);
            document.getElementById('date-from').value = dateFrom;
            document.getElementById('date-to').value = dateTo;
            
            // Update display with preset name
            var presetNames = {'30d': 'Last 30 Days', '90d': 'Last 90 Days', '6m': 'Last 6 Months', '12m': 'Last 12 Months'};
            document.getElementById('date-range-display').textContent = presetNames[preset] || 'Custom';
            
            // Mark active button
            document.querySelector('.date-preset-btn[onclick*="' + preset + '"]').classList.add('active');
            
            // Close custom dates if open
            if (customDatesOpen) toggleCustomDates();
            
            reloadGridData();
        }
        
        function toggleCustomDates() {
            customDatesOpen = !customDatesOpen;
            var inputs = document.getElementById('date-custom-inputs');
            var toggle = document.getElementById('custom-date-toggle');
            if (customDatesOpen) {
                inputs.style.display = 'flex';
                toggle.classList.add('active');
            } else {
                inputs.style.display = 'none';
                toggle.classList.remove('active');
            }
        }
        
        function updateDateRange(isCustom) {
            dateFrom = document.getElementById('date-from').value;
            dateTo = document.getElementById('date-to').value;
            if (isCustom) {
                // Clear preset selection when using custom dates
                document.querySelectorAll('.date-preset-btn').forEach(function(btn) {
                    btn.classList.remove('active');
                });
                currentPreset = 'custom';
            }
            updateDateRangeDisplay();
            reloadGridData();
        }

        function toggleFilterPanel() {
            filterPanelOpen = !filterPanelOpen;
            var panel = document.getElementById('filter-panel');
            var toggle = document.getElementById('filter-toggle');
            if (filterPanelOpen) {
                panel.classList.add('open');
                toggle.classList.add('active');
                // Close search panel if open
                if (searchOpen) {
                    searchOpen = false;
                    document.getElementById('search-panel').classList.remove('open');
                    document.getElementById('toolbar-search').classList.remove('active');
                }
            } else {
                panel.classList.remove('open');
                toggle.classList.remove('active');
            }
        }

        function updateDateRange() {
            dateFrom = document.getElementById('date-from').value;
            dateTo = document.getElementById('date-to').value;
            updateDateRangeDisplay();
            reloadGridData();
        }

        var mapLoaded = false;
        var pendingGridReload = false;
        
        map.on('load', function() {
            mapLoaded = true;
            if (pendingGridReload) {
                pendingGridReload = false;
                reloadGridData();
            }
        });
        
        function reloadGridData() {
            // Wait for map to be loaded
            if (!mapLoaded) {
                pendingGridReload = true;
                return;
            }
            
            var url = '/api/grid?t=' + Date.now();
            if (dateFrom) url += '&from=' + dateFrom;
            if (dateTo) url += '&to=' + dateTo;
            if (currentBbox) {
                url += '&bbox=' + currentBbox.join(',');
            }
            // Add movement type filter
            var types = getActiveMovementTypes();
            if (types.length < 3 && types.length > 0) {
                url += '&type=' + types.join(',');
            }
            
            console.log('Reloading grid data: from=' + dateFrom + ', to=' + dateTo + ', bbox=' + (currentBbox ? currentBbox.join(',') : 'none') + ', types=' + types.join(','));
            
            // Fetch data and set it
            fetch(url)
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var gridSource = map.getSource('grid');
                    if (gridSource) {
                        gridSource.setData(data);
                    }
                })
                .catch(function(err) {
                    console.error('Failed to load grid data:', err);
                });
            
            // Also reload stats when filters change
            loadStats();
        }

        
        function startBboxSelection() {
            bboxDrawing = true;
            bboxStartPoint = null;
            document.getElementById('bbox-draw-overlay').classList.add('active');
            document.getElementById('bbox-draw-hint').classList.add('active');
            document.getElementById('bbox-toggle').classList.add('active');
            map.getCanvas().style.cursor = 'crosshair';
        }

        function cancelBboxSelection() {
            bboxDrawing = false;
            bboxStartPoint = null;
            document.getElementById('bbox-draw-overlay').classList.remove('active');
            document.getElementById('bbox-draw-hint').classList.remove('active');
            document.getElementById('bbox-toggle').classList.remove('active');
            map.getCanvas().style.cursor = '';
            
            var rect = document.querySelector('.bbox-draw-rect');
            if (rect) rect.remove();
        }

        function setBbox(minLng, minLat, maxLng, maxLat) {
            currentBbox = [minLng, minLat, maxLng, maxLat];
            
            // Update filter panel display
            var filterArea = document.getElementById('filter-area');
            var filterAreaValue = document.getElementById('filter-area-value');
            if (filterArea && filterAreaValue) {
                filterArea.style.display = 'flex';
                // Calculate approximate area size
                var latDiff = Math.abs(maxLat - minLat);
                var lngDiff = Math.abs(maxLng - minLng);
                var approxKm = Math.round(latDiff * 111 * lngDiff * 111 * Math.cos((minLat + maxLat) / 2 * Math.PI / 180));
                filterAreaValue.textContent = formatNumber(approxKm) + ' km² region';
            }
            
            // Auto-select PAs that intersect the bbox
            selectPAsInBbox(minLng, minLat, maxLng, maxLat);
            
            drawBboxOnMap();
            reloadGridData();
        }

        // Select PAs that intersect the given bounding box
        function selectPAsInBbox(minLng, minLat, maxLng, maxLat) {
            if (!map || !map.getSource('areas')) return;
            
            // Clear previous bbox selection
            selectedPAIds.clear();
            selectedParks = [];
            
            // Query all features from the areas source
            var features = map.querySourceFeatures('areas');
            
            features.forEach(function(feature) {
                var props = feature.properties;
                var paId = props.id || props.wdpa_id;
                if (!paId) return;
                
                // Check if feature intersects bbox
                // Get feature bounds from geometry
                var geom = feature.geometry;
                if (!geom || !geom.coordinates) return;
                
                var featureBounds = getGeometryBounds(geom);
                if (!featureBounds) return;
                
                // Check if bboxes overlap
                if (bboxesIntersect(
                    [minLng, minLat, maxLng, maxLat],
                    featureBounds
                )) {
                    selectedPAIds.add(paId);
                    selectedParks.push({
                        id: paId,
                        name: props.name || 'Unknown',
                        bbox: featureBounds,
                        center: [(featureBounds[0] + featureBounds[2]) / 2, (featureBounds[1] + featureBounds[3]) / 2]
                    });
                }
            });
            
            // Update map highlighting and display
            updatePAHighlighting();
            updateSelectedParksDisplay();
        }
        
        // Get bounds [minLng, minLat, maxLng, maxLat] from a GeoJSON geometry
        function getGeometryBounds(geom) {
            var minLng = Infinity, minLat = Infinity, maxLng = -Infinity, maxLat = -Infinity;
            
            function processCoords(coords) {
                if (typeof coords[0] === 'number') {
                    // It's a point [lng, lat]
                    if (coords[0] < minLng) minLng = coords[0];
                    if (coords[0] > maxLng) maxLng = coords[0];
                    if (coords[1] < minLat) minLat = coords[1];
                    if (coords[1] > maxLat) maxLat = coords[1];
                } else {
                    // It's an array of coords
                    coords.forEach(processCoords);
                }
            }
            
            if (geom.coordinates) {
                processCoords(geom.coordinates);
            }
            
            if (minLng === Infinity) return null;
            return [minLng, minLat, maxLng, maxLat];
        }
        
        // Check if two bboxes [minLng, minLat, maxLng, maxLat] intersect
        function bboxesIntersect(a, b) {
            return !(a[2] < b[0] || b[2] < a[0] || a[3] < b[1] || b[3] < a[1]);
        }
        
        // Update PA layer styling based on selectedPAIds
        function updatePAHighlighting() {
            if (!map || !map.getLayer || !map.getLayer('areas-fill')) return;
            
            if (selectedPAIds.size === 0) {
                // No selection - use default keystones styling
                if (keystonesEnabled) {
                    map.setPaintProperty('areas-fill', 'fill-color', '#22c55e');
                    map.setPaintProperty('areas-fill', 'fill-opacity', 0.2);
                    map.setPaintProperty('areas-outline', 'line-color', '#22c55e');
                    map.setPaintProperty('areas-outline', 'line-width', 1);
                } else {
                    map.setPaintProperty('areas-fill', 'fill-color', '#666666');
                    map.setPaintProperty('areas-fill', 'fill-opacity', 0.1);
                    map.setPaintProperty('areas-outline', 'line-color', '#555555');
                    map.setPaintProperty('areas-outline', 'line-width', 1);
                }
            } else {
                // Has selection - highlight selected PAs in green, others in grey
                var selectedIds = Array.from(selectedPAIds);
                
                map.setPaintProperty('areas-fill', 'fill-color', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    '#22c55e',  // Selected: green
                    '#666666'   // Not selected: grey
                ]);
                
                map.setPaintProperty('areas-fill', 'fill-opacity', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    0.35,  // Selected: more opaque
                    0.1    // Not selected: faded
                ]);
                
                map.setPaintProperty('areas-outline', 'line-color', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    '#22c55e',  // Selected: green
                    '#555555'   // Not selected: grey
                ]);
                
                map.setPaintProperty('areas-outline', 'line-width', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    2,  // Selected: thicker
                    1   // Not selected: normal
                ]);
            }
        }

        function toggleMovementType(type) {
            movementTypes[type] = !movementTypes[type];
            var btn = document.getElementById('toggle-' + type);
            if (btn) {
                if (movementTypes[type]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            reloadGridData();
        }

        // Keystones toggle state
        var keystonesEnabled = true;

        function toggleKeystones(enabled) {
            keystonesEnabled = enabled;
            if (!map || !map.getLayer) return;
            
            // Use updatePAHighlighting to handle both keystones toggle and selected PAs
            updatePAHighlighting();
        }

        function getActiveMovementTypes() {
            var types = [];
            if (movementTypes.foot) types.push('foot');
            if (movementTypes.vehicle) types.push('vehicle');
            if (movementTypes.aerial) types.push('aerial');
            return types;
        }

        function clearBbox() {
            currentBbox = null;
            
            // Hide filter panel display
            var filterArea = document.getElementById('filter-area');
            if (filterArea) {
                filterArea.style.display = 'none';
            }
            
            // Clear PA selection
            selectedPAIds.clear();
            selectedParks = [];
            updatePAHighlighting();
            updateSelectedParksDisplay();
            
            removeBboxFromMap();
            reloadGridData();
        }

        function drawBboxOnMap() {
            removeBboxFromMap();
            if (!currentBbox || !map.getSource) return;
            
            var coords = [
                [currentBbox[0], currentBbox[1]],
                [currentBbox[2], currentBbox[1]],
                [currentBbox[2], currentBbox[3]],
                [currentBbox[0], currentBbox[3]],
                [currentBbox[0], currentBbox[1]]
            ];
            
            try {
                map.addSource('bbox-selection', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { type: 'Polygon', coordinates: [coords] }
                    }
                });
                map.addLayer({
                    id: 'bbox-selection-fill',
                    type: 'fill',
                    source: 'bbox-selection',
                    paint: { 'fill-color': '#60a5fa', 'fill-opacity': 0.1 }
                });
                map.addLayer({
                    id: 'bbox-selection-line',
                    type: 'line',
                    source: 'bbox-selection',
                    paint: { 'line-color': '#60a5fa', 'line-width': 2, 'line-dasharray': [2, 2] }
                });
            } catch (e) {
                console.log('Could not draw bbox on map:', e);
            }
        }

        function removeBboxFromMap() {
            try {
                if (map.getLayer('bbox-selection-fill')) map.removeLayer('bbox-selection-fill');
                if (map.getLayer('bbox-selection-line')) map.removeLayer('bbox-selection-line');
                if (map.getSource('bbox-selection')) map.removeSource('bbox-selection');
            } catch (e) {}
        }

        
        (function() {
            var overlay = document.getElementById('bbox-draw-overlay');
            var startX, startY, rect;
            
            function getMapCoords(clientX, clientY) {
                var mapEl = document.getElementById('map');
                var mapRect = mapEl.getBoundingClientRect();
                var point = { x: clientX - mapRect.left, y: clientY - mapRect.top };
                return map.unproject([point.x, point.y]);
            }
            
            function onStart(e) {
                e.preventDefault();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var clientY = e.touches ? e.touches[0].clientY : e.clientY;
                startX = clientX;
                startY = clientY;
                bboxStartPoint = getMapCoords(clientX, clientY);
                
                rect = document.createElement('div');
                rect.className = 'bbox-draw-rect';
                rect.style.left = clientX + 'px';
                rect.style.top = clientY + 'px';
                rect.style.width = '0px';
                rect.style.height = '0px';
                document.body.appendChild(rect);
            }
            
            function onMove(e) {
                if (!bboxStartPoint || !rect) return;
                e.preventDefault();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                var left = Math.min(startX, clientX);
                var top = Math.min(startY, clientY);
                var width = Math.abs(clientX - startX);
                var height = Math.abs(clientY - startY);
                
                rect.style.left = left + 'px';
                rect.style.top = top + 'px';
                rect.style.width = width + 'px';
                rect.style.height = height + 'px';
            }
            
            function onEnd(e) {
                if (!bboxStartPoint) return;
                var clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                var clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                var endPoint = getMapCoords(clientX, clientY);
                
                var minLng = Math.min(bboxStartPoint.lng, endPoint.lng);
                var maxLng = Math.max(bboxStartPoint.lng, endPoint.lng);
                var minLat = Math.min(bboxStartPoint.lat, endPoint.lat);
                var maxLat = Math.max(bboxStartPoint.lat, endPoint.lat);
                
                
                if (Math.abs(maxLng - minLng) > 0.001 && Math.abs(maxLat - minLat) > 0.001) {
                    setBbox(minLng, minLat, maxLng, maxLat);
                }
                
                cancelBboxSelection();
            }
            
            overlay.addEventListener('mousedown', onStart);
            overlay.addEventListener('mousemove', onMove);
            overlay.addEventListener('mouseup', onEnd);
            overlay.addEventListener('touchstart', onStart);
            overlay.addEventListener('touchmove', onMove);
            overlay.addEventListener('touchend', onEnd);
        })();

        
        function showDownloadOptions() {
            if (!filterPanelOpen) toggleFilterPanel();
            
        }

        function downloadData(format) {
            format = format || 'csv';
            var url = '/api/export?format=' + format;
            if (dateFrom) url += '&from=' + dateFrom;
            if (dateTo) url += '&to=' + dateTo;
            if (currentBbox) url += '&bbox=' + currentBbox.join(',');
            
            
            var a = document.createElement('a');
            a.href = url;
            a.download = 'patrol-data.' + (format === 'geojson' ? 'geojson' : 'csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function toggleActivityLog() {
            activityExpanded = !activityExpanded;
            const list = document.getElementById('activity-list');
            const icon = document.getElementById('activity-toggle-icon');
            
            if (activityExpanded) {
                list.classList.add('expanded');
                icon.classList.add('expanded');
                loadActivityLog();
            } else {
                list.classList.remove('expanded');
                icon.classList.remove('expanded');
            }
        }

        async function loadActivityLog() {
            const list = document.getElementById('activity-list');
            
            try {
                const res = await fetch('/api/activity');
                if (res.ok) {
                    const data = await res.json();
                    // API returns array directly
                    const activities = Array.isArray(data) ? data : (data.activities || []);
                    if (activities.length > 0) {
                        list.innerHTML = activities.slice(0, 10).map(a => {
                            const dateStr = a.date || 'Unknown';
                            const location = a.location || 'Unknown';
                            const distance = a.distance ? a.distance.toFixed(1) + ' km' : '';
                            const typeIcon = {'foot': '🚶', 'vehicle': '🚗', 'aircraft': '✈️'}[a.type] || '📍';
                            return `<div class="activity-item">
                                <span class="activity-date">${typeIcon} ${dateStr}</span>
                                <span class="activity-distance">${distance}</span>
                            </div>`;
                        }).join('');
                    } else {
                        list.innerHTML = '<div class="activity-empty">No recent activity</div>';
                    }
                } else {
                    throw new Error('Failed to load');
                }
            } catch (err) {
                console.error('Activity load error:', err);
                list.innerHTML = '<div class="activity-empty">No recent activity</div>';
            }
        }

        // Notification Dropdown functionality
        let latestActivities = [];
        let activityMarker = null;
        let notificationDropdownOpen = false;
        let hasNewNotifications = true;

        // Sample/demo data for when no real activity exists
        const sampleActivities = [
            { location: 'Serengeti National Park', distance: 12.5, date: 'Today', type: 'foot', lat: -2.3333, lon: 34.8333 },
            { location: 'Kruger National Park', distance: 8.2, date: 'Yesterday', type: 'vehicle', lat: -24.0167, lon: 31.4833 },
            { location: 'Masai Mara Reserve', distance: 15.7, date: 'Jan 28', type: 'foot', lat: -1.5, lon: 35.0 },
            { location: 'Yellowstone National Park', distance: 22.1, date: 'Jan 27', type: 'foot', lat: 44.4280, lon: -110.5885 },
            { location: 'Great Barrier Reef', distance: 5.3, date: 'Jan 26', type: 'vehicle', lat: -18.2871, lon: 147.6992 }
        ];

        async function loadNotifications() {
            try {
                const res = await fetch('/api/activity');
                if (!res.ok) throw new Error('Failed to load');
                
                const data = await res.json();
                latestActivities = (Array.isArray(data) ? data : (data.activities || [])).filter(a => a.lat && a.lon);
                
                // Use sample data if no real data with coordinates
                if (latestActivities.length === 0) {
                    latestActivities = sampleActivities;
                }
                
                updateNotificationList();
                showNotificationBadge();
            } catch (err) {
                console.error('Notifications load error:', err);
                // Fall back to sample data on error
                latestActivities = sampleActivities;
                updateNotificationList();
                showNotificationBadge();
            }
        }

        function updateNotificationList() {
            const listEl = document.getElementById('notification-list');
            
            if (latestActivities.length === 0) {
                listEl.innerHTML = '<div class="notification-empty">No recent activity</div>';
                return;
            }
            
            listEl.innerHTML = latestActivities.slice(0, 10).map((activity, index) => {
                const location = activity.location || 'Unknown location';
                const distance = activity.distance ? activity.distance.toFixed(1) + ' km' : '';
                const date = activity.date || '';
                const typeIcon = {'foot': '🚶', 'vehicle': '🚗', 'aircraft': '✈️'}[activity.type] || '📍';
                
                let details = '';
                if (distance && date) details = `${distance} • ${date}`;
                else if (distance) details = distance;
                else if (date) details = date;
                
                return `
                    <div class="notification-item" onclick="handleNotificationClick(${index})">
                        <div class="notification-icon">${typeIcon}</div>
                        <div class="notification-content">
                            <div class="notification-location">${escapeHtml(location)}</div>
                            <div class="notification-details">${details}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showNotificationBadge() {
            if (hasNewNotifications && latestActivities.length > 0) {
                document.getElementById('notification-badge').classList.remove('hidden');
            }
        }

        function hideNotificationBadge() {
            hasNewNotifications = false;
            document.getElementById('notification-badge').classList.add('hidden');
        }

        function toggleNotificationDropdown() {
            notificationDropdownOpen = !notificationDropdownOpen;
            const dropdown = document.getElementById('notification-dropdown');
            const btn = document.getElementById('notification-toggle');
            
            if (notificationDropdownOpen) {
                dropdown.classList.add('open');
                btn.classList.add('active');
                hideNotificationBadge();
            } else {
                dropdown.classList.remove('open');
                btn.classList.remove('active');
            }
        }

        function closeNotificationDropdown(event) {
            if (event) event.stopPropagation();
            notificationDropdownOpen = false;
            document.getElementById('notification-dropdown').classList.remove('open');
            document.getElementById('notification-toggle').classList.remove('active');
        }

        function handleNotificationClick(index) {
            if (index >= 0 && index < latestActivities.length) {
                const activity = latestActivities[index];
                if (activity.lat && activity.lon) {
                    zoomToActivity(activity);
                    closeNotificationDropdown();
                }
            }
        }

        function zoomToActivity(activity) {
            // Remove existing marker
            removeActivityMarker();
            
            // Fly to location
            map.flyTo({
                center: [activity.lon, activity.lat],
                zoom: 12,
                duration: 1500,
                essential: true
            });
            
            // Add pulsing marker after flight completes
            setTimeout(() => {
                addActivityMarker(activity.lon, activity.lat);
            }, 1600);
        }

        function addActivityMarker(lon, lat) {
            removeActivityMarker();
            
            // Create marker element
            const el = document.createElement('div');
            el.className = 'activity-marker';
            
            // Add marker to map
            activityMarker = new maplibregl.Marker({ element: el })
                .setLngLat([lon, lat])
                .addTo(map);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                removeActivityMarker();
            }, 10000);
        }

        function removeActivityMarker() {
            if (activityMarker) {
                activityMarker.remove();
                activityMarker = null;
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notification-dropdown');
            const btn = document.getElementById('notification-toggle');
            if (notificationDropdownOpen && !btn.contains(event.target)) {
                closeNotificationDropdown();
            }
        });

        // Load notifications after map is ready
        map.on('load', function() {
            // Small delay to let other things initialize
            setTimeout(loadNotifications, 1000);
        });

        
        initDateRange();

        
        let searchTimeout = null;
        let cachedAreas = null;

        function toggleSearch() {
            searchOpen = !searchOpen;
            const toolbarBtn = document.getElementById('toolbar-search');
            const panel = document.getElementById('search-panel');
            const input = document.getElementById('search-input');
            const results = document.getElementById('search-results');
            
            if (searchOpen) {
                toolbarBtn.classList.add('active');
                panel.classList.add('open');
                // Close filter panel if open
                if (filterPanelOpen) {
                    filterPanelOpen = false;
                    document.getElementById('filter-panel').classList.remove('open');
                    document.getElementById('filter-toggle').classList.remove('active');
                }
                setTimeout(() => input.focus(), 100);
            } else {
                toolbarBtn.classList.remove('active');
                panel.classList.remove('open');
                results.classList.remove('open');
                input.value = '';
                document.getElementById('search-clear').style.display = 'none';
            }
        }

        function handleSearchInput(e) {
            const query = e.target.value.trim();
            const clearBtn = document.getElementById('search-clear');
            
            clearBtn.style.display = query.length > 0 ? 'block' : 'none';
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            
            searchTimeout = setTimeout(() => searchAreas(query), 200);
        }

        async function searchAreas(query) {
            const results = document.getElementById('search-results');
            results.innerHTML = '<div class="search-loading">Searching...</div>';
            results.classList.add('open');
            
            try {
                // Search both loaded keystones and WDPA index
                const [keystonesRes, wdpaRes] = await Promise.all([
                    fetch(`/api/areas/search?q=${encodeURIComponent(query)}`),
                    fetch(`/api/wdpa/search?q=${encodeURIComponent(query)}`)
                ]);
                
                const keystones = keystonesRes.ok ? await keystonesRes.json() : [];
                const wdpaAreas = wdpaRes.ok ? await wdpaRes.json() : [];
                
                // Merge results: keystones first (loaded), then WDPA unloaded
                const loadedIds = new Set(keystones.map(k => k.name.toLowerCase()));
                const unloaded = wdpaAreas.filter(w => !loadedIds.has(w.name.toLowerCase()) && !w.loaded);
                const merged = [...keystones.map(k => ({...k, loaded: true})), ...unloaded];
                
                displaySearchResults(merged);
            } catch (err) {
                console.error('Search error:', err);
                results.innerHTML = '<div class="search-no-results">Search failed</div>';
            }
        }

        function displaySearchResults(areas) {
            const results = document.getElementById('search-results');
            
            if (areas.length === 0) {
                results.innerHTML = '<div class="search-no-results">No protected areas found</div>';
                return;
            }
            
            results.innerHTML = areas.map(area => {
                const isLoaded = area.loaded !== false;
                const itemClass = isLoaded ? 'search-result-item' : 'search-result-item unloaded';
                const badgeClass = isLoaded ? 'loaded-badge loaded' : 'loaded-badge unloaded';
                const badgeText = isLoaded ? 'loaded' : 'not loaded';
                return `
                <div class="${itemClass}" onclick="selectSearchResult(${JSON.stringify(area).replace(/"/g, '&quot;')})">
                    <div class="search-result-name">
                        <span>${escapeHtml(area.name)}</span>
                        <span class="${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="search-result-country">${escapeHtml(area.country || 'Unknown')}${area.designation ? ' • ' + escapeHtml(area.designation) : ''}</div>
                </div>
            `;
            }).join('');
        }

        function selectSearchResult(area) {
            hideSearchResults();
            document.getElementById('search-input').value = area.name;
            
            const isLoaded = area.loaded !== false;
            
            // Fly to the area (if we have coordinates)
            let targetCenter = null;
            if (area.bbox && area.bbox.length === 4) {
                map.fitBounds([
                    [area.bbox[0], area.bbox[1]], 
                    [area.bbox[2], area.bbox[3]]  
                ], { padding: 50, duration: 1500 });
                targetCenter = [(area.bbox[0] + area.bbox[2]) / 2, (area.bbox[1] + area.bbox[3]) / 2];
            } else if (area.center && area.center.length === 2) {
                map.flyTo({
                    center: area.center,
                    zoom: 10,
                    duration: 1500
                });
                targetCenter = area.center;
            }
            
            // Show popup after flying (or immediately for unloaded PAs without coords)
            if (isLoaded && targetCenter) {
                setTimeout(() => showPAPopup(area, { lng: targetCenter[0], lat: targetCenter[1] }), 800);
            } else if (!isLoaded) {
                // Show "not loaded" popup for unloaded PAs
                showUnloadedPAPopup(area, targetCenter);
            }
        }
        
        function showUnloadedPAPopup(area, coords) {
            // Close existing popup
            if (currentPAPopup) {
                currentPAPopup.remove();
                currentPAPopup = null;
            }
            
            const popupContent = `
                <div style="padding: 12px; min-width: 200px;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #888;">${escapeHtml(area.name)}</div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 12px;">
                        ${escapeHtml(area.country || 'Unknown')}
                        ${area.designation ? '<br>' + escapeHtml(area.designation) : ''}
                        ${area.area_km2 ? '<br>' + area.area_km2.toLocaleString() + ' km²' : ''}
                    </div>
                    <div style="background: rgba(128,128,128,0.15); border-radius: 6px; padding: 10px; text-align: center;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 4px;">⚠️ PA not yet in system</div>
                        <div style="font-size: 11px; color: #666;">Coordinates unavailable</div>
                    </div>
                    ${area.wdpa_id ? '<div style="margin-top: 10px; font-size: 11px; color: #555;">WDPA ID: ' + area.wdpa_id + '</div>' : ''}
                </div>
            `;
            
            // If we have coordinates, show popup at that location
            if (coords) {
                currentPAPopup = new mapboxgl.Popup({ closeOnClick: true, maxWidth: '300px' })
                    .setLngLat(coords)
                    .setHTML(popupContent)
                    .addTo(map);
            } else {
                // Show a toast notification instead
                showToast(`"${area.name}" is not yet loaded in the system. Coordinates unavailable.`, 'info');
            }
        }

        function showSearchResults() {
            const query = document.getElementById('search-input').value.trim();
            if (query.length >= 2) {
                document.getElementById('search-results').classList.add('open');
            }
        }

        function hideSearchResults() {
            document.getElementById('search-results').classList.remove('open');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').style.display = 'none';
            hideSearchResults();
            document.getElementById('search-input').focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'info' ? 'rgba(59, 130, 246, 0.95)' : 'rgba(34, 197, 94, 0.95)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 9999;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: toastFadeIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('search-panel');
            const toolbarBtn = document.getElementById('toolbar-search');
            if (panel && !panel.contains(e.target) && !toolbarBtn.contains(e.target)) {
                hideSearchResults();
            }
        });

        // Selected parks management
        let selectedParks = [];
        let selectedPAIds = new Set();  // Track PA IDs selected via bbox or clicks
        let currentPAPopup = null;
        
        function showPAPopup(props, lngLat) {
            // Close existing popup
            if (currentPAPopup) {
                currentPAPopup.remove();
            }
            
            const name = props.name || 'Protected Area';
            const country = props.country || 'Unknown';
            const areaKm2 = props.area_km2 || props.area;
            const wdpaId = props.wdpa_id || props.wdpaid;
            const paId = wdpaId || props.id;
            const isSelected = selectedParks.some(p => p.id === (wdpaId || name));
            
            const areaDisplay = areaKm2 ? formatNumber(areaKm2) + ' km²' : '--';
            
            const popupContent = `
                <div class="pa-popup">
                    <div class="pa-popup-header">
                        <div class="pa-popup-name">${escapeHtml(name)}</div>
                        <div class="pa-popup-country">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            ${escapeHtml(country)}
                        </div>
                    </div>
                    <div class="pa-popup-stats">
                        <div class="pa-popup-stat">
                            <div class="pa-popup-stat-label">Area</div>
                            <div class="pa-popup-stat-value${!areaKm2 ? ' muted' : ''}">${areaDisplay}</div>
                        </div>
                        <div class="pa-popup-stat">
                            <div class="pa-popup-stat-label">Research</div>
                            <div class="pa-popup-stat-value" id="pub-count-${paId}" style="cursor: pointer" onclick="showPublications('${paId}', '${escapeHtml(name)}')">...</div>
                        </div>
                    </div>
                    <div class="pa-popup-actions">
                        <button class="pa-popup-btn${isSelected ? ' selected' : ''}" onclick="toggleParkSelection('${escapeHtml(wdpaId || name)}', '${escapeHtml(name)}', ${JSON.stringify(props.bbox || null).replace(/"/g, "'")}, ${JSON.stringify(props.center || (lngLat ? [lngLat.lng, lngLat.lat] : null)).replace(/"/g, "'")})">
                            <svg viewBox="0 0 24 24" fill="${isSelected ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                            ${isSelected ? 'Selected' : 'Select'}
                        </button>
                        ${wdpaId ? `<a class="pa-popup-btn" href="https://www.protectedplanet.net/${wdpaId}" target="_blank" rel="noopener">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            Details
                        </a>` : ''}
                    </div>
                </div>
            `;
            
            currentPAPopup = new maplibregl.Popup({ closeButton: true, maxWidth: '300px' })
                .setLngLat(lngLat)
                .setHTML(popupContent)
                .addTo(map);
            
            // Fetch publication count
            if (paId) {
                fetchPublicationCount(paId);
            }
        }
        
        async function fetchPublicationCount(paId) {
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/publications/count`);
                const data = await resp.json();
                const el = document.getElementById(`pub-count-${paId}`);
                if (el) {
                    el.textContent = data.count > 0 ? `${data.count} papers` : '--';
                    if (data.count > 0) {
                        el.style.color = '#22c55e';
                    } else {
                        el.classList.add('muted');
                    }
                }
            } catch (e) {
                const el = document.getElementById(`pub-count-${paId}`);
                if (el) {
                    el.textContent = '--';
                    el.classList.add('muted');
                }
            }
        }
        
        async function showPublications(paId, paName) {
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/publications`);
                const pubs = await resp.json();
                
                if (!pubs || pubs.length === 0) {
                    showToast('No publications found for this area yet.', 'info');
                    return;
                }
                
                // Create modal with publications list
                let modal = document.getElementById('publications-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'publications-modal';
                    modal.className = 'modal-overlay';
                    modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('active'); };
                    document.body.appendChild(modal);
                }
                
                const pubsHtml = pubs.slice(0, 10).map(p => `
                    <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #fff;">${escapeHtml(p.title)}</div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 4px;">
                            ${p.authors ? p.authors.slice(0, 3).join(', ') + (p.authors.length > 3 ? ' et al.' : '') : ''}
                            ${p.year ? ' (' + p.year + ')' : ''}
                        </div>
                        ${p.cited_by_count ? `<div style="font-size: 11px; color: #666;">Cited by ${p.cited_by_count}</div>` : ''}
                        ${p.url ? `<a href="${p.url}" target="_blank" rel="noopener" style="font-size: 12px; color: #22c55e;">View paper →</a>` : ''}
                    </div>
                `).join('');
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 class="modal-title">Research on ${escapeHtml(paName)}</h2>
                            <button class="modal-close" onclick="document.getElementById('publications-modal').classList.remove('active')">×</button>
                        </div>
                        <div style="font-size: 13px; color: #888; margin-bottom: 16px;">Found ${pubs.length} publication${pubs.length !== 1 ? 's' : ''}</div>
                        <div>${pubsHtml}</div>
                    </div>
                `;
                
                modal.classList.add('active');
            } catch (e) {
                showToast('Failed to load publications.', 'info');
            }
        }
        
        function toggleParkSelection(id, name, bbox, center) {
            const index = selectedParks.findIndex(p => p.id === id);
            if (index >= 0) {
                selectedParks.splice(index, 1);
            } else {
                selectedParks.push({ id, name, bbox, center });
            }
            updateSelectedParksDisplay();
            // Close and reopen popup to update button state
            if (currentPAPopup) {
                currentPAPopup.remove();
            }
        }
        
        function removeSelectedPark(id) {
            selectedParks = selectedParks.filter(p => p.id !== id);
            updateSelectedParksDisplay();
        }
        
        function flyToSelectedPark(id) {
            const park = selectedParks.find(p => p.id === id);
            if (park) {
                if (park.bbox && park.bbox.length === 4) {
                    map.fitBounds([[park.bbox[0], park.bbox[1]], [park.bbox[2], park.bbox[3]]], { padding: 50, duration: 1500 });
                } else if (park.center && park.center.length === 2) {
                    map.flyTo({ center: park.center, zoom: 10, duration: 1500 });
                }
            }
        }
        
        function updateSelectedParksDisplay() {
            const container = document.getElementById('selected-parks');
            const emptyMsg = document.getElementById('selected-parks-empty');
            
            if (selectedParks.length === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
                // Remove park items but keep empty message
                const items = container.querySelectorAll('.selected-park-item');
                items.forEach(item => item.remove());
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            // Remove existing items
            const items = container.querySelectorAll('.selected-park-item');
            items.forEach(item => item.remove());
            
            // Add park items
            selectedParks.forEach(park => {
                const item = document.createElement('div');
                item.className = 'selected-park-item';
                item.innerHTML = `
                    <svg class="selected-park-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="selected-park-name" onclick="flyToSelectedPark('${park.id}')">${escapeHtml(park.name)}</span>
                    <button class="selected-park-remove" onclick="removeSelectedPark('${park.id}')" title="Remove">×</button>
                `;
                container.appendChild(item);
            });
        }
        
        // Update time filter display when slider changes
        function updateTimeFilterDisplay(startDate, endDate) {
            const filterTimeValue = document.getElementById('filter-time-value');
            if (filterTimeValue) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const start = new Date(startDate);
                const end = new Date(endDate);
                filterTimeValue.textContent = months[start.getMonth()] + ' ' + start.getFullYear() + ' - ' + months[end.getMonth()] + ' ' + end.getFullYear();
            }
        }

        // Override map click for PA areas
        map.on('load', function() {
            // Remove default click handler
            map.off('click', 'areas-fill');
            
            // Add new popup-based handler
            map.on('click', 'areas-fill', function(e) {
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    showPAPopup(props, e.lngLat);
                }
            });
        });

        // Stats panel interactivity
        let activeStatMode = null;
        let originalCirclePaint = null;

        function handleStatClick(statType) {
            const statItems = document.querySelectorAll('.stats-item');
            const clickedItem = document.getElementById('stat-' + statType);
            
            // Add pulse animation
            clickedItem.classList.add('pulsing');
            setTimeout(() => clickedItem.classList.remove('pulsing'), 600);
            
            // Toggle mode - if clicking the same stat, deactivate
            if (activeStatMode === statType) {
                deactivateStatMode();
                return;
            }
            
            // Deactivate previous mode first
            if (activeStatMode) {
                deactivateStatMode(false);
            }
            
            // Activate new mode
            activeStatMode = statType;
            statItems.forEach(item => item.classList.remove('active'));
            clickedItem.classList.add('active');
            
            // Execute stat-specific action
            switch(statType) {
                case 'pixels':
                    highlightActivePixels();
                    break;
                case 'distance':
                    showDistanceHeatmap();
                    break;
                case 'patrols':
                    zoomToPatrolCoverage();
                    break;
            }
        }

        function deactivateStatMode(resetView = true) {
            activeStatMode = null;
            document.querySelectorAll('.stats-item').forEach(item => item.classList.remove('active'));
            
            // Reset circles to original style
            resetHeatmapStyle();
            
            // Remove any highlight layers
            removeHighlightLayers();
        }

        function highlightActivePixels() {
            // Make grid cells more visible with a pulsing effect
            if (!map.getLayer('grid-cells')) return;
            
            // Store original paint if not already stored
            if (!originalCirclePaint) {
                originalCirclePaint = {
                    'circle-stroke-width': map.getPaintProperty('grid-cells', 'circle-stroke-width'),
                    'circle-stroke-color': map.getPaintProperty('grid-cells', 'circle-stroke-color')
                };
            }
            
            // Enhance visibility with white stroke for better contrast
            map.setPaintProperty('grid-cells', 'circle-stroke-color', '#ffffff');
            map.setPaintProperty('grid-cells', 'circle-stroke-width', 2.5);
            
            // Also enhance clusters
            if (map.getLayer('grid-clusters')) {
                map.setPaintProperty('grid-clusters', 'circle-stroke-color', '#ffffff');
                map.setPaintProperty('grid-clusters', 'circle-stroke-width', 3);
            }
            
            // Animate the circles with a pulsing effect
            animatePixelHighlight();
        }

        let pixelAnimationFrame = null;
        function animatePixelHighlight() {
            if (activeStatMode !== 'pixels') return;
            
            let glowOpacity = 0.4;
            let direction = -1;
            
            function pulse() {
                if (activeStatMode !== 'pixels' || !map.getLayer('grid-glow')) {
                    return;
                }
                
                glowOpacity += direction * 0.015;
                if (glowOpacity <= 0.2) direction = 1;
                if (glowOpacity >= 0.5) direction = -1;
                
                // Pulse the glow layer
                if (map.getLayer('grid-glow')) {
                    map.setPaintProperty('grid-glow', 'circle-opacity', glowOpacity);
                }
                if (map.getLayer('grid-clusters')) {
                    map.setPaintProperty('grid-clusters', 'circle-opacity', 0.5 + glowOpacity);
                }
                pixelAnimationFrame = requestAnimationFrame(pulse);
            }
            pulse();
        }

        function showDistanceHeatmap() {
            // Enhance circles to show patrol intensity with warmer colors
            if (!map.getLayer('grid-cells')) return;
            
            // Store original paint if not already stored
            if (!originalCirclePaint) {
                originalCirclePaint = {
                    'circle-opacity': map.getPaintProperty('grid-cells', 'circle-opacity'),
                    'circle-stroke-width': map.getPaintProperty('grid-cells', 'circle-stroke-width'),
                    'circle-stroke-color': map.getPaintProperty('grid-cells', 'circle-stroke-color'),
                    'circle-color': map.getPaintProperty('grid-cells', 'circle-color')
                };
            }
            
            // Use a warmer color scheme (green -> yellow -> orange -> red) for intensity
            map.setPaintProperty('grid-cells', 'circle-color', [
                'interpolate', ['linear'],
                ['coalesce', ['get', 'intensity'], 0.5],
                0, 'rgba(34, 197, 94, 0.5)',
                0.3, 'rgba(74, 222, 128, 0.7)',
                0.5, 'rgba(250, 204, 21, 0.8)',
                0.7, 'rgba(249, 115, 22, 0.9)',
                1, 'rgba(239, 68, 68, 1)'
            ]);
            
            // Enhance glow effect
            map.setPaintProperty('grid-cells', 'circle-blur', 0.3);
            map.setPaintProperty('grid-cells', 'circle-opacity', 1);
            map.setPaintProperty('grid-cells', 'circle-stroke-color', '#ffffff');
            map.setPaintProperty('grid-cells', 'circle-stroke-width', 2);
            
            // Also update clusters
            if (map.getLayer('grid-clusters')) {
                map.setPaintProperty('grid-clusters', 'circle-color', '#f97316');
                map.setPaintProperty('grid-clusters', 'circle-stroke-color', '#ffffff');
            }
        }

        async function zoomToPatrolCoverage() {
            // Zoom map to fit all patrol data
            try {
                const source = map.getSource('grid');
                if (!source) return;
                
                // Build URL with current filters
                let url = '/api/grid';
                const params = [];
                if (dateFrom) params.push('from=' + dateFrom);
                if (dateTo) params.push('to=' + dateTo);
                if (currentBbox) params.push('bbox=' + currentBbox.join(','));
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    // Calculate bounds from all features
                    let minLng = Infinity, minLat = Infinity;
                    let maxLng = -Infinity, maxLat = -Infinity;
                    
                    data.features.forEach(feature => {
                        const coords = feature.geometry.coordinates;
                        if (coords) {
                            minLng = Math.min(minLng, coords[0]);
                            maxLng = Math.max(maxLng, coords[0]);
                            minLat = Math.min(minLat, coords[1]);
                            maxLat = Math.max(maxLat, coords[1]);
                        }
                    });
                    
                    if (minLng !== Infinity) {
                        // Add some padding
                        const lngPad = (maxLng - minLng) * 0.1 || 1;
                        const latPad = (maxLat - minLat) * 0.1 || 1;
                        
                        map.fitBounds([
                            [minLng - lngPad, minLat - latPad],
                            [maxLng + lngPad, maxLat + latPad]
                        ], {
                            padding: 50,
                            duration: 1500,
                            essential: true
                        });
                    }
                }
            } catch (err) {
                console.error('Failed to zoom to patrol coverage:', err);
            }
        }

        function resetHeatmapStyle() {
            if (!map.getLayer('grid-cells')) return;
            
            // Restore original grid-cells style
            if (originalCirclePaint) {
                Object.keys(originalCirclePaint).forEach(prop => {
                    if (originalCirclePaint[prop] !== undefined) {
                        map.setPaintProperty('grid-cells', prop, originalCirclePaint[prop]);
                    }
                });
            } else {
                // Default values
                map.setPaintProperty('grid-cells', 'circle-stroke-color', '#4ade80');
                map.setPaintProperty('grid-cells', 'circle-stroke-width', 1.5);
            }
            
            // Reset glow layer
            if (map.getLayer('grid-glow')) {
                map.setPaintProperty('grid-glow', 'circle-opacity', [
                    'interpolate', ['linear'],
                    ['coalesce', ['get', 'intensity'], 0.3],
                    0, 0.15,
                    0.5, 0.25,
                    1, 0.4
                ]);
            }
            
            // Also reset clusters to original style
            if (map.getLayer('grid-clusters')) {
                map.setPaintProperty('grid-clusters', 'circle-color', '#22c55e');
                map.setPaintProperty('grid-clusters', 'circle-stroke-color', '#4ade80');
                map.setPaintProperty('grid-clusters', 'circle-stroke-width', 2);
                map.setPaintProperty('grid-clusters', 'circle-opacity', 0.7);
            }
        }

        function removeHighlightLayers() {
            // Stop animation
            if (pixelAnimationFrame) {
                cancelAnimationFrame(pixelAnimationFrame);
                pixelAnimationFrame = null;
            }
            
            // Remove highlight layer
            try {
                if (map.getLayer('grid-points-highlight')) {
                    map.removeLayer('grid-points-highlight');
                }
            } catch (e) {}
        }

        // Reset stat mode when clicking on the map (outside stats panel)
        map.on('click', function(e) {
            // Don't reset if clicking on a feature
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['areas-fill', 'grid-cells', 'grid-clusters']
            });
            if (features.length === 0 && activeStatMode) {
                // Small delay to let other click handlers run first
                setTimeout(() => {
                    if (activeStatMode) deactivateStatMode();
                }, 100);
            }
        });
    </script>

    <!-- Time Slider JavaScript -->
    <script>
    (function() {
        // Time slider configuration
        const SLIDER_START_DATE = new Date('2020-01-01');
        const SLIDER_END_DATE = new Date(); // Today
        const TOTAL_MONTHS = monthsBetween(SLIDER_START_DATE, SLIDER_END_DATE);
        
        let sliderStartValue = TOTAL_MONTHS - 12; // Default: last 12 months
        let sliderEndValue = TOTAL_MONTHS;
        
        function monthsBetween(d1, d2) {
            return (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
        }
        
        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }
        
        function formatMonthYear(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getFullYear();
        }
        
        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }
        
        function valueToDate(value) {
            return addMonths(SLIDER_START_DATE, value);
        }
        
        function updateSliderDisplay() {
            const startDate = valueToDate(sliderStartValue);
            const endDate = valueToDate(sliderEndValue);
            
            // Update date label
            document.getElementById('time-slider-date').textContent = 
                formatMonthYear(startDate) + ' - ' + formatMonthYear(endDate);
            
            // Update handle positions
            const track = document.getElementById('time-slider-track');
            const trackWidth = track.offsetWidth;
            const startPercent = (sliderStartValue / TOTAL_MONTHS) * 100;
            const endPercent = (sliderEndValue / TOTAL_MONTHS) * 100;
            
            document.getElementById('time-slider-start').style.left = startPercent + '%';
            document.getElementById('time-slider-end').style.left = endPercent + '%';
            document.getElementById('time-slider-range').style.left = startPercent + '%';
            document.getElementById('time-slider-range').style.width = (endPercent - startPercent) + '%';
        }
        
        function updateDateFilter() {
            const startDate = valueToDate(sliderStartValue);
            const endDate = valueToDate(sliderEndValue);
            
            // Update global date variables (used by existing code)
            dateFrom = formatDateISO(startDate);
            dateTo = formatDateISO(endDate);
            currentPreset = 'custom';
            
            // Update filter panel display
            if (typeof updateTimeFilterDisplay === 'function') {
                updateTimeFilterDisplay(dateFrom, dateTo);
            }
            
            // Reload data
            reloadGridData();
        }
        
        function initTicks() {
            const ticksContainer = document.getElementById('time-slider-ticks');
            ticksContainer.innerHTML = '';
            
            // Add tick for each year
            let currentDate = new Date(SLIDER_START_DATE);
            while (currentDate <= SLIDER_END_DATE) {
                const monthsFromStart = monthsBetween(SLIDER_START_DATE, currentDate);
                const percent = (monthsFromStart / TOTAL_MONTHS) * 100;
                const isJanuary = currentDate.getMonth() === 0;
                
                if (isJanuary || monthsFromStart === 0) {
                    // Year tick
                    const tick = document.createElement('div');
                    tick.className = 'time-slider-tick major';
                    tick.style.left = percent + '%';
                    tick.innerHTML = `<div class="time-slider-tick-line"></div><div class="time-slider-tick-label">${currentDate.getFullYear()}</div>`;
                    ticksContainer.appendChild(tick);
                } else if (currentDate.getMonth() === 6) {
                    // Mid-year tick (July)
                    const tick = document.createElement('div');
                    tick.className = 'time-slider-tick';
                    tick.style.left = percent + '%';
                    tick.innerHTML = `<div class="time-slider-tick-line"></div>`;
                    ticksContainer.appendChild(tick);
                }
                
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }
        
        function initSliderDrag() {
            const track = document.getElementById('time-slider-track');
            const startHandle = document.getElementById('time-slider-start');
            const endHandle = document.getElementById('time-slider-end');
            
            let activeHandle = null;
            
            function getValueFromEvent(e) {
                const rect = track.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                return Math.round(percent * TOTAL_MONTHS);
            }
            
            function onStart(e, handle) {
                e.preventDefault();
                activeHandle = handle;
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!activeHandle) return;
                e.preventDefault();
                
                const value = getValueFromEvent(e);
                
                if (activeHandle === 'start') {
                    sliderStartValue = Math.min(value, sliderEndValue - 1);
                } else {
                    sliderEndValue = Math.max(value, sliderStartValue + 1);
                }
                
                updateSliderDisplay();
            }
            
            function onEnd() {
                if (activeHandle) {
                    updateDateFilter();
                }
                activeHandle = null;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onEnd);
            }
            
            startHandle.addEventListener('mousedown', (e) => onStart(e, 'start'));
            startHandle.addEventListener('touchstart', (e) => onStart(e, 'start'));
            endHandle.addEventListener('mousedown', (e) => onStart(e, 'end'));
            endHandle.addEventListener('touchstart', (e) => onStart(e, 'end'));
            
            // Click on track to move nearest handle
            track.addEventListener('click', (e) => {
                if (e.target.classList.contains('time-slider-handle')) return;
                
                const value = getValueFromEvent(e);
                const startDist = Math.abs(value - sliderStartValue);
                const endDist = Math.abs(value - sliderEndValue);
                
                if (startDist < endDist) {
                    sliderStartValue = Math.min(value, sliderEndValue - 1);
                } else {
                    sliderEndValue = Math.max(value, sliderStartValue + 1);
                }
                
                updateSliderDisplay();
                updateDateFilter();
            });
        }
        
        // Initialize slider
        function initTimeSlider() {
            initTicks();
            initSliderDrag();
            updateSliderDisplay();
            // Set initial date filter to match slider
            updateDateFilter();
        }
        
        // Wait for DOM and map to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTimeSlider);
        } else {
            // Small delay to ensure map is loaded
            setTimeout(initTimeSlider, 100);
        }
    })();
    </script>

 
    <script>
    (function() {
        var key = '5mp_views';
        var views = parseInt(localStorage.getItem(key) || '0', 10) + 1;
        localStorage.setItem(key, views);
        document.getElementById('page-views').textContent = (views >= 1000 ? views.toLocaleString() : views) + ' views';
    })();
    </script>
</body></html>

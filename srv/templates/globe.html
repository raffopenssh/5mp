<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5MP.globe - Global Conservation Effort</title>
    <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #e0e0e0; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* Touch-friendly defaults */
        button, .btn, [onclick] { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: manipulation; }
        input, textarea { font-size: 16px; /* Prevents iOS zoom on focus */ }
        
        .header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: rgba(18,18,18,0.95); border-bottom: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 1000; backdrop-filter: blur(10px); }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600; color: #fff; }
        .logo-icon { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 28px; height: 28px; }
        .logo-subtitle { font-size: 11px; font-weight: 400; color: #888; margin-top: 2px; }
        .auth-buttons { display: flex; gap: 12px; align-items: center; }
        .user-info { color: #22c55e; font-size: 14px; }

        .btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; }
        .btn-secondary { background: rgba(255,255,255,0.08); color: #e0e0e0; border: 1px solid rgba(255,255,255,0.12); }
        .btn-secondary:hover { background: rgba(255,255,255,0.12); }
        .btn-primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; }
        .btn-primary:hover { background: linear-gradient(135deg, #16a34a, #15803d); }

        #map { position: absolute; top: 56px; left: 0; right: 0; bottom: 0; z-index: 1; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal { background: #1a1a1a; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; width: 100%; max-width: 420px; padding: 32px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-size: 20px; font-weight: 600; color: #fff; }
        .modal-close { background: none; border: none; color: #666; font-size: 24px; cursor: pointer; padding: 4px; line-height: 1; }
        .modal-close:hover { color: #fff; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 500; color: #a0a0a0; margin-bottom: 8px; }
        .form-input { width: 100%; padding: 12px 14px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; color: #fff; font-size: 14px; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #22c55e; }
        .form-input::placeholder { color: #555; }
        .form-error { color: #ef4444; font-size: 13px; margin-top: 8px; display: none; }
        .form-footer { margin-top: 24px; }
        .form-footer .btn { width: 100%; padding: 12px; }
        .form-switch { text-align: center; margin-top: 16px; font-size: 14px; color: #666; }
        .form-switch a { color: #22c55e; text-decoration: none; }
        .form-switch a:hover { text-decoration: underline; }

        .upload-area { border: 2px dashed rgba(255,255,255,0.2); border-radius: 12px; padding: 40px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 20px; }
        .upload-area:hover, .upload-area.dragover { border-color: #22c55e; background: rgba(34,197,94,0.05); }
        .upload-icon { font-size: 48px; margin-bottom: 12px; }
        .upload-text { color: #a0a0a0; font-size: 14px; }
        .upload-text strong { color: #22c55e; }

        .fab { position: fixed; bottom: 94px; right: 24px; width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; color: #fff; font-size: 24px; cursor: pointer; box-shadow: 0 4px 14px rgba(34,197,94,0.4); transition: all 0.2s; z-index: 500; display: none; align-items: center; justify-content: center; }
        .fab:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(34,197,94,0.5); }
        .fab.visible { display: flex; }
        .footer-btn { background: none; border: none; color: #888; cursor: pointer; padding: 2px 4px; display: flex; align-items: center; transition: color 0.2s; }
        .footer-btn:hover { color: #22c55e; }
        .footer-attribution { position: fixed; bottom: 75px; right: 10px; background: rgba(18,18,18,0.85); padding: 4px 10px; font-size: 10px; color: #666; z-index: 500; border-radius: 6px; display: flex; align-items: center; gap: 6px; }
        .footer-attribution a { color: #888; text-decoration: none; display: flex; align-items: center; }
        .footer-attribution a:hover { color: #22c55e; }
        .footer-sep { color: #444; }
        .github-link svg { fill: currentColor; }

        .maplibregl-ctrl-attrib { background: rgba(18,18,18,0.8) !important; }

         
        @keyframes pulse-glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stats-panel { position: fixed; top: 66px; right: 10px; background: rgba(18,18,18,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 12px 16px; z-index: 100; font-size: 12px; min-width: 140px; }
        .stats-panel h3 { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .stats-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; padding: 6px 8px; margin: 0 -8px 6px -8px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; position: relative; }
        .stats-item:last-child { margin-bottom: 0; }
        .stats-item:hover { background: rgba(34,197,94,0.1); }
        .stats-item:hover .stats-label { color: #a0a0a0; }
        .stats-item:hover .stats-value { color: #4ade80; }
        .stats-item:active { transform: scale(0.98); }
        .stats-item.active { background: rgba(34,197,94,0.2); border: 1px solid rgba(34,197,94,0.3); }
        .stats-item.active .stats-label { color: #22c55e; }
        .stats-item::after { content: ''; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); width: 4px; height: 4px; border-radius: 50%; background: transparent; transition: all 0.2s; }
        .stats-item:hover::after { background: rgba(34,197,94,0.5); }
        .stats-item.active::after { background: #22c55e; box-shadow: 0 0 6px rgba(34,197,94,0.6); }
        .stats-label { color: #888; transition: color 0.2s; }
        .stats-value { color: #22c55e; font-weight: 600; font-variant-numeric: tabular-nums; transition: color 0.2s; }
        .stats-divider { height: 1px; background: rgba(255,255,255,0.08); margin: 8px -8px; }
        .stats-header { font-size: 9px; font-weight: 600; color: #666; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding: 0 8px; }
        .stats-trend { font-size: 10px; margin-left: 4px; }
        .stats-trend.up { color: #ef4444; }
        .stats-trend.down { color: #22c55e; }
        .stats-trend.stable { color: #666; }
        .stats-trend.improving { color: #22c55e; }
        .stats-trend.worsening { color: #ef4444; }
        .stats-item.fire .stats-value { color: #f97316; }
        .stats-item.fire:hover .stats-value { color: #fb923c; }
        .stats-item.deforest .stats-value { color: #eab308; }
        .stats-item.deforest:hover .stats-value { color: #facc15; }
        .stats-item.settlement .stats-value { color: #a855f7; }
        .stats-item.settlement:hover .stats-value { color: #c084fc; }
        @keyframes stats-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .stats-item.pulsing { animation: stats-pulse 0.6s ease-in-out; }
        .maplibregl-ctrl-attrib a { color: #666 !important; }
        .page-views { margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08); font-size: 10px; color: #555; text-align: center; }

        /* Movement type toggles (in filter panel) */
        .movement-toggles { display: flex; gap: 6px; }
        .movement-toggle { flex: 1; padding: 8px 4px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #888; font-size: 14px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .movement-toggle:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        .movement-toggle.active { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.4); color: #22c55e; }
        .movement-toggle-label { font-size: 9px; display: block; margin-top: 2px; color: inherit; opacity: 0.8; }
        /* Toggle switch */
        .toggle-switch-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; margin-bottom: 10px; }
        .toggle-switch-label { font-size: 13px; color: #ccc; display: flex; align-items: center; gap: 8px; }
        .toggle-switch-label svg { width: 14px; height: 14px; color: #22c55e; }
        .toggle-switch { position: relative; width: 36px; height: 20px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.15); border-radius: 20px; transition: 0.3s; }
        .toggle-switch-slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-switch-slider { background: rgba(34,197,94,0.4); }
        .toggle-switch input:checked + .toggle-switch-slider:before { transform: translateX(16px); background: #22c55e; }

        /* Compact Keystones Toggle */
        .keystones-compact-toggle { display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: #888; font-size: 12px; cursor: pointer; transition: all 0.2s; }
        .export-btn { display: flex; align-items: center; gap: 8px; width: 100%; padding: 10px 12px; background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; color: #60a5fa; font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .export-btn:hover { background: rgba(59,130,246,0.25); border-color: rgba(59,130,246,0.5); }
        .export-btn svg { flex-shrink: 0; }
        .keystones-compact-toggle:hover { background: rgba(255,255,255,0.12); border-color: rgba(255,255,255,0.2); }
        .keystones-compact-toggle.active { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.3); color: #22c55e; }

        /* Notification Button and Dropdown */
        .notification-btn { position: relative; }
        .notification-badge { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: badge-pulse 2s ease-out infinite; }
        .notification-badge.hidden { display: none; }
        @keyframes badge-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(34,197,94,0.4); } 50% { box-shadow: 0 0 0 4px rgba(34,197,94,0); } }
        .notification-dropdown { position: absolute; top: 100%; left: 0; margin-top: 8px; width: 300px; background: rgba(18,18,18,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 200; backdrop-filter: blur(10px); box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: none; overflow: hidden; }
        .notification-dropdown.open { display: block; }
        .notification-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .notification-title { font-size: 12px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 6px; }
        .notification-title svg { width: 14px; height: 14px; color: #22c55e; }
        .notification-close { background: none; border: none; color: #666; cursor: pointer; font-size: 18px; padding: 2px 6px; line-height: 1; }
        .notification-close:hover { color: #fff; }
        .notification-list { max-height: 280px; overflow-y: auto; }
        .notification-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: background 0.2s; }
        .notification-item:hover { background: rgba(255,255,255,0.05); }
        .notification-item:last-child { border-bottom: none; }
        .notification-icon { width: 28px; height: 28px; background: rgba(34,197,94,0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 12px; }
        .notification-content { flex: 1; min-width: 0; }
        .notification-location { font-size: 13px; color: #fff; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .notification-details { font-size: 11px; color: #888; margin-top: 2px; }
        .notification-empty { padding: 24px; text-align: center; color: #666; font-size: 13px; }

        /* Activity highlight marker on map */
        .activity-marker { width: 24px; height: 24px; background: rgba(34,197,94,0.3); border: 2px solid #22c55e; border-radius: 50%; position: relative; }
        .activity-marker::after { content: ''; position: absolute; inset: -8px; border: 2px solid rgba(34,197,94,0.5); border-radius: 50%; animation: marker-pulse 1.5s ease-out infinite; }
        @keyframes marker-pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
        @keyframes toastFadeIn { from { opacity: 0; transform: translateX(-50%) translateY(20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        @keyframes toastFadeOut { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(20px); } }

        /* Upload success toast - clickable */
        .upload-toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(34, 197, 94, 0.95); color: white; padding: 14px 20px; border-radius: 10px; font-size: 14px; z-index: 9999; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: toastFadeIn 0.3s ease; cursor: pointer; display: flex; align-items: center; gap: 12px; max-width: 90vw; }
        .upload-toast:hover { background: rgba(34, 197, 94, 1); transform: translateX(-50%) scale(1.02); }
        .upload-toast-icon { font-size: 20px; }
        .upload-toast-content { flex: 1; }
        .upload-toast-title { font-weight: 600; margin-bottom: 2px; }
        .upload-toast-subtitle { font-size: 12px; opacity: 0.9; }
        .upload-toast-action { background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; white-space: nowrap; }
        .upload-toast-close { position: absolute; top: 6px; right: 8px; background: none; border: none; color: rgba(255,255,255,0.7); font-size: 16px; cursor: pointer; padding: 2px 6px; line-height: 1; }
        .upload-toast-close:hover { color: white; }

        /* Upload highlight layer */
        @keyframes uploadHighlightPulse { 0%, 100% { opacity: 0.8; } 50% { opacity: 0.5; } }

        @media (max-width: 768px) {
            .notification-dropdown { left: auto; right: -10px; width: calc(100vw - 40px); max-width: 300px; }
        }

        /* Time Slider - Google Timelapse Style */
        .time-slider-container { position: fixed; bottom: 0; left: 0; right: 0; height: 70px; background: linear-gradient(to top, rgba(10,10,10,0.95) 0%, rgba(10,10,10,0.9) 70%, transparent 100%); z-index: 400; padding: 8px 20px 12px; display: flex; flex-direction: column; }
        .time-slider-header { margin-bottom: 6px; }
        .time-slider-date { font-size: 14px; font-weight: 600; color: #22c55e; }
        .time-slider-track-wrapper { position: relative; flex: 1; padding: 0 8px; }
        .time-slider-track { position: relative; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; cursor: pointer; }
        .time-slider-range { position: absolute; height: 100%; background: linear-gradient(90deg, rgba(34,197,94,0.6), #22c55e); border-radius: 3px; pointer-events: none; }
        .time-slider-handle { position: absolute; top: 50%; width: 16px; height: 16px; background: #22c55e; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%, -50%); cursor: grab; z-index: 2; transition: transform 0.1s, box-shadow 0.1s; }
        .time-slider-handle:hover { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 10px rgba(34,197,94,0.5); }
        .time-slider-handle:active { cursor: grabbing; }
        .time-slider-ticks { position: relative; height: 20px; margin-top: 4px; }
        .time-slider-tick { position: absolute; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; }
        .time-slider-tick-line { width: 1px; height: 6px; background: rgba(255,255,255,0.2); }
        .time-slider-tick-label { font-size: 9px; color: #555; margin-top: 2px; white-space: nowrap; }
        .time-slider-tick.major .time-slider-tick-line { height: 8px; background: rgba(255,255,255,0.4); }
        .time-slider-tick.major .time-slider-tick-label { font-size: 10px; color: #888; }

        /* Adjust map and legend for slider */
        #map { bottom: 70px !important; }
        #map-legend { bottom: 10px !important; }
 

        @media (max-width: 768px) {
            .time-slider-container { height: 60px; padding: 6px 12px 10px; }
            .time-slider-date { font-size: 12px; }
            #map { bottom: 60px !important; }
            /* Larger touch targets for slider handles */
            .time-slider-handle { width: 20px; height: 20px; }
            .time-slider-track { height: 8px; }
        }

         
         
        .map-toolbar { position: fixed; top: 66px; left: 10px; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-flex-direction: column; flex-direction: column; gap: 8px; z-index: 150; }
        .toolbar-btn { width: 44px; height: 44px; min-width: 44px; min-height: 44px; background: rgba(18,18,18,0.9); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: center; -webkit-justify-content: center; justify-content: center; -webkit-transition: all 0.2s; transition: all 0.2s; padding: 0; }
        .toolbar-btn:hover { background: rgba(30,30,30,0.95); border-color: rgba(255,255,255,0.2); }
        .toolbar-btn svg { width: 20px; height: 20px; color: #a0a0a0; }
        .toolbar-btn:hover svg { color: #22c55e; }
        .toolbar-btn.active { background: rgba(34,197,94,0.15); border-color: #22c55e; }
        .toolbar-btn.active svg { color: #22c55e; }
        .toolbar-btn:focus { outline: none; border-color: #22c55e; }
        .toolbar-btn[disabled] { opacity: 0.5; cursor: not-allowed; }
        .toolbar-separator { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

         
        .filter-panel { position: fixed; top: 66px; left: 62px; width: 260px; max-width: calc(100vw - 80px); background: rgba(18,18,18,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 140; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); -webkit-transform: translateX(-320px); transform: translateX(-320px); opacity: 0; -webkit-transition: all 0.3s ease; transition: all 0.3s ease; pointer-events: none; max-height: calc(100vh - 80px); overflow-y: auto; }
        .filter-panel.open { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; pointer-events: auto; }
        .filter-panel-header { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .filter-panel-title { font-size: 14px; font-weight: 600; color: #fff; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; gap: 8px; }
        .filter-panel-title svg { width: 16px; height: 16px; color: #22c55e; }
        .filter-panel-close { background: none; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px; line-height: 1; }
        .filter-panel-close:hover { color: #fff; }
        .filter-panel-content { padding: 16px; }

        .filter-section { margin-bottom: 20px; }
        .filter-section:last-child { margin-bottom: 0; }
        .filter-section-label { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }

        /* Country search */
        .country-search-wrapper { position: relative; }
        .country-search-input { width: 100%; padding: 10px 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: #e0e0e0; font-size: 13px; transition: all 0.2s; }
        .country-search-input:hover { border-color: rgba(255,255,255,0.2); background-color: rgba(255,255,255,0.08); }
        .country-search-input:focus { outline: none; border-color: #22c55e; }
        .country-search-input::placeholder { color: #666; }
        .country-search-results { position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: rgba(26,26,26,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; margin-top: 4px; z-index: 10; display: none; }
        .country-search-results.open { display: block; }
        .country-search-item { padding: 10px 12px; cursor: pointer; font-size: 13px; color: #e0e0e0; border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.15s; }
        .country-search-item:last-child { border-bottom: none; }
        .country-search-item:hover { background: rgba(34,197,94,0.15); }
        .country-selected { display: flex; align-items: center; justify-content: space-between; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 6px; padding: 8px 10px; margin-top: 8px; font-size: 12px; }
        .country-selected-name { color: #22c55e; font-weight: 500; }
        .country-selected-clear { background: none; border: none; color: #666; cursor: pointer; font-size: 16px; padding: 0 4px; line-height: 1; }
        .country-selected-clear:hover { color: #fff; }



        .activity-section { margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 12px; }
        .activity-header { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between; cursor: pointer; padding: 4px 0; }
        .activity-header:hover .activity-title { color: #fff; }
        .activity-title { font-size: 11px; font-weight: 600; color: #a0a0a0; text-transform: uppercase; letter-spacing: 0.5px; -webkit-transition: color 0.2s; transition: color 0.2s; }
        .activity-toggle { width: 16px; height: 16px; color: #666; -webkit-transition: -webkit-transform 0.2s; transition: transform 0.2s; }
        .activity-toggle.expanded { -webkit-transform: rotate(180deg); transform: rotate(180deg); }
        .activity-list { max-height: 0; overflow: hidden; -webkit-transition: max-height 0.3s ease; transition: max-height 0.3s ease; }
        .activity-list.expanded { max-height: 300px; }
        .activity-item { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04); font-size: 11px; color: #888; }
        .activity-item:last-child { border-bottom: none; }
        .activity-date { color: #666; }
        .activity-location { color: #a0a0a0; }
        .activity-distance { color: #22c55e; font-weight: 500; float: right; }
        .activity-more { padding: 8px 0; text-align: center; font-size: 11px; color: #22c55e; cursor: pointer; }
        .activity-more:hover { text-decoration: underline; }
        .activity-empty { padding: 12px 0; text-align: center; font-size: 11px; color: #555; }

         
        .bbox-draw-overlay { position: fixed; top: 56px; left: 0; right: 0; bottom: 0; z-index: 200; cursor: crosshair; display: none; }
        .bbox-draw-overlay.active { display: block; }
        .bbox-draw-rect { position: absolute; border: 2px dashed #60a5fa; background: rgba(59,130,246,0.1); pointer-events: none; }
        .bbox-draw-hint { position: fixed; top: 70px; left: 50%; -webkit-transform: translateX(-50%); transform: translateX(-50%); background: rgba(18,18,18,0.95); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; padding: 10px 16px; font-size: 13px; color: #60a5fa; z-index: 210; display: none; }
        .bbox-draw-hint.active { display: block; }

         /* Search Panel */
        .search-panel { position: fixed; top: 66px; left: 62px; width: 280px; max-width: calc(100vw - 80px); background: rgba(18,18,18,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; z-index: 140; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); -webkit-transform: translateX(-340px); transform: translateX(-340px); opacity: 0; -webkit-transition: all 0.3s ease; transition: all 0.3s ease; pointer-events: none; max-height: calc(100vh - 80px); overflow-y: auto; }
        .search-panel.open { -webkit-transform: translateX(0); transform: translateX(0); opacity: 1; pointer-events: auto; }
        .search-panel-header { display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; -webkit-box-pack: justify; -webkit-justify-content: space-between; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .search-panel-title { font-size: 14px; font-weight: 600; color: #fff; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; gap: 8px; }
        .search-panel-title svg { width: 16px; height: 16px; color: #22c55e; }
        .search-panel-close { background: none; border: none; color: #666; font-size: 20px; cursor: pointer; padding: 4px; line-height: 1; }
        .search-panel-close:hover { color: #fff; }
        .search-panel-content { padding: 16px; }
        .search-input-wrapper { position: relative; display: -webkit-box; display: -webkit-flex; display: flex; -webkit-box-align: center; -webkit-align-items: center; align-items: center; }
        .search-input { width: 100%; padding: 10px 36px 10px 14px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #e0e0e0; font-size: 14px; -webkit-transition: all 0.2s; transition: all 0.2s; }
        .search-input:focus { outline: none; border-color: #22c55e; background: rgba(255,255,255,0.08); }
        .search-input::-webkit-input-placeholder { color: #666; }
        .search-input::placeholder { color: #666; }
        .search-clear { position: absolute; right: 10px; background: none; border: none; color: #666; font-size: 18px; cursor: pointer; padding: 0; line-height: 1; min-width: 24px; min-height: 24px; }
        .search-clear:hover { color: #fff; }
        .search-results { width: 100%; max-height: 320px; overflow-y: auto; background: rgba(26,26,26,0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-top: 12px; display: none; -webkit-box-shadow: 0 10px 40px rgba(0,0,0,0.5); box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .search-results.open { display: block; }
        .search-result-item { padding: 12px 14px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.06); -webkit-transition: background 0.15s; transition: background 0.15s; min-height: 44px; }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(34,197,94,0.1); }
        .search-result-item.unloaded { opacity: 0.7; }
        .search-result-item.unloaded:hover { background: rgba(128,128,128,0.15); }
        .search-result-name { font-size: 14px; color: #fff; margin-bottom: 2px; display: flex; align-items: center; gap: 8px; }
        .search-result-name .loaded-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 500; }
        .search-result-name .loaded-badge.loaded { background: rgba(34,197,94,0.2); color: #22c55e; }
        .search-result-name .loaded-badge.unloaded { background: rgba(128,128,128,0.2); color: #888; }
        .search-result-country { font-size: 12px; color: #888; }
        .search-no-results { padding: 16px 14px; text-align: center; color: #666; font-size: 13px; }
        .search-loading { padding: 16px 14px; text-align: center; color: #888; font-size: 13px; }

        /* Active Filters Display */
        .active-filters { margin-bottom: 16px; }
        .active-filter-item { display: flex; align-items: center; justify-content: space-between; background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); border-radius: 6px; padding: 8px 10px; margin-bottom: 8px; font-size: 12px; }
        .active-filter-item.area { background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.2); }
        .active-filter-item.area .filter-item-icon { color: #60a5fa; }
        .active-filter-item.area .filter-item-value { color: #93c5fd; }
        .active-filter-item.park { background: rgba(168,85,247,0.1); border-color: rgba(168,85,247,0.2); }
        .active-filter-item.park .filter-item-icon { color: #a855f7; }
        .active-filter-item.park .filter-item-value { color: #c4b5fd; }
        .filter-item-content { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; }
        .filter-item-icon { width: 14px; height: 14px; color: #22c55e; flex-shrink: 0; }
        .filter-item-label { color: #888; font-size: 10px; text-transform: uppercase; }
        .filter-item-value { color: #22c55e; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .filter-item-clear { background: none; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 2px 4px; line-height: 1; flex-shrink: 0; }
        .filter-item-clear:hover { color: #fff; }

        /* Selected Parks */
        .selected-parks { margin-top: 12px; }
        .selected-parks-empty { font-size: 11px; color: #555; text-align: center; padding: 12px; }
        .selected-park-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.15); border-radius: 6px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s; }
        .selected-park-item:hover { background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); }
        .selected-park-item:last-child { margin-bottom: 0; }
        .selected-park-icon { width: 16px; height: 16px; color: #a855f7; flex-shrink: 0; }
        .selected-park-name { flex: 1; font-size: 12px; color: #e0e0e0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .selected-park-remove { background: none; border: none; color: #666; cursor: pointer; font-size: 14px; padding: 2px; line-height: 1; }
        .selected-park-remove:hover { color: #ef4444; }

        /* PA Popup Tooltip (map popup style) */
        .maplibregl-popup-content { background: rgba(18,18,18,0.95) !important; border: 1px solid rgba(255,255,255,0.1) !important; border-radius: 8px !important; padding: 0 !important; box-shadow: 0 10px 40px rgba(0,0,0,0.5) !important; min-width: 220px; max-width: 280px; }
        .maplibregl-popup-tip { border-top-color: rgba(18,18,18,0.95) !important; }
        .maplibregl-popup-close-button { color: #666 !important; font-size: 18px !important; padding: 4px 8px !important; }
        .maplibregl-popup-close-button:hover { color: #fff !important; background: transparent !important; }
        .pa-popup { padding: 12px; max-height: 400px; overflow-y: auto; }
        .pa-popup-header { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .pa-popup-name { font-size: 14px; font-weight: 600; color: #fff; margin-bottom: 4px; }
        .pa-popup-country { font-size: 11px; color: #888; display: flex; align-items: center; gap: 4px; }
        .pa-popup-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .pa-popup-stat { background: rgba(255,255,255,0.04); border-radius: 4px; padding: 8px; }
        .pa-popup-stat-label { font-size: 9px; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        .pa-popup-stat-value { font-size: 13px; color: #22c55e; font-weight: 600; }
        .pa-popup-stat-value.muted { color: #888; }
        .pa-popup-actions { display: flex; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.08); }
        .pa-popup-btn { flex: 1; padding: 6px 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: #a0a0a0; font-size: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 4px; }
        .pa-popup-btn:hover { background: rgba(34,197,94,0.15); border-color: rgba(34,197,94,0.3); color: #22c55e; }
        .pa-popup-btn svg { width: 12px; height: 12px; }
        .pa-popup-btn.selected { background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); color: #a855f7; }

        /* Enhanced PA Popup with Collapsible Sections */
        .pa-popup-section { margin-top: 8px; border: 1px solid rgba(255,255,255,0.08); border-radius: 4px; overflow: hidden; }
        .pa-popup-section-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: rgba(255,255,255,0.03); cursor: pointer; transition: background 0.2s; }
        .pa-popup-section-header:hover { background: rgba(255,255,255,0.06); }
        .pa-popup-section-title { font-size: 10px; color: #888; text-transform: uppercase; display: flex; align-items: center; gap: 6px; }
        .pa-popup-section-icon { font-size: 12px; }
        .pa-popup-section-toggle { font-size: 10px; color: #555; transition: transform 0.2s; }
        .pa-popup-section.open .pa-popup-section-toggle { transform: rotate(180deg); }
        .pa-popup-section-content { display: none; padding: 8px 10px; border-top: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); }
        .pa-popup-section.open .pa-popup-section-content { display: block; }
        .pa-popup-section-loading { font-size: 10px; color: #666; }
        .pa-popup-section-empty { font-size: 10px; color: #555; font-style: italic; }
        .pa-popup-mini-stat { display: flex; justify-content: space-between; padding: 3px 0; font-size: 11px; }
        .pa-popup-mini-stat-label { color: #666; }
        .pa-popup-mini-stat-value { color: #22c55e; font-weight: 500; }
        .pa-popup-mini-stat-value.warning { color: #f97316; }
        .pa-popup-mini-stat-value.bad { color: #ef4444; }
        .pa-popup-mini-stat-value.muted { color: #555; }
        .pa-popup-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .pa-popup-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
        .pa-popup-bar-fill.good { background: #22c55e; }
        .pa-popup-bar-fill.warning { background: #f97316; }
        .pa-popup-bar-fill.bad { background: #ef4444; }

        /* Fire Stats Modal */
        .fire-stats-container { padding: 20px; }
        .fire-stats-title { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .fire-stats-subtitle { font-size: 12px; color: #888; margin-bottom: 16px; }
        .fire-stats-divider { border: none; border-top: 1px solid rgba(255,255,255,0.1); margin: 16px 0; }
        .fire-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .fire-stat-card { background: rgba(255,255,255,0.04); border-radius: 8px; padding: 12px; border: 1px solid rgba(255,255,255,0.06); }
        .fire-stat-card.full-width { grid-column: span 2; }
        .fire-stat-label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .fire-stat-value { font-size: 20px; font-weight: 700; color: #fff; }
        .fire-stat-value.good { color: #22c55e; }
        .fire-stat-value.warning { color: #f97316; }
        .fire-stat-value.bad { color: #ef4444; }
        .fire-stat-detail { font-size: 11px; color: #666; margin-top: 4px; }
        .fire-stat-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .fire-stat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }
        .fire-stat-bar-fill.good { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .fire-stat-bar-fill.warning { background: linear-gradient(90deg, #f97316, #ea580c); }
        .fire-stat-bar-fill.bad { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .fire-stats-empty { text-align: center; padding: 40px 20px; color: #666; }
        .fire-stats-empty-icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
        .fire-stats-empty-text { font-size: 14px; }

         
        @media (max-width: 768px) {
            .header { padding: 0 12px; height: 52px; }
            .logo-subtitle { display: none; }
            .logo-icon { width: 28px; height: 28px; }
            
            /* Toolbar moves to bottom horizontal layout */
            .map-toolbar { top: auto; bottom: 80px; left: 10px; -webkit-flex-direction: row; flex-direction: row; gap: 6px; }
            .toolbar-btn { width: 40px; height: 40px; min-width: 40px; min-height: 40px; }
            
            /* Panels slide up from bottom */
            .filter-panel { top: auto; bottom: 140px; left: 10px; width: calc(100vw - 20px); max-width: none; -webkit-transform: translateY(400px); transform: translateY(400px); max-height: 50vh; }
            .filter-panel.open { -webkit-transform: translateY(0); transform: translateY(0); }
            .search-panel { top: auto; bottom: 140px; left: 10px; width: calc(100vw - 20px); max-width: none; -webkit-transform: translateY(400px); transform: translateY(400px); max-height: 50vh; }
            .search-panel.open { -webkit-transform: translateY(0); transform: translateY(0); }
            
            /* Stats panel - compact grid at top */
            .stats-panel { top: 58px; bottom: auto; right: 10px; left: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px 8px; padding: 8px 12px; min-width: auto; }
            .stats-header { display: none; }
            .stats-divider { display: none; }
            .stats-item { text-align: center; padding: 4px 0; margin: 0; }
            .stats-label { font-size: 9px; }
            .stats-value { font-size: 14px; }
            .stats-trend { font-size: 8px; }
            
            /* Legend repositioned to avoid toolbar */
            #map-legend { bottom: 140px !important; left: 10px; max-width: calc(100vw - 80px); font-size: 11px; padding: 10px 12px; }
            
            /* FAB button */
            .fab { bottom: 80px; right: 10px; width: 48px; height: 48px; font-size: 20px; }
            
            /* Auth buttons */
            .auth-buttons .btn { padding: 6px 12px; font-size: 13px; min-height: 36px; }
            
            /* Modals - full width on mobile */
            .modal { max-width: calc(100vw - 32px); padding: 24px 20px; max-height: 90vh; overflow-y: auto; }
            .modal-title { font-size: 18px; }
            
            /* Popups - constrain width */
            .maplibregl-popup-content { min-width: 180px; max-width: calc(100vw - 40px) !important; }
            .pa-popup { padding: 10px; }
            .pa-popup-name { font-size: 13px; }
            .pa-popup-stats { gap: 6px; }
            .pa-popup-stat { padding: 6px; }
            .pa-popup-stat-value { font-size: 12px; }
            
            /* Map controls - reposition to not overlap */
            .maplibregl-ctrl-top-right { top: 110px !important; right: 10px !important; }
            .maplibregl-ctrl-group button { width: 36px; height: 36px; }
            
            /* Fire stats modal */
            .fire-stats-grid { grid-template-columns: 1fr; }
            .fire-stat-card.full-width { grid-column: span 1; }
            
            /* Touch-friendly inputs */
            .search-input { padding: 12px 40px 12px 14px; font-size: 16px; /* Prevents zoom on iOS */ }
            .search-clear { min-width: 36px; min-height: 36px; }
            .search-result-item { padding: 14px; min-height: 48px; }
        }
        
        @media (max-width: 480px) {
            .logo span { font-size: 14px; }
            .auth-buttons .btn { padding: 6px 10px; font-size: 12px; }
            
            /* Even more compact stats */
            .stats-panel { padding: 6px 8px; gap: 2px 4px; grid-template-columns: repeat(3, 1fr); }
            .stats-label { font-size: 8px; }
            .stats-value { font-size: 11px; }
            .stats-trend { font-size: 7px; }
            
            /* Smaller toolbar buttons */
            .toolbar-btn { width: 36px; height: 36px; min-width: 36px; min-height: 36px; }
            .toolbar-btn svg { width: 16px; height: 16px; }
            
            /* Legend even more compact */
            #map-legend { padding: 8px 10px; font-size: 10px; }
            
            /* Panels take full width */
            .filter-panel, .search-panel { left: 5px; width: calc(100vw - 10px); }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <ellipse cx="12" cy="12" rx="4" ry="10"></ellipse>
                    <path d="M2 12h20"></path>
                    <path d="M4.5 6.5h15"></path>
                    <path d="M4.5 17.5h15"></path>
                </svg>
            </div>
            <div>
                <span>5MP.globe</span>
                <div class="logo-subtitle">Global Conservation Effort</div>
            </div>
        </div>
        
        <div class="auth-buttons">
            
            <button class="btn btn-secondary" onclick="showModal('login')">Login</button>
            <button class="btn btn-primary" onclick="showModal('register')">Register</button>
            
        </div>
    </header>



    <div id="map"></div>

    <div class="stats-panel">
        <div class="stats-header">Patrol Activity</div>
        <div class="stats-item" id="stat-pixels" onclick="handleStatClick('pixels')" title="Click to highlight active grid cells">
            <span class="stats-label">Active Pixels</span>
            <span class="stats-value" id="stats-pixels">15</span>
        </div>
        <div class="stats-item" id="stat-distance" onclick="handleStatClick('distance')" title="Click to show patrol intensity">
            <span class="stats-label">Total Distance</span>
            <span class="stats-value" id="stats-distance">1,980.8 km</span>
        </div>
        <div class="stats-item" id="stat-patrols" onclick="handleStatClick('patrols')" title="Click to zoom to patrol coverage">
            <span class="stats-label">Total Patrols</span>
            <span class="stats-value" id="stats-patrols">80</span>
        </div>
        <div class="stats-divider"></div>
        <div class="stats-header">Conservation Data</div>
        <div class="stats-item fire" id="stat-fires" title="Fire detections in selected period">
            <span class="stats-label">Fire Activity</span>
            <span class="stats-value"><span id="stats-fires">0</span><span class="stats-trend stable" id="stats-fire-trend"></span></span>
        </div>
        <div class="stats-item deforest" id="stat-deforest" title="Total forest loss in selected period">
            <span class="stats-label">Deforestation</span>
            <span class="stats-value"><span id="stats-deforest">0 km²</span><span class="stats-trend stable" id="stats-deforest-trend"></span></span>
        </div>
        <div class="stats-item settlement" id="stat-settlements" title="Total settlements across all parks">
            <span class="stats-label">Settlements</span>
            <span class="stats-value" id="stats-settlements">0</span>
        </div>
    </div>

    
    <div class="map-toolbar" id="map-toolbar">
        
        <button class="toolbar-btn active" id="filter-toggle" onclick="toggleFilterPanel()" title="Filters">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        </button>
        
        <button class="toolbar-btn" id="toolbar-search" onclick="toggleSearch()" title="Search">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
        
        <button class="toolbar-btn" id="bbox-toggle" onclick="startBboxSelection()" title="Select Area">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
            </svg>
        </button>
        <div class="toolbar-separator"></div>
        <button class="toolbar-btn notification-btn" id="notification-toggle" onclick="toggleNotificationDropdown()" title="Recent Activity">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            <span class="notification-badge hidden" id="notification-badge"></span>
            
            <!-- Notification Dropdown -->
            <div class="notification-dropdown" id="notification-dropdown">
                <div class="notification-header">
                    <div class="notification-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        Recent Activity
                    </div>
                    <button class="notification-close" onclick="closeNotificationDropdown(event)">&times;</button>
                </div>
                <div class="notification-list" id="notification-list">
                    <div class="notification-empty">Loading...</div>
                </div>
            </div>
        </button>
    </div>

    
    <div class="bbox-draw-overlay" id="bbox-draw-overlay"></div>
    <div class="bbox-draw-hint" id="bbox-draw-hint">Click and drag to select area. Press ESC to cancel.</div>

    
    <div class="filter-panel open" id="filter-panel">
        <div class="filter-panel-header">
            <div class="filter-panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                </svg>
                Active Filters
            </div>
            <button class="filter-panel-close" onclick="toggleFilterPanel()">×</button>
        </div>
        <div class="filter-panel-content">
            <!-- Active Filters -->
            <div class="active-filters" id="active-filters">
                <!-- Selected Area Filter (hidden by default) -->
                <div class="active-filter-item area" id="filter-area" style="display: none;">
                    <div class="filter-item-content">
                        <svg class="filter-item-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        </svg>
                        <div>
                            <div class="filter-item-label">Selected Area</div>
                            <div class="filter-item-value" id="filter-area-value">Custom region</div>
                        </div>
                    </div>
                    <button class="filter-item-clear" onclick="clearBbox()" title="Clear">×</button>
                </div>
            </div>
            
            <!-- Country Search with Bbox -->
            <div class="filter-section">
                <div class="filter-section-label">Country</div>
                <div class="country-search-wrapper">
                    <input type="text" class="country-search-input" id="country-search" placeholder="Search country..." autocomplete="off">
                    <div class="country-search-results" id="country-search-results"></div>
                </div>
                <div class="country-selected" id="country-selected" style="display: none;">
                    <span class="country-selected-name" id="country-selected-name"></span>
                    <button class="country-selected-clear" onclick="clearCountrySearch()" title="Clear">×</button>
                </div>
            </div>

            <!-- Movement Type Toggles -->
            <div class="filter-section">
                <div class="filter-section-label">Movement Type</div>
                <div class="movement-toggles">
                    <button class="movement-toggle active" id="toggle-foot" onclick="toggleMovementType('foot')" title="Foot patrols">Foot</button>
                    <button class="movement-toggle active" id="toggle-vehicle" onclick="toggleMovementType('vehicle')" title="Vehicle patrols">Vehicle</button>
                    <button class="movement-toggle active" id="toggle-aerial" onclick="toggleMovementType('aerial')" title="Aerial patrols">Aerial</button>
                </div>
            </div>
            
            <!-- Selected Parks -->
            <div class="filter-section">
                <div class="filter-section-label">Selected Parks</div>
                <button class="keystones-compact-toggle active" id="keystones-toggle-btn" onclick="toggleKeystonesBtn()" title="Toggle 162 Keystones visibility">
                    <span style="font-size: 14px;">▣</span> <span>162</span>
                </button>
                <input type="checkbox" id="keystones-toggle" checked style="display:none;">
                <div class="selected-parks" id="selected-parks">

                </div>
            </div>
            
            <!-- Export Section -->
            <div class="filter-section">
                <div class="filter-section-label">Export Data</div>
                <button class="export-btn" onclick="exportParksCSV()" title="Export park data as CSV">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export Parks CSV
                </button>
            </div>
            
            <!-- Hidden inputs for compatibility -->
            <input type="hidden" id="date-from">
            <input type="hidden" id="date-to">
            <div id="bbox-info" style="display:none;"></div>
            <div id="bbox-coords" style="display:none;"></div>

        </div>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" id="search-panel">
        <div class="search-panel-header">
            <div class="search-panel-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Search Protected Areas
            </div>
            <button class="search-panel-close" onclick="toggleSearch()">×</button>
        </div>
        <div class="search-panel-content">
            <div class="search-input-wrapper">
                <input type="text" class="search-input" id="search-input" placeholder="Search protected areas..." autocomplete="off" onkeyup="handleSearchInput(event)" onfocus="showSearchResults()">
                <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">×</button>
            </div>
            <div class="search-results" id="search-results"></div>
        </div>
    </div>

    <button class="fab " onclick="showModal('upload')" title="Upload Data">+</button>

    <!-- Time Slider -->
    <div class="time-slider-container" id="time-slider-container">
        <div class="time-slider-header">
            <div class="time-slider-date" id="time-slider-date">Jan 2020 - Dec 2024</div>
        </div>
        <div class="time-slider-track-wrapper">
            <div class="time-slider-track" id="time-slider-track">
                <div class="time-slider-range" id="time-slider-range"></div>
                <div class="time-slider-handle start" id="time-slider-start" data-handle="start" role="slider" aria-label="Start date" tabindex="0"></div>
                <div class="time-slider-handle end" id="time-slider-end" data-handle="end" role="slider" aria-label="End date" tabindex="0"></div>
            </div>
            <div class="time-slider-ticks" id="time-slider-ticks"></div>
        </div>
    </div>

    <!-- Footer attribution bar with buttons -->
    <div class="footer-attribution">
        <span id="page-views-footer">0 views</span>
        <span class="footer-sep">|</span>
        <span>v0.70</span>
        <span class="footer-sep">|</span>
        <a href="https://github.com/raffopenssh/5mp" target="_blank" title="View on GitHub" class="github-link">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
        </a>
        <span class="footer-sep">|</span>
        <a href="https://maplibre.org/" target="_blank" class="maplibre-link">MapLibre</a>
        <span class="footer-sep">|</span>
        <button class="footer-btn" onclick="shareCurrentView()" title="Copy link">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
            </svg>
        </button>
        <button class="footer-btn" onclick="showModal('manifest')" title="About 5MP">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 16v-4"></path>
                <path d="M12 8h.01"></path>
            </svg>
        </button>
    </div>

    
    <div id="modal-login" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Welcome Back</h2>
                <button class="modal-close" onclick="closeModal('login')">×</button>
            </div>
            <form id="form-login" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" placeholder="you@example.com" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" placeholder="••••••••" required="">
                </div>
                <div class="form-error" id="login-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Sign In</button>
                </div>
                <p class="form-switch">Don't have an account? <a href="#" onclick="switchModal('login', 'register')">Register</a></p>
            </form>
        </div>
    </div>

    
    <div id="modal-register" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create Account</h2>
                <button class="modal-close" onclick="closeModal('register')">×</button>
            </div>
            <form id="form-register" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-input" placeholder="you@example.com" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" name="password" class="form-input" placeholder="••••••••" minlength="8" required="">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" name="confirm" class="form-input" placeholder="••••••••" required="">
                </div>
                <div class="form-error" id="register-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Create Account</button>
                </div>
                <p class="form-switch">Already have an account? <a href="#" onclick="switchModal('register', 'login')">Sign in</a></p>
            </form>
        </div>
    </div>

    
    <div id="modal-upload" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Upload Conservation Data</h2>
                <button class="modal-close" onclick="closeModal('upload')">×</button>
            </div>
            <form id="form-upload" onsubmit="handleUpload(event)">
                <div class="upload-area" onclick="document.getElementById('file-input').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <div class="upload-icon">◉</div>
                    <p class="upload-text">Drag &amp; drop GPX files here, or <strong>browse</strong></p>
                    <p class="upload-text" style="margin-top: 8px; font-size: 12px;">GPS patrol track files (.gpx)</p>
                </div>
                <input type="file" id="file-input" name="files" accept=".gpx" multiple="" style="display: none;" onchange="updateFileName(this)">
                <div id="selected-file" style="margin-bottom: 16px; color: #22c55e; font-size: 14px;"></div>
                <div class="form-error" id="upload-error"></div>
                <div class="form-footer">
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>

    
    <!-- 5MP Manifest Modal -->
    <div id="modal-manifest" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        <path d="M2 12h20"></path>
                    </svg>
                    5 Megapixels of Global Conservation
                </h2>
                <button class="modal-close" onclick="closeModal('manifest')">×</button>
            </div>
            <div style="padding: 20px; font-size: 14px; line-height: 1.7; color: #c0c0c0;">
                <p style="font-size: 16px; color: #fff; margin-bottom: 16px;"><strong>A transparent map of global conservation effort</strong></p>
                
                <p style="margin-bottom: 16px;">In 2017, the OECD estimated global biodiversity finance at USD 78-91 billion, while potentially harmful investments reached USD 500 billion. Despite this spending, we lack a comprehensive map of where conservation effort actually happens on the ground.</p>
                
                <p style="margin-bottom: 16px;">We have Google Earth and high-resolution satellite imagery, but no global map showing conservation coverage. Meanwhile, satellite timelapse reveals protected area boundaries being eroded since 2008, accelerating during the 6th mass extinction.</p>
                
                <h3 style="color: #22c55e; margin: 20px 0 12px; font-size: 15px;">The 5MP Vision</h3>
                <p style="margin-bottom: 16px;">With Earth's surface at 510 million km², dividing into 100 km² pixels gives us <strong>5.1 million pixels</strong> – the resolution of an average digital camera in 2010. We aim to create a transparent map showing conservation patrol coverage for each of these pixels.</p>
                
                <h3 style="color: #22c55e; margin: 20px 0 12px; font-size: 15px;">How It Works</h3>
                <ul style="margin-bottom: 16px; padding-left: 20px;">
                    <li style="margin-bottom: 8px;">Rangers and conservation staff upload GPS patrol tracks</li>
                    <li style="margin-bottom: 8px;">Tracks are aggregated into 10×10 km grid cells</li>
                    <li style="margin-bottom: 8px;">Coverage intensity shows patrol density per pixel</li>
                    <li style="margin-bottom: 8px;">Transparency ensures accountability and prevents double-counting</li>
                </ul>
                
                <h3 style="color: #22c55e; margin: 20px 0 12px; font-size: 15px;">Why This Matters</h3>
                <p style="margin-bottom: 16px;">Before climate-driven increases in conservation finance, we need transparent reporting. This map reveals gaps, highlights effective coverage, and ensures resources reach where they're needed most.</p>
                
                <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 8px; padding: 16px; margin-top: 20px;">
                    <p style="color: #22c55e; font-weight: 600; margin-bottom: 8px;">Join the Initiative</p>
                    <p style="margin: 0;">Upload your patrol data to contribute to the global conservation map. Every track helps build a complete picture of where conservation happens.</p>
                </div>

                <h3 style="color: #22c55e; margin: 28px 0 16px; font-size: 16px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 24px;">Methodology</h3>

                <h4 style="color: #fff; margin: 16px 0 8px; font-size: 14px;">▸ Patrol Effort Intensity</h4>
                <ul style="margin-bottom: 16px; padding-left: 20px; font-size: 13px;">
                    <li style="margin-bottom: 6px;">10×10 km grid cells (0.1° × 0.1°)</li>
                    <li style="margin-bottom: 6px;">Intensity = spatial coverage: % of 1 km subcells visited</li>
                    <li style="margin-bottom: 6px;">Color gradient: low coverage → full intensity (>80%)</li>
                    <li style="margin-bottom: 6px;">Data source: uploaded GPX patrol tracks</li>
                </ul>

                <h4 style="color: #fff; margin: 16px 0 8px; font-size: 14px;">▸ Fire Analysis</h4>
                <ul style="margin-bottom: 16px; padding-left: 20px; font-size: 13px;">
                    <li style="margin-bottom: 6px;">NASA VIIRS satellite fire detections</li>
                    <li style="margin-bottom: 6px;">Group tracking: DBSCAN clustering (15 km radius) + trajectory linking</li>
                    <li style="margin-bottom: 6px;">Infraction detection: fires inside PA boundaries</li>
                    <li style="margin-bottom: 6px;">Response metrics: groups stopped inside (possible ranger contact) vs transited through</li>
                </ul>

                <h4 style="color: #888; margin: 16px 0 8px; font-size: 14px;">▸ Roadless Areas <span style="font-size: 11px; background: #333; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">coming soon</span></h4>
                <ul style="margin-bottom: 16px; padding-left: 20px; font-size: 13px; color: #888;">
                    <li style="margin-bottom: 6px;">OpenStreetMap road data</li>
                    <li style="margin-bottom: 6px;">Roadless = area >1 km from any road</li>
                    <li style="margin-bottom: 6px;">Based on: "A global map of roadless areas and their conservation status" (Science, 2016)</li>
                </ul>

                <h4 style="color: #888; margin: 16px 0 8px; font-size: 14px;">▸ Human Settlement (GHSL) <span style="font-size: 11px; background: #333; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">coming soon</span></h4>
                <ul style="margin-bottom: 16px; padding-left: 20px; font-size: 13px; color: #888;">
                    <li style="margin-bottom: 6px;">Global Human Settlement Layer (EU JRC)</li>
                    <li style="margin-bottom: 6px;">Built-up surface area within/near PA</li>
                    <li style="margin-bottom: 6px;">Population estimates at 100 m resolution</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Park Stats Modal -->
    <div id="modal-park-stats" class="modal-overlay" onclick="closeModalOnOverlay(event)">
        <div class="modal" style="max-width: 420px;">
            <div class="modal-header">
                <h2 class="modal-title">Park Statistics</h2>
                <button class="modal-close" onclick="closeModal('park-stats')">×</button>
            </div>
            <div class="fire-stats-container" id="park-stats-content">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const MAPTILER_KEY = 'dea58ea0389007e386776c4f583f4425';
        const API_HOST = 'five-mp-conservation-effort';

        // Format numbers - only use commas for numbers >= 1000
        function formatNumber(n, decimals) {
            if (n === null || n === undefined) return '0';
            const num = Number(n);
            if (decimals !== undefined) {
                const fixed = num.toFixed(decimals);
                return Math.abs(num) >= 1000 ? Number(fixed).toLocaleString() : fixed;
            }
            return Math.abs(num) >= 1000 ? num.toLocaleString() : String(num);
        }

        const darkStyle = {
            version: 8,
            name: 'Dark',
            glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'],
                    tileSize: 256,
                    attribution: '© OpenStreetMap contributors, © CARTO'
                }
            },
            layers: [{
                id: 'osm',
                type: 'raster',
                source: 'osm'
            }]
        };

        const map = new maplibregl.Map({
            container: 'map',
            style: darkStyle,
            center: [20, 0],
            zoom: 3,
            antialias: true,
            preserveDrawingBuffer: true,  // Helps with Safari
            failIfMajorPerformanceCaveat: false  // Don't fail on software rendering
        });
        
        // Handle map errors
        map.on('error', function(e) {
            console.error('MapLibre error:', e.error);
        });
        
        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        
        // Global state - declared early for use in multiple functions
        let currentPAPopup = null;
        let selectedParks = [];
        let selectedPAIds = new Set();  // Track PA IDs selected via bbox or clicks

        
        map.on('load', function() {
            
            map.addSource('areas', {
                type: 'geojson',
                data: '/api/areas'
            });

            
            map.addSource('grid', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] },
                cluster: true,
                clusterRadius: 20,
                clusterMaxZoom: 4,
                clusterProperties: {
                    'sum_intensity': ['+', ['get', 'intensity']],
                    'sum_distance': ['+', ['coalesce', ['get', 'total_distance_km'], 0]],
                    'sum_visits': ['+', ['coalesce', ['get', 'unique_uploads'], 0]]
                }
            });

            
            map.addLayer({
                id: 'areas-fill',
                type: 'fill',
                source: 'areas',
                paint: {
                    'fill-color': '#22c55e',
                    'fill-opacity': 0.2
                }
            });

            
            map.addLayer({
                id: 'areas-outline',
                type: 'line',
                source: 'areas',
                paint: {
                    'line-color': '#22c55e',
                    'line-width': 1
                }
            });

            
            // Grid pixel rendering - uniform outline with radial fill that overflows at high intensity
            // Intensity is based on coverage: 1.0 = 80%+ of 100km² cell covered
            
            // Outer glow halo - visible at all intensities, stronger at high intensity
            // Intensity: 0 = no visits, 1.0 = monthly visits, >1.0 = more frequent (overglow)
            map.addLayer({
                id: 'grid-halo',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#22c55e',
                    'circle-radius': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 14,      // Always show base glow
                        0.5, 20,    // Moderate visits
                        1.0, 32,    // Monthly visits - full glow
                        1.5, 45     // Overglow for >2x/month
                    ],
                    'circle-blur': 1.2,
                    'circle-opacity': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0.15,    // Always visible
                        0.5, 0.3,
                        1.0, 0.5,
                        1.5, 0.7    // Strong overglow
                    ]
                }
            });

            // Grid cells represent 0.1° x 0.1° (~11km x 11km at equator)
            // MapLibre: at zoom 0, 1 degree ≈ 0.71 pixels at equator
            // 0.1 degree = 0.071 pixels at zoom 0, doubles each zoom level
            // Formula: radius = 0.071 * 2^zoom / 2 (divide by 2 for radius vs diameter)
            // z5: 1.1px, z7: 4.5px, z9: 18px, z11: 72px
            const gridCellRadius = [
                'interpolate', ['exponential', 2], ['zoom'],
                4, 0.6,
                6, 2.3,
                8, 9,
                10, 36,
                12, 144
            ];

            // Soft inner glow layer - slight overflow for high intensity
            map.addLayer({
                id: 'grid-glow',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#22c55e',
                    'circle-radius': [
                        'interpolate', ['exponential', 2], ['zoom'],
                        4, ['*', 0.8, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 1, 1, 1.3]],
                        6, ['*', 3, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 1, 1, 1.3]],
                        8, ['*', 12, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 1, 1, 1.3]],
                        10, ['*', 45, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 1, 1, 1.3]],
                        12, ['*', 180, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 1, 1, 1.3]]
                    ],
                    'circle-blur': 0.7,
                    'circle-opacity': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0.1,
                        0.5, 0.25,
                        1.0, 0.4
                    ]
                }
            });

            // Inner fill - size based on intensity (0 = no fill, 1 = fills cell)
            map.addLayer({
                id: 'grid-fill',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': '#4ade80',
                    'circle-radius': [
                        'interpolate', ['exponential', 2], ['zoom'],
                        4, ['*', 0.5, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 0, 0.3, 0.4, 0.7, 0.8, 1, 1]],
                        6, ['*', 2, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 0, 0.3, 0.4, 0.7, 0.8, 1, 1]],
                        8, ['*', 8, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 0, 0.3, 0.4, 0.7, 0.8, 1, 1]],
                        10, ['*', 32, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 0, 0.3, 0.4, 0.7, 0.8, 1, 1]],
                        12, ['*', 128, ['interpolate', ['linear'], ['coalesce', ['get', 'intensity'], 0], 0, 0, 0.3, 0.4, 0.7, 0.8, 1, 1]]
                    ],
                    'circle-blur': 0.1,
                    'circle-opacity': [
                        'interpolate', ['linear'],
                        ['coalesce', ['get', 'intensity'], 0],
                        0, 0,
                        0.2, 0.4,
                        0.5, 0.65,
                        1.0, 0.9
                    ]
                }
            });

            // Outer ring/outline - uniform relative to cell size, scales with zoom
            map.addLayer({
                id: 'grid-cells',
                type: 'circle',
                source: 'grid',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': 'transparent',
                    'circle-radius': gridCellRadius,
                    'circle-stroke-color': '#4ade80',
                    'circle-stroke-width': [
                        'interpolate', ['linear'], ['zoom'],
                        3, 0.5,
                        7, 1.5,
                        11, 3
                    ],
                    'circle-opacity': 1
                }
            });

            // Clustered circles layer (for zoomed out view)
            map.addLayer({
                id: 'grid-clusters',
                type: 'circle',
                source: 'grid',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': '#22c55e',
                    'circle-radius': [
                        'interpolate', ['linear'],
                        ['get', 'point_count'],
                        2, 12,
                        10, 16,
                        50, 20,
                        100, 24
                    ],
                    'circle-stroke-color': '#4ade80',
                    'circle-stroke-width': 2,
                    'circle-blur': 0.2,
                    'circle-opacity': 0.7
                }
            });

            // Cluster count labels
            map.addLayer({
                id: 'grid-cluster-count',
                type: 'symbol',
                source: 'grid',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['Open Sans Semibold'],
                    'text-size': 11
                },
                paint: {
                    'text-color': '#ffffff'
                }
            });

            
            // PA click handler is set up in the 'Override map click for PA areas' section below
            // to show the enhanced popup with collapsible sections

            
            map.on('click', 'grid-cells', function(e) {
                // Check if there's a PA under the grid cell - if so, let PA click handler win
                const paFeatures = map.queryRenderedFeatures(e.point, { layers: ['areas-fill'] });
                if (paFeatures.length > 0) {
                    return; // Let PA click through
                }
                
                e.originalEvent.stopPropagation();
                if (e.features.length > 0) {
                    const props = e.features[0].properties;
                    const pixelId = props.id || 'Unknown';
                    const distance = props.total_distance_km ? props.total_distance_km.toFixed(1) : '0';
                    const visits = props.unique_uploads || 0;
                    new maplibregl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <strong>Effort Pixel</strong><br>
                            <span style="color: #888; font-size: 11px;">ID: ${pixelId}</span><br>
                            Total Distance: <strong>${distance} km</strong><br>
                            Total Visits: <strong>${visits}</strong><br>
                            <span style="color: #666; font-size: 10px;">100 km² (~10km × 10km)</span>
                        `)
                        .addTo(map);
                }
            });

            
            // Click handler for clusters - zoom in to expand, but let PA clicks through
            map.on('click', 'grid-clusters', function(e) {
                // Check if there's a PA under the cluster - if so, let PA click handler win
                const paFeatures = map.queryRenderedFeatures(e.point, { layers: ['areas-fill'] });
                if (paFeatures.length > 0) {
                    // Don't handle cluster click - let PA click through
                    return;
                }
                
                e.originalEvent.stopPropagation();
                const features = map.queryRenderedFeatures(e.point, { layers: ['grid-clusters'] });
                if (features.length > 0) {
                    const clusterId = features[0].properties.cluster_id;
                    const source = map.getSource('grid');
                    source.getClusterExpansionZoom(clusterId, function(err, zoom) {
                        if (err) return;
                        map.easeTo({
                            center: features[0].geometry.coordinates,
                            zoom: zoom
                        });
                    });
                }
            });

            map.on('mouseenter', 'areas-fill', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'areas-fill', function() { map.getCanvas().style.cursor = ''; });

            // Set up PA click handler immediately when areas-fill layer is ready
            // This is in the map.on('load') block so layer definitely exists
            if (typeof setupPAClickHandler === 'function') {
                console.log('Setting up PA click handler in map.on(load)');
                setupPAClickHandler();
                if (typeof paClickHandlerInitialized !== 'undefined') paClickHandlerInitialized = true;
            }

            // Initialize country search when areas data loads
            map.on('sourcedata', function(e) {
                if (e.sourceId === 'areas' && e.isSourceLoaded) {
                    initCountrySearch();
                }
            });
            map.on('mouseenter', 'grid-cells', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'grid-cells', function() { map.getCanvas().style.cursor = ''; });
            map.on('mouseenter', 'grid-clusters', function() { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'grid-clusters', function() { map.getCanvas().style.cursor = ''; });

            // Note: Legend is now in HTML, not dynamically created (removed duplicate)
        });

        function showModal(name) { document.getElementById(`modal-${name}`).classList.add('active'); }
        function closeModal(name) {
            document.getElementById(`modal-${name}`).classList.remove('active');
            const form = document.getElementById(`form-${name}`);
            if (form) form.reset();
            const error = document.getElementById(`${name}-error`);
            if (error) error.style.display = 'none';
        }
        function closeModalOnOverlay(e) { if (e.target.classList.contains('modal-overlay')) e.target.classList.remove('active'); }
        function switchModal(from, to) { closeModal(from); showModal(to); }
        function showError(name, msg) { const el = document.getElementById(`${name}-error`); el.textContent = msg; el.style.display = 'block'; }

        async function handleLogin(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: data.get('email'), password: data.get('password') })
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Login failed');
                window.location.reload();
            } catch (err) { showError('login', err.message); }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const data = new FormData(e.target);
            if (data.get('password') !== data.get('confirm')) { showError('register', 'Passwords do not match'); return; }
            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: data.get('email'), password: data.get('password') })
                });
                if (!res.ok) throw new Error((await res.json()).error || 'Registration failed');
                window.location.reload();
            } catch (err) { showError('register', err.message); }
        }

        async function logout() { await fetch('/api/logout', { method: 'POST' }); window.location.reload(); }

        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                document.getElementById('file-input').files = e.dataTransfer.files;
                updateFileName(document.getElementById('file-input'));
            }
        }
        function updateFileName(input) {
            if (input.files.length === 0) {
                document.getElementById('selected-file').textContent = '';
            } else if (input.files.length === 1) {
                document.getElementById('selected-file').textContent = `Selected: ${input.files[0].name}`;
            } else {
                document.getElementById('selected-file').textContent = `Selected: ${input.files.length} files`;
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('file-input');
            if (!fileInput.files.length) { showError('upload', 'Please select at least one GPX file'); return; }
            
            const formData = new FormData();
            for (let file of fileInput.files) {
                formData.append('gpx', file);
            }
            
            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(text || 'Upload failed');
                }
                const result = await res.json();
                closeModal('upload');
                
                reloadGridData();
                loadStats();
                
                // Collect all grid cells and date range from segments
                const allGridCells = [];
                let minDate = null, maxDate = null;
                if (result.segments && result.segments.length > 0) {
                    for (const seg of result.segments) {
                        if (seg.grid_cells) {
                            allGridCells.push(...seg.grid_cells);
                        }
                        if (seg.start_time) {
                            const d = new Date(seg.start_time);
                            if (!minDate || d < minDate) minDate = d;
                        }
                        if (seg.end_time) {
                            const d = new Date(seg.end_time);
                            if (!maxDate || d > maxDate) maxDate = d;
                        }
                    }
                }
                const uniqueGridCells = [...new Set(allGridCells)];
                const dateRange = (minDate && maxDate) ? { start: minDate, end: maxDate } : null;
                
                // Store upload info for later use
                const uploadInfo = {
                    gridCells: uniqueGridCells,
                    dateRange: dateRange,
                    filesProcessed: result.files_processed || fileInput.files.length,
                    totalDistance: result.total_distance_km || 0,
                    timestamp: Date.now()
                };
                sessionStorage.setItem('lastUpload', JSON.stringify(uploadInfo));
                
                // Show clickable toast
                showUploadToast(uploadInfo);
            } catch (err) { showError('upload', err.message); }
        }

        // Show clickable upload success toast
        function showUploadToast(uploadInfo) {
            // Remove any existing upload toast
            const existing = document.querySelector('.upload-toast');
            if (existing) existing.remove();
            
            const distanceText = uploadInfo.totalDistance > 0 
                ? formatNumber(uploadInfo.totalDistance, 1) + ' km'
                : '';
            const pixelCount = uploadInfo.gridCells.length;
            const subtitle = [distanceText, pixelCount + ' pixel' + (pixelCount !== 1 ? 's' : '')].filter(Boolean).join(' • ');
            
            const toast = document.createElement('div');
            toast.className = 'upload-toast';
            toast.innerHTML = `
                <div class="upload-toast-icon">✓</div>
                <div class="upload-toast-content">
                    <div class="upload-toast-title">Upload successful!</div>
                    <div class="upload-toast-subtitle">${subtitle}</div>
                </div>
                <div class="upload-toast-action">View on map →</div>
                <button class="upload-toast-close" onclick="event.stopPropagation(); this.parentElement.remove();">&times;</button>
            `;
            
            toast.addEventListener('click', () => {
                toast.remove();
                highlightUploadedPixels(uploadInfo.gridCells, uploadInfo.dateRange);
            });
            
            document.body.appendChild(toast);
            
            // Auto-dismiss after 15 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'toastFadeOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 15000);
        }

        // Highlight uploaded pixels on the map
        let uploadHighlightSource = null;
        let uploadHighlightTimeout = null;
        
        function highlightUploadedPixels(gridCellIds, dateRange) {
            if (!gridCellIds || gridCellIds.length === 0) {
                showToast('No grid cells to highlight', 'info');
                return;
            }
            
            // Parse grid cell IDs to get bounds (format: "lat_lon" like "-2.3_34.8")
            const coords = gridCellIds.map(id => {
                const parts = id.split('_');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0]);
                    const lon = parseFloat(parts[1]);
                    if (!isNaN(lat) && !isNaN(lon)) {
                        return { lat, lon };
                    }
                }
                return null;
            }).filter(Boolean);
            
            if (coords.length === 0) {
                showToast('Could not parse grid cell coordinates', 'info');
                return;
            }
            
            // Calculate bounds with padding (grid cells are 0.1 degrees)
            const cellSize = 0.1;
            const padding = 0.1; // Extra padding around bounds
            let minLat = Infinity, maxLat = -Infinity, minLon = Infinity, maxLon = -Infinity;
            coords.forEach(c => {
                minLat = Math.min(minLat, c.lat);
                maxLat = Math.max(maxLat, c.lat + cellSize);
                minLon = Math.min(minLon, c.lon);
                maxLon = Math.max(maxLon, c.lon + cellSize);
            });
            
            // Create GeoJSON for highlight layer
            const features = coords.map(c => ({
                type: 'Feature',
                properties: { highlighted: true },
                geometry: {
                    type: 'Point',
                    coordinates: [c.lon + cellSize/2, c.lat + cellSize/2]
                }
            }));
            const highlightGeoJSON = { type: 'FeatureCollection', features };
            
            // Add or update highlight source/layer
            if (map.getSource('upload-highlight')) {
                map.getSource('upload-highlight').setData(highlightGeoJSON);
            } else {
                map.addSource('upload-highlight', {
                    type: 'geojson',
                    data: highlightGeoJSON
                });
                
                // Add pulsing highlight layer
                map.addLayer({
                    id: 'upload-highlight-pulse',
                    type: 'circle',
                    source: 'upload-highlight',
                    paint: {
                        'circle-radius': [
                            'interpolate', ['exponential', 2], ['zoom'],
                            4, 8,
                            6, 16,
                            8, 40,
                            10, 80,
                            12, 200
                        ],
                        'circle-color': '#fbbf24',
                        'circle-opacity': 0.4,
                        'circle-blur': 0.8
                    }
                });
                
                // Add ring highlight layer
                map.addLayer({
                    id: 'upload-highlight-ring',
                    type: 'circle',
                    source: 'upload-highlight',
                    paint: {
                        'circle-radius': [
                            'interpolate', ['exponential', 2], ['zoom'],
                            4, 4,
                            6, 10,
                            8, 25,
                            10, 50,
                            12, 120
                        ],
                        'circle-color': 'transparent',
                        'circle-stroke-width': 3,
                        'circle-stroke-color': '#fbbf24'
                    }
                });
            }
            
            // Fit bounds with animation
            const bounds = [[minLon - padding, minLat - padding], [maxLon + padding, maxLat + padding]];
            map.fitBounds(bounds, {
                padding: { top: 100, bottom: 150, left: 50, right: 50 },
                maxZoom: 12,
                duration: 1500
            });
            
            // Update time slider if date range provided
            if (dateRange && dateRange.start && dateRange.end) {
                setTimeSliderRange(dateRange.start, dateRange.end);
            }
            
            // Clear previous timeout
            if (uploadHighlightTimeout) {
                clearTimeout(uploadHighlightTimeout);
            }
            
            // Auto-remove highlight after 20 seconds
            uploadHighlightTimeout = setTimeout(() => {
                removeUploadHighlight();
            }, 20000);
            
            showToast('Showing ' + gridCellIds.length + ' uploaded pixel' + (gridCellIds.length !== 1 ? 's' : ''), 'success');
        }
        
        function removeUploadHighlight() {
            if (map.getLayer('upload-highlight-pulse')) {
                map.removeLayer('upload-highlight-pulse');
            }
            if (map.getLayer('upload-highlight-ring')) {
                map.removeLayer('upload-highlight-ring');
            }
            if (map.getSource('upload-highlight')) {
                map.removeSource('upload-highlight');
            }
            if (uploadHighlightTimeout) {
                clearTimeout(uploadHighlightTimeout);
                uploadHighlightTimeout = null;
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        });

        
        async function loadStats() {
            try {
                // Build URL with filters
                var url = '/api/stats';
                var params = [];
                if (dateFrom) params.push('from=' + dateFrom);
                if (dateTo) params.push('to=' + dateTo);
                if (currentBbox) params.push('bbox=' + currentBbox.join(','));
                // Add movement type filter
                var types = getActiveMovementTypes();
                if (types.length < 3 && types.length > 0) {
                    params.push('type=' + types.join(','));
                }
                if (params.length > 0) url += '?' + params.join('&');
                
                const res = await fetch(url);
                if (res.ok) {
                    const stats = await res.json();
                    document.getElementById('stats-pixels').textContent = formatNumber(stats.active_pixels || 0);
                    document.getElementById('stats-distance').textContent = formatNumber(stats.total_distance_km || 0, 1) + ' km';
                    document.getElementById('stats-patrols').textContent = formatNumber(stats.total_patrols || 0);
                    
                    // Conservation data
                    document.getElementById('stats-fires').textContent = formatNumber(stats.total_fires || 0);
                    const fireTrend = stats.fire_trend || 'stable';
                    const fireTrendEl = document.getElementById('stats-fire-trend');
                    fireTrendEl.className = 'stats-trend ' + fireTrend;
                    fireTrendEl.textContent = fireTrend === 'up' ? ' ▲' : (fireTrend === 'down' ? ' ▼' : '');
                    
                    const deforest = stats.total_deforestation || 0;
                    document.getElementById('stats-deforest').textContent = formatNumber(deforest, 1) + ' km²';
                    const deforestTrend = stats.deforest_trend || 'stable';
                    const deforestTrendEl = document.getElementById('stats-deforest-trend');
                    deforestTrendEl.className = 'stats-trend ' + deforestTrend;
                    deforestTrendEl.textContent = deforestTrend === 'worsening' ? ' ▲' : (deforestTrend === 'improving' ? ' ▼' : '');
                    
                    document.getElementById('stats-settlements').textContent = formatNumber(stats.total_settlements || 0);
                }

            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }
        
        // Declare state variables before they're used
        let filterPanelOpen = true; // Panel starts open in HTML
        let searchOpen = false;
        var dateFrom = null;
        var dateTo = null;
        var currentPreset = '12m';
        let activityExpanded = false;
        let currentBbox = null; 
        let bboxDrawing = false;
        let bboxStartPoint = null;
        
        // Movement type filter state (all on by default)
        var movementTypes = { foot: true, vehicle: true, aerial: true };
        var currentCountryFilter = ''; // Country filter state
        
        // Initial stats load will happen after initDateRange sets dates
        // loadStats(); // Moved to after initDateRange

        function toggleFilterPanel() {
            filterPanelOpen = !filterPanelOpen;
            var panel = document.getElementById('filter-panel');
            var toggle = document.getElementById('filter-toggle');
            if (filterPanelOpen) {
                panel.classList.add('open');
                toggle.classList.add('active');
                // Close search panel if open
                if (searchOpen) {
                    searchOpen = false;
                    document.getElementById('search-panel').classList.remove('open');
                    document.getElementById('toolbar-search').classList.remove('active');
                }
            } else {
                panel.classList.remove('open');
                toggle.classList.remove('active');
            }
        }

        // Export parks data as CSV
        function exportParksCSV() {
            window.location.href = '/api/export/parks?format=csv';
        }

        var mapLoaded = false;
        var pendingGridReload = false;
        
        map.on('load', function() {
            mapLoaded = true;
            if (pendingGridReload) {
                pendingGridReload = false;
                reloadGridData();
            }
        });
        
        function reloadGridData() {
            // Wait for map to be loaded
            if (!mapLoaded) {
                pendingGridReload = true;
                return;
            }
            
            var url = '/api/grid?t=' + Date.now();
            if (dateFrom) url += '&from=' + dateFrom;
            if (dateTo) url += '&to=' + dateTo;
            if (currentBbox) {
                url += '&bbox=' + currentBbox.join(',');
            }
            // Add movement type filter
            var types = getActiveMovementTypes();
            if (types.length < 3 && types.length > 0) {
                url += '&type=' + types.join(',');
            }
            
            console.log('Reloading grid data: from=' + dateFrom + ', to=' + dateTo + ', bbox=' + (currentBbox ? currentBbox.join(',') : 'none') + ', types=' + types.join(','));
            
            // Fetch data and set it
            fetch(url)
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var gridSource = map.getSource('grid');
                    if (gridSource) {
                        gridSource.setData(data);
                    }
                })
                .catch(function(err) {
                    console.error('Failed to load grid data:', err);
                });
            
            // Also reload stats when filters change
            loadStats();
        }

        
        function startBboxSelection() {
            bboxDrawing = true;
            bboxStartPoint = null;
            document.getElementById('bbox-draw-overlay').classList.add('active');
            document.getElementById('bbox-draw-hint').classList.add('active');
            document.getElementById('bbox-toggle').classList.add('active');
            map.getCanvas().style.cursor = 'crosshair';
        }

        function cancelBboxSelection() {
            bboxDrawing = false;
            bboxStartPoint = null;
            document.getElementById('bbox-draw-overlay').classList.remove('active');
            document.getElementById('bbox-draw-hint').classList.remove('active');
            document.getElementById('bbox-toggle').classList.remove('active');
            map.getCanvas().style.cursor = '';
            
            var rect = document.querySelector('.bbox-draw-rect');
            if (rect) rect.remove();
        }

        function setBbox(minLng, minLat, maxLng, maxLat) {
            currentBbox = [minLng, minLat, maxLng, maxLat];
            
            // Update filter panel display
            var filterArea = document.getElementById('filter-area');
            var filterAreaValue = document.getElementById('filter-area-value');
            if (filterArea && filterAreaValue) {
                filterArea.style.display = 'flex';
                // Calculate approximate area size
                var latDiff = Math.abs(maxLat - minLat);
                var lngDiff = Math.abs(maxLng - minLng);
                var approxKm = Math.round(latDiff * 111 * lngDiff * 111 * Math.cos((minLat + maxLat) / 2 * Math.PI / 180));
                filterAreaValue.textContent = formatNumber(approxKm) + ' km² region';
            }
            
            // Auto-select PAs that intersect the bbox
            selectPAsInBbox(minLng, minLat, maxLng, maxLat);
            
            drawBboxOnMap();
            reloadGridData();
        }

        // Select PAs that intersect the given bounding box
        function selectPAsInBbox(minLng, minLat, maxLng, maxLat) {
            if (!map || !map.getSource('areas')) return;
            
            // Clear previous bbox selection
            selectedPAIds.clear();
            selectedParks = [];
            
            // Query all features from the areas source
            var features = map.querySourceFeatures('areas');
            
            features.forEach(function(feature) {
                var props = feature.properties;
                var paId = props.id || props.wdpa_id;
                if (!paId) return;
                
                // Check if feature intersects bbox
                // Get feature bounds from geometry
                var geom = feature.geometry;
                if (!geom || !geom.coordinates) return;
                
                var featureBounds = getGeometryBounds(geom);
                if (!featureBounds) return;
                
                // Check if bboxes overlap
                if (bboxesIntersect(
                    [minLng, minLat, maxLng, maxLat],
                    featureBounds
                )) {
                    selectedPAIds.add(paId);
                    selectedParks.push({
                        id: paId,
                        name: props.name || 'Unknown',
                        bbox: featureBounds,
                        center: [(featureBounds[0] + featureBounds[2]) / 2, (featureBounds[1] + featureBounds[3]) / 2]
                    });
                }
            });
            
            // Update map highlighting and display
            updatePAHighlighting();
            updateSelectedParksDisplay();
        }
        
        // Get bounds [minLng, minLat, maxLng, maxLat] from a GeoJSON geometry
        function getGeometryBounds(geom) {
            var minLng = Infinity, minLat = Infinity, maxLng = -Infinity, maxLat = -Infinity;
            
            function processCoords(coords) {
                if (typeof coords[0] === 'number') {
                    // It's a point [lng, lat]
                    if (coords[0] < minLng) minLng = coords[0];
                    if (coords[0] > maxLng) maxLng = coords[0];
                    if (coords[1] < minLat) minLat = coords[1];
                    if (coords[1] > maxLat) maxLat = coords[1];
                } else {
                    // It's an array of coords
                    coords.forEach(processCoords);
                }
            }
            
            if (geom.coordinates) {
                processCoords(geom.coordinates);
            }
            
            if (minLng === Infinity) return null;
            return [minLng, minLat, maxLng, maxLat];
        }
        
        // Check if two bboxes [minLng, minLat, maxLng, maxLat] intersect
        function bboxesIntersect(a, b) {
            return !(a[2] < b[0] || b[2] < a[0] || a[3] < b[1] || b[3] < a[1]);
        }
        
        // Update PA layer styling based on selectedPAIds
        function updatePAHighlighting() {
            if (!map || !map.getLayer || !map.getLayer('areas-fill')) return;
            
            if (selectedPAIds.size === 0) {
                // No selection - use default keystones styling
                if (keystonesEnabled) {
                    map.setPaintProperty('areas-fill', 'fill-color', '#22c55e');
                    map.setPaintProperty('areas-fill', 'fill-opacity', 0.2);
                    map.setPaintProperty('areas-outline', 'line-color', '#22c55e');
                    map.setPaintProperty('areas-outline', 'line-width', 1);
                } else {
                    map.setPaintProperty('areas-fill', 'fill-color', '#666666');
                    map.setPaintProperty('areas-fill', 'fill-opacity', 0.1);
                    map.setPaintProperty('areas-outline', 'line-color', '#555555');
                    map.setPaintProperty('areas-outline', 'line-width', 1);
                }
            } else {
                // Has selection - highlight selected PAs in green, others in grey
                var selectedIds = Array.from(selectedPAIds);
                
                map.setPaintProperty('areas-fill', 'fill-color', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    '#22c55e',  // Selected: green
                    '#666666'   // Not selected: grey
                ]);
                
                map.setPaintProperty('areas-fill', 'fill-opacity', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    0.35,  // Selected: more opaque
                    0.1    // Not selected: faded
                ]);
                
                map.setPaintProperty('areas-outline', 'line-color', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    '#22c55e',  // Selected: green
                    '#555555'   // Not selected: grey
                ]);
                
                map.setPaintProperty('areas-outline', 'line-width', [
                    'case',
                    ['in', ['get', 'id'], ['literal', selectedIds]],
                    2,  // Selected: thicker
                    1   // Not selected: normal
                ]);
            }
        }

        function toggleMovementType(type) {
            movementTypes[type] = !movementTypes[type];
            var btn = document.getElementById('toggle-' + type);
            if (btn) {
                if (movementTypes[type]) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            }
            reloadGridData();
        }

        // Keystones toggle state
        var keystonesEnabled = true;

        function toggleKeystones(enabled) {
            keystonesEnabled = enabled;
            if (!map || !map.getLayer) return;
            
            // Use updatePAHighlighting to handle both keystones toggle and selected PAs
            updatePAHighlighting();
        }

        function toggleKeystonesBtn() {
            var btn = document.getElementById('keystones-toggle-btn');
            var checkbox = document.getElementById('keystones-toggle');
            keystonesEnabled = !keystonesEnabled;
            checkbox.checked = keystonesEnabled;
            if (keystonesEnabled) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            updatePAHighlighting();
        }

        // Country search functions
        var countryList = [];
        var countryBboxCache = {};
        
        function initCountrySearch() {
            if (!map || !map.getSource('areas')) return;
            
            var features = map.querySourceFeatures('areas');
            if (features.length === 0) return;
            
            // Extract unique countries and calculate bboxes
            var countryData = {};
            features.forEach(function(f) {
                if (f.properties && f.properties.country) {
                    var country = f.properties.country;
                    if (!countryData[country]) {
                        countryData[country] = { minLng: Infinity, minLat: Infinity, maxLng: -Infinity, maxLat: -Infinity };
                    }
                    // Get bbox from feature geometry
                    if (f.geometry && f.geometry.coordinates) {
                        var coords = f.geometry.coordinates.flat(3);
                        for (var i = 0; i < coords.length; i += 2) {
                            var lng = coords[i], lat = coords[i+1];
                            if (typeof lng === 'number' && typeof lat === 'number') {
                                countryData[country].minLng = Math.min(countryData[country].minLng, lng);
                                countryData[country].maxLng = Math.max(countryData[country].maxLng, lng);
                                countryData[country].minLat = Math.min(countryData[country].minLat, lat);
                                countryData[country].maxLat = Math.max(countryData[country].maxLat, lat);
                            }
                        }
                    }
                }
            });
            
            countryList = Object.keys(countryData).sort();
            countryBboxCache = countryData;
            
            // Setup search input
            var input = document.getElementById('country-search');
            var results = document.getElementById('country-search-results');
            if (!input || !results) return;
            
            input.addEventListener('input', function() {
                var query = input.value.toLowerCase().trim();
                if (query.length === 0) {
                    results.classList.remove('open');
                    return;
                }
                
                var matches = countryList.filter(function(c) {
                    return c.toLowerCase().includes(query);
                });
                
                if (matches.length === 0) {
                    results.innerHTML = '<div class="country-search-item" style="color: #666;">No matches</div>';
                } else {
                    results.innerHTML = matches.slice(0, 10).map(function(c) {
                        return '<div class="country-search-item" data-country="' + c + '">' + c + '</div>';
                    }).join('');
                }
                results.classList.add('open');
            });
            
            input.addEventListener('focus', function() {
                if (input.value.length > 0) {
                    results.classList.add('open');
                }
            });
            
            results.addEventListener('click', function(e) {
                var item = e.target.closest('.country-search-item');
                if (item && item.dataset.country) {
                    selectCountry(item.dataset.country);
                }
            });
            
            // Close on click outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.country-search-wrapper')) {
                    results.classList.remove('open');
                }
            });
        }
        
        function selectCountry(country) {
            currentCountryFilter = country;
            
            // Hide input, show selected
            var input = document.getElementById('country-search');
            var results = document.getElementById('country-search-results');
            var selected = document.getElementById('country-selected');
            var selectedName = document.getElementById('country-selected-name');
            
            if (input) input.style.display = 'none';
            if (results) results.classList.remove('open');
            if (selected) selected.style.display = 'flex';
            if (selectedName) selectedName.textContent = country;
            
            // Get bbox and apply it
            var bbox = countryBboxCache[country];
            if (bbox && bbox.minLng !== Infinity) {
                currentBbox = [bbox.minLng, bbox.minLat, bbox.maxLng, bbox.maxLat];
                
                // Show the active filter UI
                var activeFilters = document.getElementById('active-filters');
                var bboxFilter = document.getElementById('active-filter-bbox');
                var areaValue = document.getElementById('filter-area-value');
                if (activeFilters) activeFilters.style.display = 'block';
                if (bboxFilter) bboxFilter.style.display = 'flex';
                if (areaValue) areaValue.textContent = country;
                
                // Fly to country bbox
                map.fitBounds([[bbox.minLng, bbox.minLat], [bbox.maxLng, bbox.maxLat]], {
                    padding: 50,
                    duration: 1500
                });
                
                // Reload grid data with bbox
                reloadGridData();
            }
            
            applyCountryFilter();
            updateCountryStats();
        }
        
        function clearCountrySearch() {
            currentCountryFilter = '';
            currentBbox = null;
            
            var input = document.getElementById('country-search');
            var selected = document.getElementById('country-selected');
            
            if (input) {
                input.style.display = 'block';
                input.value = '';
            }
            if (selected) selected.style.display = 'none';
            
            // Clear bbox filter UI
            var activeFilters = document.getElementById('active-filters');
            var bboxFilter = document.getElementById('active-filter-bbox');
            if (bboxFilter) bboxFilter.style.display = 'none';
            if (activeFilters && !document.querySelector('#active-filters .active-filter-item[style*="display: flex"]')) {
                activeFilters.style.display = 'none';
            }
            
            applyCountryFilter();
            updateCountryStats();
            reloadGridData();
        }

        function applyCountryFilter() {
            if (!map || !map.getLayer('areas-fill')) return;
            
            if (currentCountryFilter === '') {
                // No filter - show all areas
                map.setFilter('areas-fill', null);
                map.setFilter('areas-outline', null);
            } else {
                // Filter to selected country
                var filter = ['==', ['get', 'country'], currentCountryFilter];
                map.setFilter('areas-fill', filter);
                map.setFilter('areas-outline', filter);
            }
            
            // Update PA highlighting to respect the filter
            updatePAHighlighting();
        }

        function updateCountryStats() {
            if (!map || !map.getSource('areas')) return;
            
            var features = map.querySourceFeatures('areas');
            var filteredFeatures = features;
            
            if (currentCountryFilter !== '') {
                filteredFeatures = features.filter(function(f) {
                    return f.properties && f.properties.country === currentCountryFilter;
                });
            }
            
            // Count unique parks in the filtered set
            var uniqueParks = new Set();
            var totalAreaKm2 = 0;
            filteredFeatures.forEach(function(f) {
                if (f.properties && f.properties.id) {
                    if (!uniqueParks.has(f.properties.id)) {
                        uniqueParks.add(f.properties.id);
                        if (f.properties.area_km2) {
                            totalAreaKm2 += f.properties.area_km2;
                        }
                    }
                }
            });
            
            // Update the keystones count display if filtering
            var keystonesBtn = document.getElementById('keystones-toggle-btn');
            if (keystonesBtn) {
                var countSpan = keystonesBtn.querySelector('span:last-child');
                if (countSpan) {
                    if (currentCountryFilter === '') {
                        countSpan.textContent = '162'; // Default total
                    } else {
                        countSpan.textContent = uniqueParks.size;
                    }
                }
            }
        }

        function getActiveMovementTypes() {
            var types = [];
            if (movementTypes.foot) types.push('foot');
            if (movementTypes.vehicle) types.push('vehicle');
            if (movementTypes.aerial) types.push('aerial');
            return types;
        }

        function clearBbox() {
            currentBbox = null;
            
            // Hide filter panel display
            var filterArea = document.getElementById('filter-area');
            if (filterArea) {
                filterArea.style.display = 'none';
            }
            
            // Clear PA selection
            selectedPAIds.clear();
            selectedParks = [];
            updatePAHighlighting();
            updateSelectedParksDisplay();
            
            removeBboxFromMap();
            reloadGridData();
        }

        function drawBboxOnMap() {
            removeBboxFromMap();
            if (!currentBbox || !map.getSource) return;
            
            var coords = [
                [currentBbox[0], currentBbox[1]],
                [currentBbox[2], currentBbox[1]],
                [currentBbox[2], currentBbox[3]],
                [currentBbox[0], currentBbox[3]],
                [currentBbox[0], currentBbox[1]]
            ];
            
            try {
                map.addSource('bbox-selection', {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: { type: 'Polygon', coordinates: [coords] }
                    }
                });
                map.addLayer({
                    id: 'bbox-selection-fill',
                    type: 'fill',
                    source: 'bbox-selection',
                    paint: { 'fill-color': '#60a5fa', 'fill-opacity': 0.1 }
                });
                map.addLayer({
                    id: 'bbox-selection-line',
                    type: 'line',
                    source: 'bbox-selection',
                    paint: { 'line-color': '#60a5fa', 'line-width': 2, 'line-dasharray': [2, 2] }
                });
            } catch (e) {
                console.log('Could not draw bbox on map:', e);
            }
        }

        function removeBboxFromMap() {
            try {
                if (map.getLayer('bbox-selection-fill')) map.removeLayer('bbox-selection-fill');
                if (map.getLayer('bbox-selection-line')) map.removeLayer('bbox-selection-line');
                if (map.getSource('bbox-selection')) map.removeSource('bbox-selection');
            } catch (e) {}
        }

        
        (function() {
            var overlay = document.getElementById('bbox-draw-overlay');
            var startX, startY, rect;
            
            function getMapCoords(clientX, clientY) {
                var mapEl = document.getElementById('map');
                var mapRect = mapEl.getBoundingClientRect();
                var point = { x: clientX - mapRect.left, y: clientY - mapRect.top };
                return map.unproject([point.x, point.y]);
            }
            
            function onStart(e) {
                e.preventDefault();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var clientY = e.touches ? e.touches[0].clientY : e.clientY;
                startX = clientX;
                startY = clientY;
                bboxStartPoint = getMapCoords(clientX, clientY);
                
                rect = document.createElement('div');
                rect.className = 'bbox-draw-rect';
                rect.style.left = clientX + 'px';
                rect.style.top = clientY + 'px';
                rect.style.width = '0px';
                rect.style.height = '0px';
                document.body.appendChild(rect);
            }
            
            function onMove(e) {
                if (!bboxStartPoint || !rect) return;
                e.preventDefault();
                var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                var clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                var left = Math.min(startX, clientX);
                var top = Math.min(startY, clientY);
                var width = Math.abs(clientX - startX);
                var height = Math.abs(clientY - startY);
                
                rect.style.left = left + 'px';
                rect.style.top = top + 'px';
                rect.style.width = width + 'px';
                rect.style.height = height + 'px';
            }
            
            function onEnd(e) {
                if (!bboxStartPoint) return;
                var clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                var clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                var endPoint = getMapCoords(clientX, clientY);
                
                var minLng = Math.min(bboxStartPoint.lng, endPoint.lng);
                var maxLng = Math.max(bboxStartPoint.lng, endPoint.lng);
                var minLat = Math.min(bboxStartPoint.lat, endPoint.lat);
                var maxLat = Math.max(bboxStartPoint.lat, endPoint.lat);
                
                
                if (Math.abs(maxLng - minLng) > 0.001 && Math.abs(maxLat - minLat) > 0.001) {
                    setBbox(minLng, minLat, maxLng, maxLat);
                }
                
                cancelBboxSelection();
            }
            
            overlay.addEventListener('mousedown', onStart);
            overlay.addEventListener('mousemove', onMove);
            overlay.addEventListener('mouseup', onEnd);
            overlay.addEventListener('touchstart', onStart);
            overlay.addEventListener('touchmove', onMove);
            overlay.addEventListener('touchend', onEnd);
        })();

        function toggleActivityLog() {
            activityExpanded = !activityExpanded;
            const list = document.getElementById('activity-list');
            const icon = document.getElementById('activity-toggle-icon');
            
            if (activityExpanded) {
                list.classList.add('expanded');
                icon.classList.add('expanded');
                loadActivityLog();
            } else {
                list.classList.remove('expanded');
                icon.classList.remove('expanded');
            }
        }

        async function loadActivityLog() {
            const list = document.getElementById('activity-list');
            
            try {
                const res = await fetch('/api/activity');
                if (res.ok) {
                    const data = await res.json();
                    // API returns array directly
                    const activities = Array.isArray(data) ? data : (data.activities || []);
                    if (activities.length > 0) {
                        list.innerHTML = activities.slice(0, 10).map(a => {
                            const dateStr = a.date || 'Unknown';
                            const location = a.location || 'Unknown';
                            const distance = a.distance ? a.distance.toFixed(1) + ' km' : '';
                            const typeIcon = {'foot': '○', 'vehicle': '□', 'aircraft': '△'}[a.type] || '◇';
                            return `<div class="activity-item">
                                <span class="activity-date">${typeIcon} ${dateStr}</span>
                                <span class="activity-distance">${distance}</span>
                            </div>`;
                        }).join('');
                    } else {
                        list.innerHTML = '<div class="activity-empty">No recent activity</div>';
                    }
                } else {
                    throw new Error('Failed to load');
                }
            } catch (err) {
                console.error('Activity load error:', err);
                list.innerHTML = '<div class="activity-empty">No recent activity</div>';
            }
        }

        // Notification Dropdown functionality
        let latestActivities = [];
        let activityMarker = null;
        let notificationDropdownOpen = false;
        let hasNewNotifications = true;

        // Sample/demo data for when no real activity exists
        const sampleActivities = [
            { location: 'Serengeti National Park', distance: 12.5, date: 'Today', type: 'foot', lat: -2.3333, lon: 34.8333 },
            { location: 'Kruger National Park', distance: 8.2, date: 'Yesterday', type: 'vehicle', lat: -24.0167, lon: 31.4833 },
            { location: 'Masai Mara Reserve', distance: 15.7, date: 'Jan 28', type: 'foot', lat: -1.5, lon: 35.0 },
            { location: 'Yellowstone National Park', distance: 22.1, date: 'Jan 27', type: 'foot', lat: 44.4280, lon: -110.5885 },
            { location: 'Great Barrier Reef', distance: 5.3, date: 'Jan 26', type: 'vehicle', lat: -18.2871, lon: 147.6992 }
        ];

        async function loadNotifications() {
            try {
                const res = await fetch('/api/activity');
                if (!res.ok) throw new Error('Failed to load');
                
                const data = await res.json();
                latestActivities = (Array.isArray(data) ? data : (data.activities || [])).filter(a => a.lat && a.lon);
                
                // Use sample data if no real data with coordinates
                if (latestActivities.length === 0) {
                    latestActivities = sampleActivities;
                }
                
                updateNotificationList();
                showNotificationBadge();
            } catch (err) {
                console.error('Notifications load error:', err);
                // Fall back to sample data on error
                latestActivities = sampleActivities;
                updateNotificationList();
                showNotificationBadge();
            }
        }

        function updateNotificationList() {
            const listEl = document.getElementById('notification-list');
            
            if (latestActivities.length === 0) {
                listEl.innerHTML = '<div class="notification-empty">No recent activity</div>';
                return;
            }
            
            listEl.innerHTML = latestActivities.slice(0, 10).map((activity, index) => {
                const location = activity.location || 'Unknown location';
                const distance = activity.distance ? activity.distance.toFixed(1) + ' km' : '';
                const date = activity.date || '';
                const typeIcon = {'foot': '○', 'vehicle': '□', 'aircraft': '△'}[activity.type] || '◇';
                
                let details = '';
                if (distance && date) details = `${distance} • ${date}`;
                else if (distance) details = distance;
                else if (date) details = date;
                
                return `
                    <div class="notification-item" onclick="handleNotificationClick(${index})">
                        <div class="notification-icon">${typeIcon}</div>
                        <div class="notification-content">
                            <div class="notification-location">${escapeHtml(location)}</div>
                            <div class="notification-details">${details}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showNotificationBadge() {
            if (hasNewNotifications && latestActivities.length > 0) {
                document.getElementById('notification-badge').classList.remove('hidden');
            }
        }

        function hideNotificationBadge() {
            hasNewNotifications = false;
            document.getElementById('notification-badge').classList.add('hidden');
        }

        function toggleNotificationDropdown() {
            notificationDropdownOpen = !notificationDropdownOpen;
            const dropdown = document.getElementById('notification-dropdown');
            const btn = document.getElementById('notification-toggle');
            
            if (notificationDropdownOpen) {
                dropdown.classList.add('open');
                btn.classList.add('active');
                hideNotificationBadge();
            } else {
                dropdown.classList.remove('open');
                btn.classList.remove('active');
            }
        }

        function closeNotificationDropdown(event) {
            if (event) event.stopPropagation();
            notificationDropdownOpen = false;
            document.getElementById('notification-dropdown').classList.remove('open');
            document.getElementById('notification-toggle').classList.remove('active');
        }

        function handleNotificationClick(index) {
            if (index >= 0 && index < latestActivities.length) {
                const activity = latestActivities[index];
                if (activity.lat && activity.lon) {
                    zoomToActivity(activity);
                    closeNotificationDropdown();
                }
            }
        }

        function zoomToActivity(activity) {
            // Remove existing marker
            removeActivityMarker();
            
            // Fly to location
            map.flyTo({
                center: [activity.lon, activity.lat],
                zoom: 12,
                duration: 1500,
                essential: true
            });
            
            // Add pulsing marker after flight completes
            setTimeout(() => {
                addActivityMarker(activity.lon, activity.lat);
            }, 1600);
        }

        function addActivityMarker(lon, lat) {
            removeActivityMarker();
            
            // Create marker element
            const el = document.createElement('div');
            el.className = 'activity-marker';
            
            // Add marker to map
            activityMarker = new maplibregl.Marker({ element: el })
                .setLngLat([lon, lat])
                .addTo(map);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                removeActivityMarker();
            }, 10000);
        }

        function removeActivityMarker() {
            if (activityMarker) {
                activityMarker.remove();
                activityMarker = null;
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('notification-dropdown');
            const btn = document.getElementById('notification-toggle');
            if (notificationDropdownOpen && !btn.contains(event.target)) {
                closeNotificationDropdown();
            }
        });

        // Load notifications after map is ready
        map.on('load', function() {
            // Small delay to let other things initialize
            setTimeout(loadNotifications, 1000);
        });

        
        initDateRange();

        
        let searchTimeout = null;
        let cachedAreas = null;

        function toggleSearch() {
            searchOpen = !searchOpen;
            const toolbarBtn = document.getElementById('toolbar-search');
            const panel = document.getElementById('search-panel');
            const input = document.getElementById('search-input');
            const results = document.getElementById('search-results');
            
            if (searchOpen) {
                toolbarBtn.classList.add('active');
                panel.classList.add('open');
                // Close filter panel if open
                if (filterPanelOpen) {
                    filterPanelOpen = false;
                    document.getElementById('filter-panel').classList.remove('open');
                    document.getElementById('filter-toggle').classList.remove('active');
                }
                setTimeout(() => input.focus(), 100);
            } else {
                toolbarBtn.classList.remove('active');
                panel.classList.remove('open');
                results.classList.remove('open');
                input.value = '';
                document.getElementById('search-clear').style.display = 'none';
            }
        }

        function handleSearchInput(e) {
            const query = e.target.value.trim();
            const clearBtn = document.getElementById('search-clear');
            
            clearBtn.style.display = query.length > 0 ? 'block' : 'none';
            
            if (searchTimeout) clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            
            searchTimeout = setTimeout(() => searchAreas(query), 200);
        }

        async function searchAreas(query) {
            const results = document.getElementById('search-results');
            results.innerHTML = '<div class="search-loading">Searching...</div>';
            results.classList.add('open');
            
            try {
                // Search both loaded keystones and WDPA index
                const [keystonesRes, wdpaRes] = await Promise.all([
                    fetch(`/api/areas/search?q=${encodeURIComponent(query)}`),
                    fetch(`/api/wdpa/search?q=${encodeURIComponent(query)}`)
                ]);
                
                const keystones = keystonesRes.ok ? await keystonesRes.json() : [];
                const wdpaAreas = wdpaRes.ok ? await wdpaRes.json() : [];
                
                // Merge results: keystones first (loaded), then WDPA unloaded
                const loadedIds = new Set(keystones.map(k => k.name.toLowerCase()));
                const unloaded = wdpaAreas.filter(w => !loadedIds.has(w.name.toLowerCase()) && !w.loaded);
                const merged = [...keystones.map(k => ({...k, loaded: true})), ...unloaded];
                
                displaySearchResults(merged);
            } catch (err) {
                console.error('Search error:', err);
                results.innerHTML = '<div class="search-no-results">Search failed</div>';
            }
        }

        function displaySearchResults(areas) {
            const results = document.getElementById('search-results');
            
            if (areas.length === 0) {
                results.innerHTML = '<div class="search-no-results">No protected areas found</div>';
                return;
            }
            
            results.innerHTML = areas.map(area => {
                const isLoaded = area.loaded !== false;
                const itemClass = isLoaded ? 'search-result-item' : 'search-result-item unloaded';
                const badgeClass = isLoaded ? 'loaded-badge loaded' : 'loaded-badge unloaded';
                const badgeText = isLoaded ? 'loaded' : 'not loaded';
                return `
                <div class="${itemClass}" onclick="selectSearchResult(${JSON.stringify(area).replace(/"/g, '&quot;')})">
                    <div class="search-result-name">
                        <span>${escapeHtml(area.name)}</span>
                        <span class="${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="search-result-country">${escapeHtml(area.country || 'Unknown')}${area.designation ? ' • ' + escapeHtml(area.designation) : ''}</div>
                </div>
            `;
            }).join('');
        }

        function selectSearchResult(area) {
            hideSearchResults();
            document.getElementById('search-input').value = area.name;
            
            const isLoaded = area.loaded !== false;
            
            // Fly to the area (if we have coordinates)
            let targetCenter = null;
            if (area.bbox && area.bbox.length === 4) {
                map.fitBounds([
                    [area.bbox[0], area.bbox[1]], 
                    [area.bbox[2], area.bbox[3]]  
                ], { padding: 50, duration: 1500 });
                targetCenter = [(area.bbox[0] + area.bbox[2]) / 2, (area.bbox[1] + area.bbox[3]) / 2];
            } else if (area.center && area.center.length === 2) {
                map.flyTo({
                    center: area.center,
                    zoom: 10,
                    duration: 1500
                });
                targetCenter = area.center;
            }
            
            // Show popup after flying (or immediately for unloaded PAs without coords)
            if (isLoaded && targetCenter) {
                setTimeout(() => showPAPopup(area, { lng: targetCenter[0], lat: targetCenter[1] }), 800);
            } else if (!isLoaded) {
                // Show "not loaded" popup for unloaded PAs
                showUnloadedPAPopup(area, targetCenter);
            }
        }
        
        function showUnloadedPAPopup(area, coords) {
            // Close existing popup
            if (currentPAPopup) {
                currentPAPopup.remove();
                currentPAPopup = null;
            }
            
            const popupContent = `
                <div style="padding: 12px; min-width: 200px;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #888;">${escapeHtml(area.name)}</div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 12px;">
                        ${escapeHtml(area.country || 'Unknown')}
                        ${area.designation ? '<br>' + escapeHtml(area.designation) : ''}
                        ${area.area_km2 ? '<br>' + area.area_km2.toLocaleString() + ' km²' : ''}
                    </div>
                    <div style="background: rgba(128,128,128,0.15); border-radius: 6px; padding: 10px; text-align: center;">
                        <div style="font-size: 12px; color: #888; margin-bottom: 4px;">△ PA not yet in system</div>
                        <div style="font-size: 11px; color: #666;">Coordinates unavailable</div>
                    </div>
                    ${area.wdpa_id ? '<div style="margin-top: 10px; font-size: 11px; color: #555;">WDPA ID: ' + area.wdpa_id + '</div>' : ''}
                </div>
            `;
            
            // If we have coordinates, show popup at that location
            if (coords) {
                currentPAPopup = new maplibregl.Popup({ closeOnClick: true, maxWidth: '300px' })
                    .setLngLat(coords)
                    .setHTML(popupContent)
                    .addTo(map);
            } else {
                // Show a toast notification instead
                showToast(`"${area.name}" is not yet loaded in the system. Coordinates unavailable.`, 'info');
            }
        }

        function showSearchResults() {
            const query = document.getElementById('search-input').value.trim();
            if (query.length >= 2) {
                document.getElementById('search-results').classList.add('open');
            }
        }

        function hideSearchResults() {
            document.getElementById('search-results').classList.remove('open');
        }

        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').style.display = 'none';
            hideSearchResults();
            document.getElementById('search-input').focus();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'info' ? 'rgba(59, 130, 246, 0.95)' : 'rgba(34, 197, 94, 0.95)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 9999;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: toastFadeIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('search-panel');
            const toolbarBtn = document.getElementById('toolbar-search');
            if (panel && !panel.contains(e.target) && !toolbarBtn.contains(e.target)) {
                hideSearchResults();
            }
        });

        // Park popup handler
        function showPAPopup(props, lngLat) {
            // Close existing popup
            if (currentPAPopup) {
                currentPAPopup.remove();
            }
            
            const name = props.name || 'Protected Area';
            const country = props.country || 'Unknown';
            const areaKm2 = props.area_km2 || props.area;
            const wdpaId = props.wdpa_id || props.wdpaid;
            const paId = wdpaId || props.id;
            const isSelected = selectedParks.some(p => p.id === (wdpaId || name));
            
            const areaDisplay = areaKm2 ? formatNumber(areaKm2) + ' km²' : '--';
            
            const popupContent = `
                <div class="pa-popup" style="min-width: 260px;">
                    <div class="pa-popup-header">
                        <div class="pa-popup-name">${escapeHtml(name)}</div>
                        <div class="pa-popup-country">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            ${escapeHtml(country)} ${areaKm2 ? `• ${areaDisplay}` : ''}
                        </div>
                    </div>
                    
                    <!-- Fire Section -->
                    <div class="pa-popup-section" id="fire-section-${paId}" onclick="togglePopupSection(this)">
                        <div class="pa-popup-section-header">
                            <div class="pa-popup-section-title"><span class="pa-popup-section-icon">◈</span> Fire Activity</div>
                            <span class="pa-popup-section-toggle">▼</span>
                        </div>
                        <div class="pa-popup-section-content" id="fire-content-${paId}">
                            <div class="pa-popup-section-loading">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Settlements Section -->
                    <div class="pa-popup-section" id="ghsl-section-${paId}" onclick="togglePopupSection(this)">
                        <div class="pa-popup-section-header">
                            <div class="pa-popup-section-title"><span class="pa-popup-section-icon">◻</span> Settlements</div>
                            <span class="pa-popup-section-toggle">▼</span>
                        </div>
                        <div class="pa-popup-section-content" id="ghsl-content-${paId}">
                            <div class="pa-popup-section-loading">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Deforestation Section -->
                    <div class="pa-popup-section" id="deforest-section-${paId}" onclick="togglePopupSection(this)">
                        <div class="pa-popup-section-header">
                            <div class="pa-popup-section-title"><span class="pa-popup-section-icon">▲</span> Deforestation</div>
                            <span class="pa-popup-section-toggle">▼</span>
                        </div>
                        <div class="pa-popup-section-content" id="deforest-content-${paId}">
                            <div class="pa-popup-section-loading">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Roadless Section -->
                    <div class="pa-popup-section" id="road-section-${paId}" onclick="togglePopupSection(this)">
                        <div class="pa-popup-section-header">
                            <div class="pa-popup-section-title"><span class="pa-popup-section-icon">═</span> Roads</div>
                            <span class="pa-popup-section-toggle">▼</span>
                        </div>
                        <div class="pa-popup-section-content" id="road-content-${paId}">
                            <div class="pa-popup-section-loading">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Research Section -->
                    <div class="pa-popup-section" id="research-section-${paId}" onclick="togglePopupSection(this)">
                        <div class="pa-popup-section-header">
                            <div class="pa-popup-section-title"><span class="pa-popup-section-icon">◉</span> Research</div>
                            <span class="pa-popup-section-toggle">▼</span>
                        </div>
                        <div class="pa-popup-section-content" id="research-content-${paId}">
                            <div class="pa-popup-section-loading">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- Legal Section -->
                    <div class="pa-popup-section" id="legal-section-${paId}" onclick="togglePopupSection(this)">
                        <div class="pa-popup-section-header">
                            <div class="pa-popup-section-title"><span class="pa-popup-section-icon">§</span> Legal</div>
                            <span class="pa-popup-section-toggle">▼</span>
                        </div>
                        <div class="pa-popup-section-content" id="legal-content-${paId}">
                            <div class="pa-popup-section-loading">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="pa-popup-actions">
                        <button class="pa-popup-btn${isSelected ? ' selected' : ''}" onclick="event.stopPropagation(); toggleParkSelection('${escapeHtml(wdpaId || name)}', '${escapeHtml(name)}', ${JSON.stringify(props.bbox || null).replace(/"/g, "'")}, ${JSON.stringify(props.center || (lngLat ? [lngLat.lng, lngLat.lat] : null)).replace(/"/g, "'")})">
                            <svg viewBox="0 0 24 24" fill="${isSelected ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                            ${isSelected ? 'Selected' : 'Select'}
                        </button>
                        ${wdpaId ? `<a class="pa-popup-btn" href="https://www.protectedplanet.net/${wdpaId}" target="_blank" rel="noopener" onclick="event.stopPropagation();">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            WDPA
                        </a>` : ''}
                    </div>
                </div>
            `;
            
            currentPAPopup = new maplibregl.Popup({ closeButton: true, maxWidth: '320px' })
                .setLngLat(lngLat)
                .setHTML(popupContent)
                .addTo(map);
            
            // Fetch all section data
            if (paId) {
                fetchPopupFireData(paId);
                fetchPopupGHSLData(paId);
                fetchPopupDeforestData(paId);
                fetchPopupRoadData(paId);
                fetchPopupResearchData(paId, name);
                fetchPopupLegalData(paId);
            }
        }
        
        // Toggle collapsible popup section
        function togglePopupSection(section) {
            // Prevent toggle if clicking on a link/button inside
            if (event.target.closest('a, button')) return;
            section.classList.toggle('open');
        }
        
        // Popup section data fetching functions
        async function fetchPopupFireData(paId) {
            const el = document.getElementById(`fire-content-${paId}`);
            if (!el) return;
            try {
                // Use time filter year, or extract from dateFrom, or default to most recent
                let year = dateTo ? new Date(dateTo).getFullYear() : new Date().getFullYear();
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/infractions?year=${year}`);
                const data = await resp.json();
                if (data.total_groups > 0) {
                    const rate = Math.round(data.response_rate || 0);
                    const rateClass = rate >= 60 ? '' : rate >= 40 ? ' warning' : ' bad';
                    el.innerHTML = `
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Fire groups (${year})</span>
                            <span class="pa-popup-mini-stat-value${data.total_groups > 10 ? ' bad' : ' warning'}">${data.total_groups}</span>
                        </div>
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Response rate</span>
                            <span class="pa-popup-mini-stat-value${rateClass}">${rate}%</span>
                        </div>
                        <div class="pa-popup-bar"><div class="pa-popup-bar-fill${rate >= 60 ? ' good' : rate >= 40 ? ' warning' : ' bad'}" style="width: ${rate}%;"></div></div>
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Avg days inside</span>
                            <span class="pa-popup-mini-stat-value">${data.avg_days_inside ? data.avg_days_inside.toFixed(1) : '--'}</span>
                        </div>
                    `;
                } else {
                    el.innerHTML = '<div class="pa-popup-section-empty">No fire activity recorded</div>';
                }
            } catch (e) {
                el.innerHTML = '<div class="pa-popup-section-empty">Data not available</div>';
            }
        }
        
        async function fetchPopupGHSLData(paId) {
            const el = document.getElementById(`ghsl-content-${paId}`);
            if (!el) return;
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/stats`);
                const data = await resp.json();
                if (data.settlement) {
                    const s = data.settlement;
                    el.innerHTML = `
                        <div style="font-size: 9px; color: #666; margin-bottom: 6px;">⏸ Static data (not time-filtered)</div>
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Built-up area</span>
                            <span class="pa-popup-mini-stat-value">${s.built_up_km2.toFixed(2)} km²</span>
                        </div>
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Settlement count</span>
                            <span class="pa-popup-mini-stat-value">${s.settlement_count || '--'}</span>
                        </div>
                        ${s.population_est ? `<div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Population est.</span>
                            <span class="pa-popup-mini-stat-value">${formatNumber(s.population_est)}</span>
                        </div>` : ''}
                    `;
                } else {
                    el.innerHTML = '<div class="pa-popup-section-empty">No settlement data</div>';
                }
            } catch (e) {
                el.innerHTML = '<div class="pa-popup-section-empty">Data not available</div>';
            }
        }
        
        async function fetchPopupDeforestData(paId) {
            const el = document.getElementById(`deforest-content-${paId}`);
            if (!el) return;
            try {
                let url = `/api/parks/${encodeURIComponent(paId)}/deforestation-narrative`;
                if (dateFrom || dateTo) {
                    const params = [];
                    if (dateFrom) params.push('from=' + dateFrom);
                    if (dateTo) params.push('to=' + dateTo);
                    url += '?' + params.join('&');
                }
                const resp = await fetch(url);
                const data = await resp.json();
                const totalLoss = data.total_loss_km2 || data.total_area_km2 || 0;
                const yearsCount = data.yearly_stories?.length || data.years_analyzed || 0;
                if (totalLoss > 0) {
                    el.innerHTML = `
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Total forest loss</span>
                            <span class="pa-popup-mini-stat-value">${totalLoss.toFixed(2)} km²</span>
                        </div>
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Years analyzed</span>
                            <span class="pa-popup-mini-stat-value">${yearsCount}</span>
                        </div>
                        ${data.worst_year ? `<div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Worst year</span>
                            <span class="pa-popup-mini-stat-value">${data.worst_year}</span>
                        </div>` : ''}
                        ${data.trend_direction ? `<div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Trend</span>
                            <span class="pa-popup-mini-stat-value ${data.trend_direction === 'improving' ? 'good' : data.trend_direction === 'worsening' ? 'bad' : ''}">${data.trend_direction}</span>
                        </div>` : ''}
                    `;
                } else {
                    el.innerHTML = '<div class="pa-popup-section-empty">No deforestation detected</div>';
                }
            } catch (e) {
                el.innerHTML = '<div class="pa-popup-section-empty">Data not available</div>';
            }
        }
        
        async function fetchPopupRoadData(paId) {
            const el = document.getElementById(`road-content-${paId}`);
            if (!el) return;
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/stats`);
                const data = await resp.json();
                if (data.roadless) {
                    const r = data.roadless;
                    const pct = r.roadless_percentage;
                    const pctClass = pct >= 80 ? ' good' : pct >= 50 ? ' warning' : ' bad';
                    el.innerHTML = `
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Roadless area</span>
                            <span class="pa-popup-mini-stat-value${pctClass}">${pct.toFixed(1)}%</span>
                        </div>
                        <div class="pa-popup-bar"><div class="pa-popup-bar-fill${pct >= 80 ? ' good' : pct >= 50 ? ' warning' : ' bad'}" style="width: ${pct}%;"></div></div>
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Road length</span>
                            <span class="pa-popup-mini-stat-value">${r.total_road_km.toFixed(1)} km</span>
                        </div>
                    `;
                } else {
                    el.innerHTML = '<div class="pa-popup-section-empty">Roadless data not yet processed</div>';
                }
            } catch (e) {
                el.innerHTML = '<div class="pa-popup-section-empty">Data not available</div>';
            }
        }
        
        async function fetchPopupResearchData(paId, paName) {
            const el = document.getElementById(`research-content-${paId}`);
            if (!el) return;
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/publications/count`);
                const data = await resp.json();
                if (data.count > 0) {
                    el.innerHTML = `
                        <div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Publications found</span>
                            <span class="pa-popup-mini-stat-value">${data.count}</span>
                        </div>
                        <button class="pa-popup-btn" style="margin-top: 8px; width: 100%;" onclick="event.stopPropagation(); showPublications('${paId}', '${escapeHtml(paName)}')">
                            ▶ View papers
                        </button>
                    `;
                } else {
                    el.innerHTML = '<div class="pa-popup-section-empty">No publications found yet</div>';
                }
            } catch (e) {
                el.innerHTML = '<div class="pa-popup-section-empty">Data not available</div>';
            }
        }
        
        async function fetchPopupLegalData(paId) {
            const el = document.getElementById(`legal-content-${paId}`);
            if (!el) return;
            try {
                const resp = await fetch(`/api/legal/pa/${encodeURIComponent(paId)}`);
                if (!resp.ok) throw new Error('Not found');
                const data = await resp.json();
                
                let html = '';
                
                // PA-specific legal info
                if (data.pa_specific) {
                    const pa = data.pa_specific;
                    html += `<div class="pa-popup-mini-stat">
                        <span class="pa-popup-mini-stat-label">Designation</span>
                        <span class="pa-popup-mini-stat-value">${escapeHtml(pa.legal_designation || '--')}</span>
                    </div>`;
                    if (pa.establishment_year) {
                        html += `<div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Established</span>
                            <span class="pa-popup-mini-stat-value">${pa.establishment_year}</span>
                        </div>`;
                    }
                    if (pa.governing_body) {
                        html += `<div class="pa-popup-mini-stat">
                            <span class="pa-popup-mini-stat-label">Governing body</span>
                            <span class="pa-popup-mini-stat-value">${escapeHtml(pa.governing_body)}</span>
                        </div>`;
                    }
                    if (pa.international_designations && pa.international_designations.length > 0) {
                        html += `<div style="margin-top: 6px; font-size: 10px; color: #888;">
                            <div style="color: #666; margin-bottom: 2px;">International:</div>
                            ${pa.international_designations.map(d => `<span style="display: inline-block; background: rgba(34,197,94,0.15); color: #22c55e; padding: 2px 6px; border-radius: 3px; margin: 2px 2px 0 0; font-size: 9px;">${escapeHtml(d)}</span>`).join('')}
                        </div>`;
                    }
                }
                
                // Country legislation
                if (data.country && data.country.legislation && data.country.legislation.length > 0) {
                    html += `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05);">
                        <div style="font-size: 9px; color: #666; margin-bottom: 4px;">${escapeHtml(data.country.name)} LEGISLATION</div>`;
                    for (const law of data.country.legislation.slice(0, 3)) {
                        html += `<div style="font-size: 10px; margin-bottom: 3px;">
                            ${law.url ? `<a href="${escapeHtml(law.url)}" target="_blank" rel="noopener" style="color: #a0a0a0; text-decoration: none;" onclick="event.stopPropagation();">${escapeHtml(law.name)} (${law.year}) \u2197</a>` : `${escapeHtml(law.name)} (${law.year})`}
                        </div>`;
                    }
                    html += '</div>';
                }
                
                if (html) {
                    el.innerHTML = html;
                } else {
                    el.innerHTML = '<div class="pa-popup-section-empty">No legal data available</div>';
                }
            } catch (e) {
                el.innerHTML = '<div class="pa-popup-section-empty">Legal data not available</div>';
            }
        }
        
        async function showParkStatsModal(paId, paName) {
            const container = document.getElementById('park-stats-content');
            
            // Show loading state
            container.innerHTML = `
                <div class="fire-stats-empty">
                    <div class="fire-stats-empty-icon">⏳</div>
                    <div class="fire-stats-empty-text">Loading stats...</div>
                </div>
            `;
            showModal('park-stats');
            
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/stats`);
                const data = await resp.json();
                
                let html = `
                    <div class="fire-stats-title">
                        <span>▣</span>
                        ${escapeHtml(paName)}
                    </div>
                    <div class="fire-stats-subtitle">Park Statistics</div>
                `;
                
                // Fire section
                if (data.fire && data.fire.groups_entered > 0) {
                    const fire = data.fire;
                    const responseRate = Math.round(fire.response_rate || 0);
                    const transitRate = fire.groups_entered > 0 ? Math.round((fire.groups_transited / fire.groups_entered) * 100) : 0;
                    const responseClass = responseRate >= 60 ? 'good' : responseRate >= 40 ? 'warning' : 'bad';
                    
                    html += `
                        <hr class="fire-stats-divider">
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">◆ FIRE ACTIVITY • ${fire.year || 2023}</div>
                        <div class="fire-stats-grid">
                            <div class="fire-stat-card">
                                <div class="fire-stat-label">Groups Entered</div>
                                <div class="fire-stat-value" style="color: ${fire.groups_entered > 10 ? '#ef4444' : '#f97316'};">${fire.groups_entered}</div>
                            </div>
                            <div class="fire-stat-card">
                                <div class="fire-stat-label">Response Rate</div>
                                <div class="fire-stat-value ${responseClass}">${responseRate}%</div>
                                <div class="fire-stat-bar">
                                    <div class="fire-stat-bar-fill ${responseClass}" style="width: ${responseRate}%;"></div>
                                </div>
                            </div>
                            <div class="fire-stat-card">
                                <div class="fire-stat-label">Avg Days Inside</div>
                                <div class="fire-stat-value">${fire.avg_days_inside ? fire.avg_days_inside.toFixed(1) : '0'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <hr class="fire-stats-divider">
                        <div style="font-size: 12px; color: #666;">◆ FIRE: No data available</div>
                    `;
                }
                
                // Settlement section
                if (data.settlement) {
                    const s = data.settlement;
                    html += `
                        <hr class="fire-stats-divider">
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">■ SETTLEMENTS</div>
                        <div class="fire-stats-grid">
                            <div class="fire-stat-card">
                                <div class="fire-stat-label">Built-up Area</div>
                                <div class="fire-stat-value">${s.built_up_km2.toFixed(2)} km²</div>
                            </div>
                            <div class="fire-stat-card">
                                <div class="fire-stat-label">Settlement Count</div>
                                <div class="fire-stat-value">${s.settlement_count}</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <hr class="fire-stats-divider">
                        <div style="font-size: 12px; color: #666;">■ SETTLEMENTS: No data available</div>
                    `;
                }
                
                // Roadless section
                if (data.roadless) {
                    const r = data.roadless;
                    const roadlessClass = r.roadless_percentage >= 80 ? 'good' : r.roadless_percentage >= 50 ? 'warning' : 'bad';
                    html += `
                        <hr class="fire-stats-divider">
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">○ ROADLESS AREAS</div>
                        <div class="fire-stats-grid">
                            <div class="fire-stat-card">
                                <div class="fire-stat-label">Roadless</div>
                                <div class="fire-stat-value ${roadlessClass}">${r.roadless_percentage.toFixed(1)}%</div>
                                <div class="fire-stat-bar">
                                    <div class="fire-stat-bar-fill ${roadlessClass}" style="width: ${r.roadless_percentage}%;"></div>
                                </div>
                            </div>
                            <div class="fire-stat-card">
                                <div class="fire-stat-label">Total Roads</div>
                                <div class="fire-stat-value">${r.total_road_km.toFixed(1)} km</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <hr class="fire-stats-divider">
                        <div style="font-size: 12px; color: #666;">○ ROADLESS: No data available</div>
                    `;
                }
                
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = `
                    <div class="fire-stats-empty">
                        <div class="fire-stats-empty-icon">△</div>
                        <div class="fire-stats-empty-text">Failed to load stats for ${escapeHtml(paName)}</div>
                    </div>
                `;
            }
        }
        
        async function fetchDataStatus(paId) {
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/data-status`);
                const data = await resp.json();
                const el = document.getElementById(`data-status-${paId}`);
                if (!el) return;
                
                const pending = [];
                if (!data.fire_analysis?.ready) pending.push('fire');
                if (!data.group_infractions?.ready) pending.push('groups');
                if (!data.ghsl?.ready) pending.push('population');
                if (!data.roadless?.ready) pending.push('roads');
                
                if (pending.length > 0 && pending.length < 4) {
                    el.innerHTML = `<span style="color: #666;">⏳ Processing: ${pending.join(', ')}</span>`;
                } else if (pending.length === 0) {
                    el.innerHTML = `<span style="color: #22c55e;">✓ All data ready</span>`;
                }
            } catch (e) {
                // Silently fail
            }
        }
        
        async function fetchPublicationCount(paId) {
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/publications/count`);
                const data = await resp.json();
                const el = document.getElementById(`pub-count-${paId}`);
                if (el) {
                    el.textContent = data.count > 0 ? `${data.count} papers` : '--';
                    if (data.count > 0) {
                        el.style.color = '#22c55e';
                    } else {
                        el.classList.add('muted');
                    }
                }
            } catch (e) {
                const el = document.getElementById(`pub-count-${paId}`);
                if (el) {
                    el.textContent = '--';
                    el.classList.add('muted');
                }
            }
        }
        
        async function showPublications(paId, paName) {
            try {
                const resp = await fetch(`/api/parks/${encodeURIComponent(paId)}/publications`);
                const pubs = await resp.json();
                
                if (!pubs || pubs.length === 0) {
                    showToast('No publications found for this area yet.', 'info');
                    return;
                }
                
                // Create modal with publications list
                let modal = document.getElementById('publications-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'publications-modal';
                    modal.className = 'modal-overlay';
                    modal.onclick = (e) => { if (e.target === modal) modal.classList.remove('active'); };
                    document.body.appendChild(modal);
                }
                
                const pubsHtml = pubs.slice(0, 10).map(p => `
                    <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-weight: 500; margin-bottom: 4px; color: #fff;">${escapeHtml(p.title)}</div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 4px;">
                            ${p.authors ? p.authors.slice(0, 3).join(', ') + (p.authors.length > 3 ? ' et al.' : '') : ''}
                            ${p.year ? ' (' + p.year + ')' : ''}
                        </div>
                        ${p.cited_by_count ? `<div style="font-size: 11px; color: #666;">Cited by ${p.cited_by_count}</div>` : ''}
                        ${p.url ? `<a href="${p.url}" target="_blank" rel="noopener" style="font-size: 12px; color: #22c55e;">View paper →</a>` : ''}
                    </div>
                `).join('');
                
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2 class="modal-title">Research on ${escapeHtml(paName)}</h2>
                            <button class="modal-close" onclick="document.getElementById('publications-modal').classList.remove('active')">×</button>
                        </div>
                        <div style="font-size: 13px; color: #888; margin-bottom: 16px;">Found ${pubs.length} publication${pubs.length !== 1 ? 's' : ''}</div>
                        <div>${pubsHtml}</div>
                    </div>
                `;
                
                modal.classList.add('active');
            } catch (e) {
                showToast('Failed to load publications.', 'info');
            }
        }
        
        function toggleParkSelection(id, name, bbox, center) {
            const index = selectedParks.findIndex(p => p.id === id);
            if (index >= 0) {
                selectedParks.splice(index, 1);
                selectedPAIds.delete(id);
            } else {
                selectedParks.push({ id, name, bbox, center });
                selectedPAIds.add(id);
            }
            updatePAHighlighting();
            updateSelectedParksDisplay();
            // Close and reopen popup to update button state
            if (currentPAPopup) {
                currentPAPopup.remove();
            }
        }
        
        function removeSelectedPark(id) {
            selectedParks = selectedParks.filter(p => p.id !== id);
            selectedPAIds.delete(id);
            updatePAHighlighting();
            updateSelectedParksDisplay();
        }
        
        function flyToSelectedPark(id) {
            const park = selectedParks.find(p => p.id === id);
            if (park) {
                if (park.bbox && park.bbox.length === 4) {
                    map.fitBounds([[park.bbox[0], park.bbox[1]], [park.bbox[2], park.bbox[3]]], { padding: 50, duration: 1500 });
                } else if (park.center && park.center.length === 2) {
                    map.flyTo({ center: park.center, zoom: 10, duration: 1500 });
                }
            }
        }
        
        function updateSelectedParksDisplay() {
            const container = document.getElementById('selected-parks');
            const emptyMsg = document.getElementById('selected-parks-empty');
            
            if (selectedParks.length === 0) {
                if (emptyMsg) emptyMsg.style.display = 'block';
                // Remove park items but keep empty message
                const items = container.querySelectorAll('.selected-park-item');
                items.forEach(item => item.remove());
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            
            // Remove existing items
            const items = container.querySelectorAll('.selected-park-item');
            items.forEach(item => item.remove());
            
            // Add park items
            selectedParks.forEach(park => {
                const item = document.createElement('div');
                item.className = 'selected-park-item';
                item.innerHTML = `
                    <svg class="selected-park-icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span class="selected-park-name" onclick="flyToSelectedPark('${park.id}')">${escapeHtml(park.name)}</span>
                    <button class="selected-park-remove" onclick="removeSelectedPark('${park.id}')" title="Remove">×</button>
                `;
                container.appendChild(item);
            });
        }
        
        // Update time filter display when slider changes
        function updateTimeFilterDisplay(startDate, endDate) {
            const filterTimeValue = document.getElementById('filter-time-value');
            if (filterTimeValue) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const start = new Date(startDate);
                const end = new Date(endDate);
                filterTimeValue.textContent = months[start.getMonth()] + ' ' + start.getFullYear() + ' - ' + months[end.getMonth()] + ' ' + end.getFullYear();
            }
        }

        // Set up PA click handler (enhanced popup with collapsible sections)
        // Cross-browser compatible: uses only general click + queryRenderedFeatures
        // Works reliably in Safari 18.6, Firefox 146, DuckDuckGo Android, and all major browsers
        function setupPAClickHandler() {
            // Helper to handle PA feature interaction at a point
            function handlePAInteraction(point, lngLat) {
                // Skip if in bbox draw mode
                if (document.getElementById('bbox-draw-overlay')?.classList.contains('active')) {
                    return false;
                }
                
                // Check if areas-fill layer exists
                if (!map.getLayer('areas-fill')) {
                    return false;
                }
                
                // Query for PA features at the interaction point
                const paFeatures = map.queryRenderedFeatures(point, { layers: ['areas-fill'] });
                if (paFeatures.length > 0) {
                    console.log('PA click handler - found PA:', paFeatures[0].properties?.name);
                    const props = paFeatures[0].properties;
                    showPAPopup(props, lngLat);
                    return true;
                }
                return false;
            }
            
            // Single unified click handler using queryRenderedFeatures
            // This is more reliable than layer-specific handlers across browsers
            map.on('click', function(e) {
                handlePAInteraction(e.point, e.lngLat);
            });
            
            // Add touch handler for mobile browsers (DuckDuckGo Android, Safari iOS)
            // Some mobile browsers need explicit touch handling
            const canvas = map.getCanvas();
            let touchStartTime = 0;
            let touchStartPoint = null;
            
            canvas.addEventListener('touchstart', function(e) {
                if (e.touches.length === 1) {
                    touchStartTime = Date.now();
                    touchStartPoint = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
            }, { passive: true });
            
            canvas.addEventListener('touchend', function(e) {
                // Only process single-touch taps (not gestures or zooms)
                if (!touchStartPoint) return;
                
                const touchDuration = Date.now() - touchStartTime;
                const changedTouch = e.changedTouches[0];
                const touchEndPoint = { x: changedTouch.clientX, y: changedTouch.clientY };
                
                // Check if this was a quick tap without much movement (not a drag)
                const moveDistance = Math.sqrt(
                    Math.pow(touchEndPoint.x - touchStartPoint.x, 2) + 
                    Math.pow(touchEndPoint.y - touchStartPoint.y, 2)
                );
                
                // Quick tap (< 300ms) with minimal movement (< 10px)
                if (touchDuration < 300 && moveDistance < 10) {
                    // Convert touch to map coordinates
                    const rect = canvas.getBoundingClientRect();
                    const point = {
                        x: touchEndPoint.x - rect.left,
                        y: touchEndPoint.y - rect.top
                    };
                    const lngLat = map.unproject(point);
                    
                    // Use setTimeout to let the map's click handler fire first
                    // If it doesn't work, this will be the backup
                    setTimeout(function() {
                        // Only process if no popup was shown by the regular click handler
                        if (!currentPAPopup) {
                            console.log('Touch fallback handler triggered');
                            handlePAInteraction(point, lngLat);
                        }
                    }, 50);
                }
                
                touchStartPoint = null;
            }, { passive: true });
            
            // Change cursor on hover over PA features
            map.on('mouseenter', 'areas-fill', function() {
                canvas.style.cursor = 'pointer';
            });
            map.on('mouseleave', 'areas-fill', function() {
                canvas.style.cursor = '';
            });
            
            console.log('PA click handler initialized (cross-browser compatible)');
        }
        
        console.log('DEBUG: Code reached initPAClickHandler definition');
        
        // Set up the handler when map is ready
        // Check if map is loaded AND the areas-fill layer exists
        function initPAClickHandler() {
            if (map.getLayer('areas-fill')) {
                setupPAClickHandler();
            } else {
                // Wait for the layer to be added
                map.on('sourcedata', function onSourceData(e) {
                    if (e.sourceId === 'areas' && map.getLayer('areas-fill')) {
                        map.off('sourcedata', onSourceData);
                        setupPAClickHandler();
                    }
                });
            }
        }
        // Fallback: Also run init after a delay in case the map.on('load') call didn't work
        // This is a safety net - the primary init is in map.on('load') above
        var paClickHandlerInitialized = false;
        setTimeout(function() {
            if (!paClickHandlerInitialized) {
                console.log('PA handler fallback init - map.loaded:', map.loaded(), 'layer exists:', !!map.getLayer('areas-fill'));
                initPAClickHandler();
                paClickHandlerInitialized = true;
            }
        }, 1000);

        // Stats panel interactivity
        let activeStatMode = null;
        let originalCirclePaint = null;

        function handleStatClick(statType) {
            const statItems = document.querySelectorAll('.stats-item');
            const clickedItem = document.getElementById('stat-' + statType);
            
            // Add pulse animation
            clickedItem.classList.add('pulsing');
            setTimeout(() => clickedItem.classList.remove('pulsing'), 600);
            
            // Toggle mode - if clicking the same stat, deactivate
            if (activeStatMode === statType) {
                deactivateStatMode();
                return;
            }
            
            // Deactivate previous mode first
            if (activeStatMode) {
                deactivateStatMode(false);
            }
            
            // Activate new mode
            activeStatMode = statType;
            statItems.forEach(item => item.classList.remove('active'));
            clickedItem.classList.add('active');
            
            // Execute stat-specific action
            switch(statType) {
                case 'pixels':
                    highlightActivePixels();
                    break;
                case 'distance':
                    showDistanceHeatmap();
                    break;
                case 'patrols':
                    zoomToPatrolCoverage();
                    break;
            }
        }

        function deactivateStatMode(resetView = true) {
            activeStatMode = null;
            document.querySelectorAll('.stats-item').forEach(item => item.classList.remove('active'));
            
            // Reset circles to original style
            resetHeatmapStyle();
            
            // Remove any highlight layers
            removeHighlightLayers();
        }

        function highlightActivePixels() {
            // Make grid cells more visible with a pulsing effect
            if (!map.getLayer('grid-cells')) return;
            
            // Store original paint if not already stored
            if (!originalCirclePaint) {
                originalCirclePaint = {
                    'circle-stroke-width': map.getPaintProperty('grid-cells', 'circle-stroke-width'),
                    'circle-stroke-color': map.getPaintProperty('grid-cells', 'circle-stroke-color')
                };
            }
            
            // Enhance visibility with white stroke for better contrast
            map.setPaintProperty('grid-cells', 'circle-stroke-color', '#ffffff');
            map.setPaintProperty('grid-cells', 'circle-stroke-width', 2.5);
            
            // Also enhance clusters
            if (map.getLayer('grid-clusters')) {
                map.setPaintProperty('grid-clusters', 'circle-stroke-color', '#ffffff');
                map.setPaintProperty('grid-clusters', 'circle-stroke-width', 3);
            }
            
            // Animate the circles with a pulsing effect
            animatePixelHighlight();
        }

        let pixelAnimationFrame = null;
        function animatePixelHighlight() {
            if (activeStatMode !== 'pixels') return;
            
            let glowOpacity = 0.4;
            let direction = -1;
            
            function pulse() {
                if (activeStatMode !== 'pixels' || !map.getLayer('grid-glow')) {
                    return;
                }
                
                glowOpacity += direction * 0.015;
                if (glowOpacity <= 0.2) direction = 1;
                if (glowOpacity >= 0.5) direction = -1;
                
                // Pulse the glow layer
                if (map.getLayer('grid-glow')) {
                    map.setPaintProperty('grid-glow', 'circle-opacity', glowOpacity);
                }
                if (map.getLayer('grid-clusters')) {
                    map.setPaintProperty('grid-clusters', 'circle-opacity', 0.5 + glowOpacity);
                }
                pixelAnimationFrame = requestAnimationFrame(pulse);
            }
            pulse();
        }

        function showDistanceHeatmap() {
            // Enhance circles to show patrol intensity with warmer colors
            if (!map.getLayer('grid-cells')) return;
            
            // Store original paint if not already stored
            if (!originalCirclePaint) {
                originalCirclePaint = {
                    'circle-opacity': map.getPaintProperty('grid-cells', 'circle-opacity'),
                    'circle-stroke-width': map.getPaintProperty('grid-cells', 'circle-stroke-width'),
                    'circle-stroke-color': map.getPaintProperty('grid-cells', 'circle-stroke-color'),
                    'circle-color': map.getPaintProperty('grid-cells', 'circle-color')
                };
            }
            
            // Use a warmer color scheme (green -> yellow -> orange -> red) for intensity
            map.setPaintProperty('grid-cells', 'circle-color', [
                'interpolate', ['linear'],
                ['coalesce', ['get', 'intensity'], 0.5],
                0, 'rgba(34, 197, 94, 0.5)',
                0.3, 'rgba(74, 222, 128, 0.7)',
                0.5, 'rgba(250, 204, 21, 0.8)',
                0.7, 'rgba(249, 115, 22, 0.9)',
                1, 'rgba(239, 68, 68, 1)'
            ]);
            
            // Enhance glow effect
            map.setPaintProperty('grid-cells', 'circle-blur', 0.3);
            map.setPaintProperty('grid-cells', 'circle-opacity', 1);
            map.setPaintProperty('grid-cells', 'circle-stroke-color', '#ffffff');
            map.setPaintProperty('grid-cells', 'circle-stroke-width', 2);
            
            // Also update clusters
            if (map.getLayer('grid-clusters')) {
                map.setPaintProperty('grid-clusters', 'circle-color', '#f97316');
                map.setPaintProperty('grid-clusters', 'circle-stroke-color', '#ffffff');
            }
        }

        async function zoomToPatrolCoverage() {
            // Zoom map to fit all patrol data
            try {
                const source = map.getSource('grid');
                if (!source) return;
                
                // Build URL with current filters
                let url = '/api/grid';
                const params = [];
                if (dateFrom) params.push('from=' + dateFrom);
                if (dateTo) params.push('to=' + dateTo);
                if (currentBbox) params.push('bbox=' + currentBbox.join(','));
                if (params.length > 0) url += '?' + params.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.features && data.features.length > 0) {
                    // Calculate bounds from all features
                    let minLng = Infinity, minLat = Infinity;
                    let maxLng = -Infinity, maxLat = -Infinity;
                    
                    data.features.forEach(feature => {
                        const coords = feature.geometry.coordinates;
                        if (coords) {
                            minLng = Math.min(minLng, coords[0]);
                            maxLng = Math.max(maxLng, coords[0]);
                            minLat = Math.min(minLat, coords[1]);
                            maxLat = Math.max(maxLat, coords[1]);
                        }
                    });
                    
                    if (minLng !== Infinity) {
                        // Add some padding
                        const lngPad = (maxLng - minLng) * 0.1 || 1;
                        const latPad = (maxLat - minLat) * 0.1 || 1;
                        
                        map.fitBounds([
                            [minLng - lngPad, minLat - latPad],
                            [maxLng + lngPad, maxLat + latPad]
                        ], {
                            padding: 50,
                            duration: 1500,
                            essential: true
                        });
                    }
                }
            } catch (err) {
                console.error('Failed to zoom to patrol coverage:', err);
            }
        }

        function resetHeatmapStyle() {
            if (!map.getLayer('grid-cells')) return;
            
            // Restore original grid-cells style
            if (originalCirclePaint) {
                Object.keys(originalCirclePaint).forEach(prop => {
                    if (originalCirclePaint[prop] !== undefined) {
                        map.setPaintProperty('grid-cells', prop, originalCirclePaint[prop]);
                    }
                });
            } else {
                // Default values
                map.setPaintProperty('grid-cells', 'circle-stroke-color', '#4ade80');
                map.setPaintProperty('grid-cells', 'circle-stroke-width', 1.5);
            }
            
            // Reset glow layer
            if (map.getLayer('grid-glow')) {
                map.setPaintProperty('grid-glow', 'circle-opacity', [
                    'interpolate', ['linear'],
                    ['coalesce', ['get', 'intensity'], 0.3],
                    0, 0.15,
                    0.5, 0.25,
                    1, 0.4
                ]);
            }
            
            // Also reset clusters to original style
            if (map.getLayer('grid-clusters')) {
                map.setPaintProperty('grid-clusters', 'circle-color', '#22c55e');
                map.setPaintProperty('grid-clusters', 'circle-stroke-color', '#4ade80');
                map.setPaintProperty('grid-clusters', 'circle-stroke-width', 2);
                map.setPaintProperty('grid-clusters', 'circle-opacity', 0.7);
            }
        }

        function removeHighlightLayers() {
            // Stop animation
            if (pixelAnimationFrame) {
                cancelAnimationFrame(pixelAnimationFrame);
                pixelAnimationFrame = null;
            }
            
            // Remove highlight layer
            try {
                if (map.getLayer('grid-points-highlight')) {
                    map.removeLayer('grid-points-highlight');
                }
            } catch (e) {}
        }

        // Reset stat mode when clicking on the map (outside stats panel)
        map.on('click', function(e) {
            // Don't reset if clicking on a feature
            const features = map.queryRenderedFeatures(e.point, {
                layers: ['areas-fill', 'grid-cells', 'grid-clusters']
            });
            if (features.length === 0 && activeStatMode) {
                // Small delay to let other click handlers run first
                setTimeout(() => {
                    if (activeStatMode) deactivateStatMode();
                }, 100);
            }
        });
    </script>

    <!-- Time Slider JavaScript -->
    <script>
    (function() {
        // Time slider configuration
        const SLIDER_START_DATE = new Date('2020-01-01');
        const SLIDER_END_DATE = new Date(); // Today
        const TOTAL_MONTHS = monthsBetween(SLIDER_START_DATE, SLIDER_END_DATE);
        
        // Default: Jan 2023 to today (36 months from Jan 2020 = Jan 2023)
        let sliderStartValue = 36; // Jan 2023
        let sliderEndValue = TOTAL_MONTHS; // Today
        
        function monthsBetween(d1, d2) {
            return (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
        }
        
        function addMonths(date, months) {
            const result = new Date(date);
            result.setMonth(result.getMonth() + months);
            return result;
        }
        
        function formatMonthYear(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getFullYear();
        }
        
        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }
        
        function valueToDate(value) {
            return addMonths(SLIDER_START_DATE, value);
        }
        
        function updateSliderDisplay() {
            const startDate = valueToDate(sliderStartValue);
            const endDate = valueToDate(sliderEndValue);
            
            // Update date label
            document.getElementById('time-slider-date').textContent = 
                formatMonthYear(startDate) + ' - ' + formatMonthYear(endDate);
            
            // Update handle positions
            const track = document.getElementById('time-slider-track');
            const trackWidth = track.offsetWidth;
            const startPercent = (sliderStartValue / TOTAL_MONTHS) * 100;
            const endPercent = (sliderEndValue / TOTAL_MONTHS) * 100;
            
            document.getElementById('time-slider-start').style.left = startPercent + '%';
            document.getElementById('time-slider-end').style.left = endPercent + '%';
            document.getElementById('time-slider-range').style.left = startPercent + '%';
            document.getElementById('time-slider-range').style.width = (endPercent - startPercent) + '%';
        }
        
        function updateDateFilter() {
            const startDate = valueToDate(sliderStartValue);
            const endDate = valueToDate(sliderEndValue);
            
            // Update global date variables (used by existing code)
            dateFrom = formatDateISO(startDate);
            dateTo = formatDateISO(endDate);
            currentPreset = 'custom';
            
            // Update filter panel display
            if (typeof updateTimeFilterDisplay === 'function') {
                updateTimeFilterDisplay(dateFrom, dateTo);
            }
            
            // Reload data
            reloadGridData();
        }
        
        function initTicks() {
            const ticksContainer = document.getElementById('time-slider-ticks');
            ticksContainer.innerHTML = '';
            
            // Add tick for each year
            let currentDate = new Date(SLIDER_START_DATE);
            while (currentDate <= SLIDER_END_DATE) {
                const monthsFromStart = monthsBetween(SLIDER_START_DATE, currentDate);
                const percent = (monthsFromStart / TOTAL_MONTHS) * 100;
                const isJanuary = currentDate.getMonth() === 0;
                
                if (isJanuary || monthsFromStart === 0) {
                    // Year tick
                    const tick = document.createElement('div');
                    tick.className = 'time-slider-tick major';
                    tick.style.left = percent + '%';
                    tick.innerHTML = `<div class="time-slider-tick-line"></div><div class="time-slider-tick-label">${currentDate.getFullYear()}</div>`;
                    ticksContainer.appendChild(tick);
                } else if (currentDate.getMonth() === 6) {
                    // Mid-year tick (July)
                    const tick = document.createElement('div');
                    tick.className = 'time-slider-tick';
                    tick.style.left = percent + '%';
                    tick.innerHTML = `<div class="time-slider-tick-line"></div>`;
                    ticksContainer.appendChild(tick);
                }
                
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }
        
        function initSliderDrag() {
            const track = document.getElementById('time-slider-track');
            const startHandle = document.getElementById('time-slider-start');
            const endHandle = document.getElementById('time-slider-end');
            
            let activeHandle = null;
            
            function getValueFromEvent(e) {
                const rect = track.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const percent = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
                return Math.round(percent * TOTAL_MONTHS);
            }
            
            function onStart(e, handle) {
                e.preventDefault();
                activeHandle = handle;
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove);
                document.addEventListener('touchend', onEnd);
            }
            
            function onMove(e) {
                if (!activeHandle) return;
                e.preventDefault();
                
                const value = getValueFromEvent(e);
                
                if (activeHandle === 'start') {
                    sliderStartValue = Math.min(value, sliderEndValue - 1);
                } else {
                    sliderEndValue = Math.max(value, sliderStartValue + 1);
                }
                
                updateSliderDisplay();
            }
            
            function onEnd() {
                if (activeHandle) {
                    updateDateFilter();
                }
                activeHandle = null;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onEnd);
            }
            
            startHandle.addEventListener('mousedown', (e) => onStart(e, 'start'));
            startHandle.addEventListener('touchstart', (e) => onStart(e, 'start'));
            endHandle.addEventListener('mousedown', (e) => onStart(e, 'end'));
            endHandle.addEventListener('touchstart', (e) => onStart(e, 'end'));
            
            // Click on track to move nearest handle
            track.addEventListener('click', (e) => {
                if (e.target.classList.contains('time-slider-handle')) return;
                
                const value = getValueFromEvent(e);
                const startDist = Math.abs(value - sliderStartValue);
                const endDist = Math.abs(value - sliderEndValue);
                
                if (startDist < endDist) {
                    sliderStartValue = Math.min(value, sliderEndValue - 1);
                } else {
                    sliderEndValue = Math.max(value, sliderStartValue + 1);
                }
                
                updateSliderDisplay();
                updateDateFilter();
            });
        }
        
        // Initialize slider
        function initTimeSlider() {
            initTicks();
            initSliderDrag();
            updateSliderDisplay();
            // Set initial date filter to match slider
            updateDateFilter();
        }
        
        // Expose function to set time slider range programmatically (for upload highlight)
        window.setTimeSliderRange = function(startDate, endDate) {
            // Convert dates to slider values (months from SLIDER_START_DATE)
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Clamp to valid range
            let newStart = monthsBetween(SLIDER_START_DATE, start);
            let newEnd = monthsBetween(SLIDER_START_DATE, end);
            
            // Ensure values are within bounds
            newStart = Math.max(0, Math.min(newStart, TOTAL_MONTHS - 1));
            newEnd = Math.max(newStart + 1, Math.min(newEnd + 1, TOTAL_MONTHS)); // +1 to include end month
            
            sliderStartValue = newStart;
            sliderEndValue = newEnd;
            
            updateSliderDisplay();
            updateDateFilter();
        };
        
        // Wait for DOM and map to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTimeSlider);
        } else {
            // Small delay to ensure map is loaded
            setTimeout(initTimeSlider, 100);
        }
    })();
    </script>

 
    <script>
    (function() {
        var key = '5mp_views';
        var views = parseInt(localStorage.getItem(key) || '0', 10) + 1;
        localStorage.setItem(key, views);
        var el = document.getElementById('page-views-footer');
        if (el) el.textContent = (views >= 1000 ? views.toLocaleString() : views) + ' views';
    })();
    
    // Share current view - creates URL with state parameters
    function shareCurrentView() {
        const params = new URLSearchParams();
        
        // Add password if present
        const pwd = new URLSearchParams(window.location.search).get('pwd');
        if (pwd) params.set('pwd', pwd);
        
        // Add map center and zoom
        if (typeof map !== 'undefined') {
            const center = map.getCenter();
            params.set('lat', center.lat.toFixed(4));
            params.set('lng', center.lng.toFixed(4));
            params.set('z', map.getZoom().toFixed(1));
        }
        
        // Add time range
        if (dateFrom) params.set('from', dateFrom);
        if (dateTo) params.set('to', dateTo);
        
        // Add selected PA if any
        if (typeof selectedPAId !== 'undefined' && selectedPAId) {
            params.set('pa', selectedPAId);
        }
        
        // Add country filter if not "all"
        const countrySelect = document.getElementById('country-filter');
        if (countrySelect && countrySelect.value && countrySelect.value !== '') {
            params.set('country', countrySelect.value);
        }
        
        // Add movement type filters
        const activeTypes = [];
        document.querySelectorAll('.movement-toggle.active').forEach(el => {
            activeTypes.push(el.textContent.trim().toLowerCase());
        });
        if (activeTypes.length > 0 && activeTypes.length < 3) {
            params.set('types', activeTypes.join(','));
        }
        
        const url = window.location.origin + window.location.pathname + '?' + params.toString();
        
        // Copy to clipboard
        navigator.clipboard.writeText(url).then(() => {
            showToast('Link copied to clipboard!');
        }).catch(() => {
            // Fallback for older browsers
            prompt('Copy this link:', url);
        });
    }
    
    // Restore state from URL parameters on load
    function restoreStateFromURL() {
        const params = new URLSearchParams(window.location.search);
        
        // Restore map position
        const lat = parseFloat(params.get('lat'));
        const lng = parseFloat(params.get('lng'));
        const zoom = parseFloat(params.get('z'));
        if (!isNaN(lat) && !isNaN(lng) && typeof map !== 'undefined') {
            map.setCenter([lng, lat]);
            if (!isNaN(zoom)) map.setZoom(zoom);
        }
        
        // Restore time range
        const from = params.get('from');
        const to = params.get('to');
        if (from && to && typeof setTimeSliderRange === 'function') {
            setTimeSliderRange(from, to);
        }
        
        // Restore country filter
        const country = params.get('country');
        if (country) {
            const countrySelect = document.getElementById('country-filter');
            if (countrySelect) {
                countrySelect.value = country;
                countrySelect.dispatchEvent(new Event('change'));
            }
        }
        
        // Restore PA selection
        const paId = params.get('pa');
        if (paId && typeof selectSearchResult === 'function') {
            setTimeout(() => selectSearchResult({id: paId, loaded: true}), 1000);
        }
        
        // Restore movement types
        const types = params.get('types');
        if (types) {
            const activeTypes = types.split(',');
            document.querySelectorAll('.movement-toggle').forEach(el => {
                const type = el.textContent.trim().toLowerCase();
                if (activeTypes.includes(type)) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });
        }
    }
    
    // Initialize state restoration when map is ready
    if (typeof map !== 'undefined') {
        map.on('load', restoreStateFromURL);
    } else {
        setTimeout(restoreStateFromURL, 2000);
    }
    </script>
</body></html>
